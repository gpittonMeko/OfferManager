<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MekoCRM - ME.KO. Srl</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            @keyframes pulse-ring {
                0% {
                    transform: scale(0.8);
                    opacity: 1;
                }
                50% {
                    transform: scale(1.2);
                    opacity: 0.3;
                }
                100% {
                    transform: scale(1.5);
                    opacity: 0;
                }
            }
            
            .spinner {
                display: inline-block;
                width: 40px;
                height: 40px;
                border: 4px solid var(--border-color);
                border-top-color: var(--primary);
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            
            .pulse-marker {
                animation: pulse-marker 2s infinite;
            }
            
            @keyframes pulse-marker {
                0%, 100% {
                    transform: scale(1);
                }
                50% {
                    transform: scale(1.1);
                }
            }
            
            /* Stile popup mappa con sfondo bianco */
            .leaflet-popup-content-wrapper {
                background: white !important;
                border-radius: 8px !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            }
            
            .leaflet-popup-content {
                margin: 0 !important;
                background: white !important;
            }
            
            .leaflet-popup-tip {
                background: white !important;
            }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #eff6ff;
            --secondary: #f97316;
            --secondary-light: #fff7ed;
            --text-dark: #0f172a;
            --text-medium: #1e293b;
            --text-light: #475569;
            --bg-light: #f1f5f9;
            --bg-white: #ffffff;
            --border-color: #e2e8f0;
            --border-light: #f1f5f9;
            --success: #10b981;
            --success-light: #d1fae5;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.4;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: var(--text-dark);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            width: 100%;
            max-width: 100vw;
        }
        
        * {
            max-width: 100%;
        }
        
        img, video, iframe {
            max-width: 100%;
            height: auto;
        }
        
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            border-right: 1px solid var(--border-color);
            padding: 28px 20px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: var(--shadow-md);
            animation: slideIn 0.3s ease-out;
        }
        
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--text-light);
        }
        
        .notifications-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }
        
        .notification-bell {
            position: relative;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .notification-bell:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }
        
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
        }
        
        .notifications-dropdown {
            position: absolute;
            top: 60px;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: 500px;
            max-width: 500px;
            max-height: 600px;
            overflow-y: auto;
            display: none;
        }
        
        .notifications-dropdown.show {
            display: block;
        }
        
        .notifications-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notifications-header h4 {
            margin: 0;
            font-size: 16px;
        }
        
        .notification-item {
            padding: 14px 18px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
            min-height: 60px;
        }
        
        .notification-item:hover {
            background: var(--bg-light);
        }
        
        .notification-item.unread {
            background: var(--primary-light);
            border-left: 4px solid var(--primary);
        }
        
        .notification-item-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-dark);
            font-size: 14px;
            line-height: 1.4;
        }
        
        .notification-item-message {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 6px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        
        .notification-item-time {
            font-size: 11px;
            line-height: 1.4;
            color: var(--text-light);
        }
        
        .logo {
            padding-bottom: 24px;
            border-bottom: 2px solid var(--border-light);
            margin-bottom: 24px;
        }
        
        .logo h1 {
            font-size: 28px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 6px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }
        
        .logo p {
            font-size: 13px;
            color: var(--text-light);
            font-weight: 500;
        }
        
        .nav-menu {
            margin-top: 32px;
        }
        
        .nav-item {
            padding: 14px 18px;
            margin-bottom: 6px;
            border-radius: 10px;
            cursor: pointer;
            color: var(--text-dark);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .nav-item:hover {
            background: linear-gradient(90deg, var(--primary-light) 0%, transparent 100%);
            color: var(--primary);
            transform: translateX(4px);
        }
        
        .nav-item:hover::before {
            transform: scaleY(1);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }
        
        .nav-item.active::before {
            transform: scaleY(1);
            background: white;
        }
        
        .content {
            margin-left: 280px;
            padding: 40px;
            min-height: 100vh;
            animation: fadeIn 0.5s ease-out;
            width: calc(100% - 280px);
            box-sizing: border-box;
        }
        
        .hero {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px 0;
            border-bottom: 2px solid var(--border-light);
        }
        
        .hero h2 {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
        }
        
        .hero p {
            color: var(--text-light);
            font-size: 15px;
        }
        
        .hero-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .button {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }
        
        .button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .button:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .button:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .button:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }
        
        .button.secondary {
            background: var(--bg-white);
            color: var(--text-dark);
            border: 2px solid var(--border-color);
            box-shadow: none;
        }
        
        .button.secondary:hover {
            background: var(--bg-light);
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .card {
            background: var(--bg-white);
            border-radius: 12px;
            padding: 16px;
            box-shadow: var(--shadow-md);
            margin-bottom: 16px;
            border: 1px solid var(--border-light);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeIn 0.4s ease-out;
        }
        
        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            background: var(--bg-white);
            position: relative;
            width: 100%;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        @media (min-width: 769px) {
            table {
                min-width: 800px;
            }
        }
        
        /* Hamburger Menu per Mobile */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            width: 48px;
            height: 48px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            align-items: center;
            justify-content: center;
        }
        
        .mobile-menu-toggle:active {
            transform: scale(0.95);
        }
        
        @media (max-width: 1200px) {
            table {
                font-size: 13px;
            }
            th, td {
                padding: 6px 8px !important;
                font-size: 12px !important;
            }
            
            th {
                font-size: 11px !important;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
        }
        
        /* Tablet */
        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
                padding: 20px 16px;
            }
            
            .content {
                margin-left: 240px;
                padding: 30px 24px;
            }
            
            .hero h2 {
                font-size: 24px;
            }
            
            .card {
                padding: 20px;
            }
            
            .dashboard-metrics {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }
            
            .notifications-dropdown {
                width: 450px;
                max-width: 450px;
            }
        }
        
        /* Mobile */
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: flex;
            }
            
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                width: 280px;
                z-index: 1000;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .content {
                margin-left: 0;
                padding: 80px 16px 24px;
                width: 100%;
                max-width: 100%;
            }
            
            .hero {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
                padding: 16px 0;
            }
            
            .hero h2 {
                font-size: 22px;
                word-wrap: break-word;
            }
            
            .hero p {
                font-size: 14px;
            }
            
            .hero-actions {
                width: 100%;
            }
            
            .hero-actions .button {
                flex: 1;
                min-width: 0;
            }
            
            .dashboard-metrics {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .card {
                padding: 16px;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .notifications-container {
                top: 80px;
                right: 16px;
                left: auto;
            }
            
            .notifications-dropdown {
                width: calc(100vw - 32px);
                max-width: 400px;
            }
            
            .notification-item {
                padding: 16px 18px !important;
                min-height: 70px !important;
            }
            
            .notification-item-title {
                font-size: 15px !important;
                margin-bottom: 8px !important;
                line-height: 1.5 !important;
            }
            
            .notification-item-message {
                font-size: 14px !important;
                margin-bottom: 8px !important;
                line-height: 1.6 !important;
            }
            
            .notification-item-time {
                font-size: 12px !important;
                line-height: 1.5 !important;
            }
            
            .notifications-dropdown {
                width: calc(100vw - 32px);
                max-width: 400px;
                right: 0;
                left: auto;
            }
            
            .email-tab-btn {
                padding: 8px 12px !important;
                font-size: 12px !important;
                white-space: nowrap;
                flex-shrink: 0;
            }
            
            /* Tab container sempre scrollabile orizzontalmente su mobile */
            div[style*="display: flex"][style*="gap"] {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }
            
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                width: 100%;
                -ms-overflow-style: -ms-autohiding-scrollbar;
            }
            
            table {
                font-size: 10px;
                width: max-content;
                min-width: 100%;
                border-spacing: 0;
            }
            
            /* Riduci spazio tra colonne */
            table th + th,
            table td + td {
                padding-left: 2px !important;
            }
            
            th, td {
                padding: 4px 2px !important;
                font-size: 10px !important;
                white-space: nowrap;
                line-height: 1.2;
            }
            
            th {
                padding: 6px 2px !important;
                font-size: 9px !important;
            }
            
            th:first-child, td:first-child {
                padding-left: 4px !important;
            }
            
            th:last-child, td:last-child {
                padding-right: 4px !important;
            }
            
            .button {
                padding: 10px 16px;
                font-size: 13px;
                width: auto;
            }
            
            .form-grid {
                grid-template-columns: 1fr !important;
                gap: 16px;
            }
            
            .form-group {
                width: 100%;
            }
            
            .form-group.full {
                grid-column: 1 !important;
            }
            
            #opportunities-table td {
                max-width: 150px;
            }
            
            /* Ottimizzazioni specifiche per tabelle su mobile */
            #opportunities-table th,
            #opportunities-table td,
            #leads-table th,
            #leads-table td,
            #accounts-table th,
            #accounts-table td,
            #products-table th,
            #products-table td {
                padding: 3px 1px !important;
                font-size: 9px !important;
                line-height: 1.1 !important;
            }
            
            #opportunities-table th,
            #leads-table th,
            #accounts-table th,
            #products-table th {
                padding: 5px 1px !important;
                font-size: 8px !important;
            }
            
            /* Riduci spazio tra colonne */
            #opportunities-table th + th,
            #opportunities-table td + td,
            #leads-table th + th,
            #leads-table td + td,
            #accounts-table th + th,
            #accounts-table td + td,
            #products-table th + th,
            #products-table td + td {
                padding-left: 1px !important;
            }
            
            /* Riduci padding first/last */
            #opportunities-table th:first-child,
            #opportunities-table td:first-child,
            #leads-table th:first-child,
            #leads-table td:first-child,
            #accounts-table th:first-child,
            #accounts-table td:first-child,
            #products-table th:first-child,
            #products-table td:first-child {
                padding-left: 3px !important;
            }
            
            #opportunities-table th:last-child,
            #opportunities-table td:last-child,
            #leads-table th:last-child,
            #leads-table td:last-child,
            #accounts-table th:last-child,
            #accounts-table td:last-child,
            #products-table th:last-child,
            #products-table td:last-child {
                padding-right: 3px !important;
            }
            
            /* Riduci dimensione pulsanti nelle tabelle */
            #opportunities-table button,
            #leads-table button,
            #accounts-table button,
            #products-table button {
                padding: 2px 4px !important;
                font-size: 8px !important;
                margin: 1px !important;
            }
            
            /* Riduci dimensione input nelle tabelle */
            #opportunities-table input,
            #leads-table input,
            #accounts-table input {
                padding: 2px 3px !important;
                font-size: 9px !important;
            }
            
            /* Riduci dimensione select nelle tabelle */
            #opportunities-table select,
            #leads-table select,
            #accounts-table select {
                padding: 2px 3px !important;
                font-size: 9px !important;
            }
            
            #opportunities-table button {
                padding: 4px 6px !important;
                font-size: 10px !important;
                white-space: nowrap;
            }
            
            .nav-item {
                padding: 12px 16px;
                font-size: 14px;
            }
            
            .logo h1 {
                font-size: 24px;
            }
            
            .logo p {
                font-size: 12px;
            }
            
            /* Assicura che tutti i flex container wrappino */
            [style*="display: flex"] {
                flex-wrap: wrap;
            }
            
            /* Modali responsive */
            .modal-content {
                width: 95vw !important;
                max-width: 95vw !important;
                margin: 20px auto !important;
                padding: 16px !important;
            }
        }
        
        /* Mobile Piccolo */
        @media (max-width: 480px) {
            .content {
                padding: 70px 12px 20px;
                width: 100%;
            }
            
            .hero h2 {
                font-size: 20px;
            }
            
            .card {
                padding: 12px;
                width: 100%;
            }
            
            .email-tab-btn {
                padding: 6px 10px !important;
                font-size: 11px !important;
            }
            
            table {
                font-size: 11px;
                width: max-content;
            }
            
            th, td {
                padding: 3px 1px !important;
                font-size: 9px !important;
                line-height: 1.1;
            }
            
            th {
                padding: 5px 1px !important;
                font-size: 8px !important;
            }
            
            th:first-child, td:first-child {
                padding-left: 3px !important;
            }
            
            th:last-child, td:last-child {
                padding-right: 3px !important;
            }
            
            table th + th,
            table td + td {
                padding-left: 1px !important;
            }
            
            .button {
                padding: 8px 12px;
                font-size: 12px;
                width: 100%;
            }
            
            .hero-actions .button {
                width: 100%;
            }
            
            .mobile-menu-toggle {
                width: 44px;
                height: 44px;
                font-size: 20px;
                top: 16px;
                left: 16px;
            }
            
            .notifications-container {
                top: 70px;
                right: 12px;
            }
            
            .notification-bell {
                width: 44px;
                height: 44px;
                font-size: 18px;
            }
            
            .notifications-dropdown {
                width: calc(100vw - 24px);
            }
            
            /* Grafici dashboard su una colonna */
            .card > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Tab buttons piÃ¹ compatti */
            .email-tab-btn span {
                display: none !important;
            }
            
            /* Form full width su mobile piccolo */
            input, select, textarea {
                width: 100% !important;
            }
        }
        
        /* Ottimizzazioni grafici Chart.js per mobile */
        @media (max-width: 768px) {
            canvas {
                max-height: 250px !important;
            }
            
            .card h3 {
                font-size: 16px;
            }
            
            .dashboard-charts-grid {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* Touch-friendly buttons */
        @media (max-width: 768px) {
            button, .button, .nav-item, .email-tab-btn {
                min-height: 44px;
                touch-action: manipulation;
            }
            
            input, select, textarea {
                min-height: 44px;
                font-size: 16px; /* Previene zoom su iOS */
            }
        }
        
        /* Ottimizzazioni modali per mobile */
        @media (max-width: 768px) {
            .modal-content {
                width: 95vw !important;
                max-width: 95vw !important;
                margin: 20px auto !important;
                max-height: 90vh;
                overflow-y: auto;
            }
        }
        
        /* Overlay per mobile sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .sidebar-overlay.show {
            display: block;
            opacity: 1;
        }
        
        @media (min-width: 769px) {
            .sidebar-overlay {
                display: none !important;
            }
        }
        
        /* Tabella OpportunitÃ  Compatta */
        #opportunities-table th,
        #opportunities-table td {
            padding: 6px 4px !important;
            font-size: 12px !important;
            white-space: nowrap;
            line-height: 1.3;
        }
        
        #opportunities-table th {
            font-size: 10px !important;
            padding: 8px 4px !important;
        }
        
        #opportunities-table td {
            vertical-align: middle;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        #opportunities-table td:nth-child(1) {
            max-width: 250px;
        }
        
        #opportunities-table td:nth-child(2) {
            max-width: 180px;
        }
        
        #opportunities-table td:nth-child(3) {
            max-width: 200px;
            white-space: normal;
        }
        
        #opportunities-table td:nth-child(10) {
            max-width: 250px;
            white-space: normal;
        }
        
        #opportunities-table .tag {
            font-size: 11px !important;
            padding: 3px 8px !important;
            margin: 2px !important;
            white-space: nowrap;
        }
        
        #opportunities-table input[type="date"],
        #opportunities-table select {
            font-size: 11px !important;
            padding: 4px 6px !important;
            min-width: 110px;
        }
        
        #opportunities-table button {
            font-size: 11px !important;
            padding: 4px 8px !important;
            margin: 2px !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
        }
        
        #opportunities-table button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #opportunities-table button:active {
            transform: translateY(0);
        }
        
        /* Tooltip per testo completo */
        #opportunities-table td[title] {
            cursor: help;
        }
        
        /* Smooth scroll per la pagina */
        html {
            scroll-behavior: smooth;
        }
        
        /* Animazioni per i pulsanti */
        .button {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        #opportunities-table button {
            font-size: 11px !important;
            padding: 4px 8px !important;
            margin: 2px !important;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #opportunities-table button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        #opportunities-table button:active {
            transform: translateY(0);
        }
        
        /* Smooth scroll per la pagina */
        html {
            scroll-behavior: smooth;
        }
        
        /* Animazioni per i pulsanti */
        .button {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }
        
        .table-wrapper::-webkit-scrollbar-track {
            background: var(--bg-light);
            border-radius: 4px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--text-light);
        }
        
        .table-search {
            width: 100%;
            padding: 14px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 15px;
            margin-bottom: 20px;
            transition: all 0.3s;
            background: var(--bg-white);
        }
        
        .table-search:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
            height: 20px;
            margin: 8px 0;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--bg-white);
            border-radius: 12px;
            overflow: hidden;
        }
        
        thead {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        
        th {
            text-align: left;
            padding: 10px 10px;
            border-bottom: 2px solid var(--border-color);
            font-weight: 700;
            font-size: 11px;
            color: var(--text-medium);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
            background: inherit;
            line-height: 1.3;
        }
        
        th:first-child {
            padding-left: 12px;
        }
        
        th:last-child {
            padding-right: 12px;
        }
        
        tbody tr {
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border-light);
            height: auto;
        }
        
        tbody tr:hover {
            background: #f8fafc;
        }
        
        tbody tr:last-child {
            border-bottom: none;
        }
        
        td {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-dark);
            font-size: 13px;
            vertical-align: middle;
            line-height: 1.4;
        }
        
        td:first-child {
            padding-left: 12px;
            font-weight: 600;
        }
        
        td:last-child {
            padding-right: 12px;
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }
        
        .price-levels {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .price-pill {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            background: var(--primary-light);
            color: var(--primary);
        }
        
        .grid.three {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }
        
        @media (max-width: 1024px) {
            .grid.three {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .grid.three {
                grid-template-columns: 1fr;
            }
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group.full {
            grid-column: 1 / -1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-header h3 {
            font-size: 24px;
            font-weight: 700;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }
        
        .price-input-group {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 12px;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 8px;
        }
        
        .price-input-group label {
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .price-input-group input {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }
        
        .sync-button {
            background: var(--success);
            color: white;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .sync-button:hover {
            background: #16a34a;
        }
        
        .tag {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 700;
            display: inline-block;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s;
        }
        
        .tag:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .tag.green {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
        }
        
        .tag.red {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
        }
        
        .tag.orange {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            color: white;
        }
        
        .tag.amber {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .tag.blue {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        /* Email Marketing Tabs */
        .email-tab-btn {
            padding: 10px 16px;
            border: none;
            background: transparent;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-medium);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border-radius: 8px 8px 0 0;
            white-space: nowrap;
            opacity: 0.7;
        }
        
        .email-tab-btn:hover {
            opacity: 1;
            background: var(--bg-light);
        }
        
        .email-tab-btn.active {
            opacity: 1;
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: var(--primary-light);
            font-weight: 600;
        }
        
        .email-tab-btn::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: var(--primary);
            transform: translateX(-50%);
            transition: width 0.3s ease;
        }
        
        .email-tab-btn:hover {
            color: var(--primary);
            background: var(--primary-light);
        }
        
        .email-tab-btn.active {
            color: var(--primary);
            background: var(--primary-light);
        }
        
        .email-tab-btn.active::before {
            width: 80%;
        }
        .email-tab-content {
            display: none;
        }
        .email-tab-content.active {
            display: block;
        }
        
        /* Search/Filtri */
        .table-search {
            margin-bottom: 16px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            width: 100%;
            max-width: 400px;
        }
    
        .assistant-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
            height: 100%;
        }
        .assistant-messages {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            min-height: 320px;
            max-height: 520px;
            overflow-y: auto;
            background: var(--bg-light);
        }
        .assistant-message {
            padding: 10px 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 14px;
            line-height: 1.4;
            max-width: 85%;
        }
        .assistant-message.user {
            background: var(--primary);
            color: white;
            margin-left: auto;
        }
        .assistant-message.bot {
            background: white;
            border: 1px solid var(--border-color);
            color: var(--text-dark);
        }
        .assistant-input-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
        }
        .assistant-input-row textarea {
            min-height: 80px;
            resize: vertical;
        }
        .assistant-actions {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Chat fluttuante assistente */
        .assistant-chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            max-height: 600px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 10000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .assistant-chat-widget.open {
            display: flex;
        }
        
        .assistant-chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .assistant-chat-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .assistant-chat-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .assistant-chat-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .assistant-chat-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .assistant-chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: var(--bg-light);
            min-height: 200px;
            max-height: 400px;
        }
        
        .assistant-chat-input-container {
            padding: 12px;
            border-top: 1px solid var(--border-color);
            background: white;
        }
        
        .assistant-chat-input-row {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        
        .assistant-chat-input-row textarea {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            max-height: 100px;
        }
        
        .assistant-chat-input-row button {
            padding: 10px 20px;
            height: fit-content;
        }
        
        .assistant-chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(102,126,234,0.4);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .assistant-chat-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102,126,234,0.6);
        }
        
        .assistant-chat-toggle.hidden {
            display: none;
        }

</style>
</head>
<body>
    <!-- Hamburger Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Menu">
        <span id="menu-icon">â˜°</span>
    </button>
    
    <!-- Overlay per mobile sidebar -->
    <div class="sidebar-overlay" onclick="closeMobileMenu()"></div>
    
    <!-- Notifiche -->
    <div class="notifications-container">
        <div class="notification-bell" onclick="toggleNotifications()">
            ðŸ””
            <div class="notification-badge" id="notification-badge" style="display: none;">0</div>
        </div>
        <div class="notifications-dropdown" id="notifications-dropdown">
            <div class="notifications-header">
                <h4>ðŸ”” Notifiche</h4>
                <button onclick="markAllNotificationsRead()" style="background: none; border: none; color: var(--primary); cursor: pointer; font-size: 12px;">Segna tutte come lette</button>
            </div>
            <div id="notifications-list">
                <div style="padding: 40px; text-align: center; color: var(--text-light);">Caricamento...</div>
            </div>
        </div>
    </div>
    
    <aside class="sidebar">
        <div class="logo">
            <h1>MekoCRM</h1>
            <p>Sales & Offer Management</p>
        </div>
        <nav class="nav-menu">
            <div class="nav-item active" data-target="dashboard-view">Dashboard</div>
            <div class="nav-item" data-target="my-tasks-view">ðŸ“‹ Mie AttivitÃ </div>
            <div class="nav-item" data-target="assistant-view">ðŸ¤– Assistant</div>
            <div class="nav-item" data-target="leads-view">Leads</div>
            <div class="nav-item" data-target="accounts-view">Accounts</div>
            <div class="nav-item" data-target="map-view">ðŸ—ºï¸ Mappa Contatti</div>
            <div class="nav-item" data-target="opportunities-view">OpportunitÃ </div>
            <div class="nav-item" data-target="products-view">Listini</div>
            <div class="nav-item" data-target="email-marketing-view">ðŸ“§ Email Marketing</div>
            <div class="nav-item" data-target="tickets-view">ðŸŽ« Ticket Supporto</div>
            <div class="nav-item" data-target="setup-view">âš™ï¸ Setup</div>
            <div class="nav-item" data-target="settings-view">âš™ï¸ Impostazioni</div>
            <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border-color); display: none;">
                <div style="font-size: 11px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; padding-left: 16px;">Sviluppi Futuri</div>
                <div class="nav-item" data-target="offers-view" style="opacity: 0.6; font-size: 13px;">ðŸ”® Offer Generator</div>
            </div>
            <a href="/logout" class="nav-item" style="margin-top: 24px;" onclick="handleLogout()">Logout</a>
        </nav>
    </aside>

    <main class="content">
        <!-- Dashboard -->
        <section id="dashboard-view" class="view active">
            <div class="hero">
                <div>
                    <h2>Dashboard</h2>
                    <p style="color: var(--text-light);">Visione sintetica della pipeline</p>
                </div>
                <div class="hero-actions">
                    <button class="button secondary" onclick="loadMorningTaskSummary()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                        â˜€ï¸ Riepilogo AttivitÃ  Mattutino
                    </button>
                </div>
            </div>
            
            <!-- Riepilogo Mattutino -->
            <div id="morning-summary-card" class="card" style="display: none; margin-bottom: 24px; border-left: 4px solid #f59e0b;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0; color: #f59e0b;">â˜€ï¸ Riepilogo AttivitÃ  da Fare</h3>
                    <button onclick="document.getElementById('morning-summary-card').style.display='none'" style="background: none; border: none; font-size: 20px; cursor: pointer;">&times;</button>
                </div>
                <div id="morning-summary-content"></div>
            </div>
            <div class="grid three" id="dashboard-metrics"></div>
            
            <!-- Grafici Dashboard -->
            <div class="dashboard-charts-grid" style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-top: 24px;">
                <div class="card">
                    <h3 style="margin-bottom: 16px;">ðŸ“ˆ Andamento Pipeline (Ultimi 6 Mesi)</h3>
                    <div style="position: relative; height: 300px;">
                        <canvas id="chart-timeline"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom: 16px;">ðŸŽ¯ Pipeline per Categoria</h3>
                    <div style="position: relative; height: 300px;">
                        <canvas id="chart-categorie"></canvas>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">
                <div class="card">
                    <h3 style="margin-bottom: 16px;">ðŸ“Š OpportunitÃ  per Stato</h3>
                    <div style="position: relative; height: 300px;">
                        <canvas id="chart-stati"></canvas>
                    </div>
                    <div id="heat-counts-container"></div>
                </div>
                <div class="card">
                    <h3 style="margin-bottom: 16px;">ðŸ‘¥ Leaderboard Team</h3>
                    <div id="leaderboard-container" style="max-height: 300px; overflow-y: auto;">
                        <div style="text-align: center; padding: 40px; color: var(--text-light);">Caricamento...</div>
                    </div>
                </div>
            </div>
            
            <!-- Tabella OpportunitÃ  Recenti -->
            <div class="card" style="margin-top: 24px;">
                <h3 style="margin-bottom: 16px;">ðŸ“‹ OpportunitÃ  Recenti</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Account</th>
                                <th>Stato</th>
                                <th>Valore</th>
                                <th>ProbabilitÃ </th>
                                <th>Data Creazione</th>
                            </tr>
                        </thead>
                        <tbody id="recent-opportunities-table">
                            <tr><td colspan="6" style="text-align: center; padding: 40px;">Caricamento...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Mie AttivitÃ  -->
        <section id="my-tasks-view" class="view">
            <div class="hero">
                <div>
                    <h2>ðŸ“‹ Mie AttivitÃ </h2>
                    <p style="color: var(--text-medium);">Le attivitÃ  assegnate a te</p>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid var(--border-color); flex-wrap: wrap; overflow-x: auto;">
                <button class="email-tab-btn active" onclick="switchMyTasksTab('all')" data-my-tasks-tab="all" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; white-space: nowrap; padding: 10px 16px; font-size: 14px; font-weight: 500;">ðŸ“‹ Tutte</button>
                <button class="email-tab-btn" onclick="switchMyTasksTab('pending')" data-my-tasks-tab="pending" style="white-space: nowrap; padding: 10px 16px; font-size: 14px; font-weight: 500;">â³ Da Fare</button>
                <button class="email-tab-btn" onclick="switchMyTasksTab('completed')" data-my-tasks-tab="completed" style="white-space: nowrap; padding: 10px 16px; font-size: 14px; font-weight: 500;">âœ… Completate</button>
                <button class="email-tab-btn" onclick="switchMyTasksTab('overdue')" data-my-tasks-tab="overdue" style="white-space: nowrap; padding: 10px 16px; font-size: 14px; font-weight: 500;">âš ï¸ Scadute</button>
            </div>
            
            <div class="card">
                <div id="my-tasks-container" style="min-height: 400px;">
                    <div style="text-align: center; padding: 40px; color: var(--text-medium);">Caricamento attivitÃ ...</div>
                </div>
            </div>
        </section>

        <!-- Leads -->
        <section id="leads-view" class="view">
            <div class="hero">
                <div>
                    <h2>Leads</h2>
                    <p style="color: var(--text-light);">Gestisci prospect e richieste</p>
                </div>
                <div class="hero-actions">
                    <button class="button" onclick="showLeadForm()">+ Nuovo Lead</button>
                </div>
            </div>
            
            <div class="card" id="lead-form-card" style="display:none;">
                <h3 style="margin-bottom: 16px;">Crea Nuovo Lead</h3>
                <form id="lead-form" class="form-grid">
                    <div class="form-group">
                        <label>Azienda *</label>
                        <input type="text" name="company_name" required>
                    </div>
                    <div class="form-group">
                        <label>Nome Contatto</label>
                        <input type="text" name="contact_first_name">
                    </div>
                    <div class="form-group">
                        <label>Cognome Contatto</label>
                        <input type="text" name="contact_last_name">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email">
                    </div>
                    <div class="form-group">
                        <label>Telefono</label>
                        <input type="text" name="phone">
                    </div>
                    <div class="form-group">
                        <label>Interesse</label>
                        <select name="interest">
                            <option value="">--</option>
                            <option value="MIR">MiR</option>
                            <option value="UR">Universal Robots</option>
                            <option value="Unitree">Unitree</option>
                            <option value="ROEQ">ROEQ</option>
                            <option value="Servizi">Servizi</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fonte</label>
                        <input type="text" name="source">
                    </div>
                    <div class="form-group">
                        <label>Rating</label>
                        <select name="rating">
                            <option value="Hot">Hot</option>
                            <option value="Warm" selected>Warm</option>
                            <option value="Cold">Cold</option>
                        </select>
                    </div>
                    <div class="form-group full">
                        <label>Note</label>
                        <textarea name="notes"></textarea>
                    </div>
                    <div class="form-group full" style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="button secondary" onclick="hideLeadForm()">Annulla</button>
                        <button type="submit" class="button">Salva Lead</button>
                    </div>
                </form>
            </div>
            
            <!-- Tab Navigation Leads -->
            <div style="display: flex; gap: 12px; margin-bottom: 16px; border-bottom: 2px solid var(--border-color); flex-wrap: wrap;">
                <button class="email-tab-btn active" onclick="switchLeadTab('all')" data-lead-tab="all">ðŸ“‹ Tutti</button>
                <button class="email-tab-btn" onclick="switchLeadTab('MIR')" data-lead-tab="MIR">ðŸš› MiR</button>
                <button class="email-tab-btn" onclick="switchLeadTab('UR')" data-lead-tab="UR">ðŸ¤– UR</button>
                <button class="email-tab-btn" onclick="switchLeadTab('Unitree')" data-lead-tab="Unitree">ðŸ¦¾ Unitree</button>
                <button class="email-tab-btn" onclick="switchLeadTab('SITO WEB')" data-lead-tab="SITO WEB">ðŸŒ Sito Web</button>
                <button class="email-tab-btn" onclick="switchLeadTab('VOX MAIL')" data-lead-tab="VOX MAIL">ðŸ“§ Vox Mail</button>
                <button class="email-tab-btn" onclick="switchLeadTab('Database Marittimo')" data-lead-tab="Database Marittimo">ðŸŒŠ Database Marittimo</button>
            </div>
            
            <div class="card">
                <input type="text" class="table-search" id="leads-search" placeholder="ðŸ” Cerca leads su tutte le pagine..." onkeyup="searchLeads()">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Azienda</th>
                                <th>Contatto</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Interesse</th>
                                <th>Source</th>
                                <th>Indirizzo</th>
                                <th>Data Creazione</th>
                                <th>Ultimo Contatto</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="leads-table"></tbody>
                    </table>
                </div>
                <div id="leads-pagination"></div>
            </div>
        </section>

        <!-- Accounts -->
        <section id="accounts-view" class="view">
            <div class="hero">
                <div>
                    <h2>Accounts</h2>
                    <p style="color: var(--text-light);">Gestisci aziende clienti</p>
                </div>
                <div class="hero-actions">
                    <button class="button" onclick="showAccountForm()">+ Nuovo Account</button>
                </div>
            </div>
            
            <div class="card" id="account-form-card" style="display:none;">
                <h3 style="margin-bottom: 16px;">Crea Nuovo Account</h3>
                <form id="account-form" class="form-grid">
                    <div class="form-group">
                        <label>Nome Azienda *</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Industry</label>
                        <input type="text" name="industry">
                    </div>
                    <div class="form-group">
                        <label>Telefono</label>
                        <input type="text" name="phone">
                    </div>
                    <div class="form-group">
                        <label>Website</label>
                        <input type="url" name="website">
                    </div>
                    <div class="form-group full">
                        <label>Indirizzo Fatturazione</label>
                        <textarea name="billing_address"></textarea>
                    </div>
                    <div class="form-group full">
                        <label>Indirizzo Spedizione</label>
                        <textarea name="shipping_address"></textarea>
                    </div>
                    <div class="form-group full">
                        <label>Descrizione</label>
                        <textarea name="description"></textarea>
                    </div>
                    <div class="form-group full" style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="button secondary" onclick="hideAccountForm()">Annulla</button>
                        <button type="submit" class="button">Salva Account</button>
                    </div>
                </form>
            </div>
            
            <!-- Tab Navigation Accounts -->
            <div style="display: flex; gap: 12px; margin-bottom: 16px; border-bottom: 2px solid var(--border-color); flex-wrap: wrap;">
                <button class="email-tab-btn active" onclick="switchAccountTab('all')" data-account-tab="all">ðŸ“‹ Tutti</button>
                <button class="email-tab-btn" onclick="switchAccountTab('con-opportunita')" data-account-tab="con-opportunita">âœ… Con OpportunitÃ </button>
                <button class="email-tab-btn" onclick="switchAccountTab('senza-opportunita')" data-account-tab="senza-opportunita">âšª Senza OpportunitÃ </button>
                <button class="email-tab-btn" onclick="switchAccountTab('recenti')" data-account-tab="recenti">ðŸ†• Recenti</button>
            </div>
            
            <!-- Filtri e Ordinamento -->
            <div class="card" style="margin-bottom: 24px;">
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: center;">
                    <input type="text" class="table-search" id="accounts-search" placeholder="ðŸ” Cerca accounts per nome, industry, telefono..." onkeyup="filterAccounts()" style="width: 100%;">
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <label style="font-size: 13px; color: var(--text-light);">Ordina per:</label>
                        <select id="accounts-sort" onchange="sortAccounts()" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 13px;">
                            <option value="name-asc">Nome (A-Z)</option>
                            <option value="name-desc">Nome (Z-A)</option>
                            <option value="created-desc">Data Creazione (Recenti)</option>
                            <option value="created-asc">Data Creazione (Vecchi)</option>
                            <option value="opp-count-desc">OpportunitÃ  (PiÃ¹)</option>
                            <option value="opp-count-asc">OpportunitÃ  (Meno)</option>
                            <option value="last-opp-desc">Ultima Opp (Recente)</option>
                            <option value="last-opp-asc">Ultima Opp (Vecchia)</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Industry</th>
                                <th>Telefono</th>
                                <th>OpportunitÃ </th>
                                <th>Data Creazione</th>
                                <th>Ultima OpportunitÃ </th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="accounts-table"></tbody>
                    </table>
                </div>
                <div id="accounts-pagination"></div>
            </div>
        </section>

        <!-- Map View -->
        <section id="map-view" class="view">
            <div class="hero">
                <div>
                    <h2>ðŸ—ºï¸ Mappa Contatti</h2>
                    <p style="color: var(--text-light);">Visualizzazione geografica di account e leads</p>
                </div>
                <div class="hero-actions">
                    <input type="text" id="map-search" placeholder="ðŸ” Cerca cliente per nome..." 
                           style="padding: 10px 16px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px; min-width: 300px; margin-right: 12px;"
                           onkeyup="searchOnMap(this.value)">
                    <button class="button" onclick="loadMapData()">ðŸ”„ Aggiorna Mappa</button>
                </div>
            </div>
            
            <div class="card" style="height: 800px; padding: 0; position: relative;">
                <div id="map-container" style="width: 100%; height: 100%; border-radius: 8px; overflow: hidden; position: relative;">
                    <div id="map-loading" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 2000; border-radius: 8px;">
                        <div class="spinner" style="width: 48px; height: 48px; border: 4px solid var(--border-color); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 16px;"></div>
                        <div style="color: var(--text-medium); font-size: 14px; font-weight: 500;">Caricamento mappa...</div>
                        <div style="color: var(--text-light); font-size: 12px; margin-top: 8px;" id="map-loading-status">Preparazione dati...</div>
                    </div>
                </div>
                <div id="map-legend" style="position: absolute; top: 16px; right: 16px; background: white; padding: 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 1000; max-width: 200px;">
                    <h4 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600;">Legenda</h4>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 20px; background: #3b82f6; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
                            <span style="font-size: 12px;">Account</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 20px; height: 20px; background: #10b981; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
                            <span style="font-size: 12px;">Lead</span>
                        </div>
                        <div style="border-top: 1px solid var(--border-color); margin: 8px 0; padding-top: 8px;">
                            <div style="font-size: 11px; font-weight: 600; color: var(--text-medium); margin-bottom: 6px;">Categorie:</div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="width: 18px; height: 18px; background: #3b82f6; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
                                <span style="font-size: 11px;">MiR</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="width: 18px; height: 18px; background: #8b5cf6; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
                                <span style="font-size: 11px;">Universal Robots</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="width: 18px; height: 18px; background: #10b981; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
                                <span style="font-size: 11px;">Unitree</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 18px; height: 18px; background: #64748b; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
                                <span style="font-size: 11px;">Altri</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Assistant View -->
        <section id="assistant-view" class="view">
            <div class="hero">
                <div>
                    <h2>ðŸ¤– Assistant</h2>
                    <p style="color: var(--text-light);">Chat AI per modificare opportunitÃ  e creare attivitÃ </p>
                </div>
                <div class="hero-actions">
                    <button class="button" onclick="openAssistantChat()">ðŸ’¬ Apri Chat Assistant</button>
                </div>
            </div>
            
            <div class="card">
                <p style="color: var(--text-medium); margin-bottom: 16px;">
                    L'assistente Ã¨ disponibile come chat fluttuante in basso a destra. 
                    Clicca sul pulsante qui sopra o sul pulsante fluttuante per aprire la chat.
                </p>
                <div style="background: var(--bg-light); padding: 16px; border-radius: 8px;">
                    <h3 style="margin-top: 0; font-size: 16px; font-weight: 600;">Cosa puoi chiedere:</h3>
                    <ul style="margin: 8px 0; padding-left: 20px; color: var(--text-dark);">
                        <li>Cambiare lo stato di un'opportunitÃ  (es: "Metti Eurovo in Negoziazione")</li>
                        <li>Creare attivitÃ  (es: "Crea un'attivitÃ  per chiamare Eurofresi assegnata a Giovanni")</li>
                        <li>Aggiornare categorie (es: "Metti Multimac in categoria UR")</li>
                        <li>Cambiare calore opportunitÃ  (es: "Metti Scuola Camerana in calda")</li>
                        <li>Aggiornare importo (es: "Imposta importo 50000 per Eurovo")</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Opportunities -->
        <section id="opportunities-view" class="view">
            <div class="hero">
                <div>
                    <h2>OpportunitÃ </h2>
                    <p style="color: var(--text-light);">Pipeline e trattative</p>
                </div>
                <div class="hero-actions">
                    <button class="button" onclick="showOpportunityForm()">+ Nuova OpportunitÃ </button>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div style="display: flex; gap: 8px; margin-bottom: 16px; border-bottom: 2px solid var(--border-color); flex-wrap: wrap; overflow-x: auto;">
                <button class="email-tab-btn active" onclick="switchOppTab('all')" data-opp-tab="all" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; white-space: nowrap; padding: 10px 16px; font-size: 14px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">Tutte</button>
                <button class="email-tab-btn" onclick="switchOppTab('calda')" data-opp-tab="calda" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; white-space: nowrap; padding: 10px 16px; font-size: 14px; font-weight: 600; box-shadow: 0 2px 4px rgba(239,68,68,0.3);"><span style="display: inline-block; width: 8px; height: 8px; background: white; border-radius: 50%; margin-right: 6px; vertical-align: middle;"></span>Calde</button>
                <button class="email-tab-btn" onclick="switchOppTab('tiepida')" data-opp-tab="tiepida" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; white-space: nowrap; padding: 10px 16px; font-size: 14px; font-weight: 600; box-shadow: 0 2px 4px rgba(245,158,11,0.3);"><span style="display: inline-block; width: 8px; height: 8px; background: white; border-radius: 50%; margin-right: 6px; vertical-align: middle; opacity: 0.7;"></span>Tiepide</button>
                <button class="email-tab-btn" onclick="switchOppTab('fredda_speranza')" data-opp-tab="fredda_speranza" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; white-space: nowrap; padding: 10px 16px; font-size: 14px; font-weight: 600; box-shadow: 0 2px 4px rgba(59,130,246,0.3);"><span style="display: inline-block; width: 8px; height: 8px; border: 2px solid white; border-radius: 50%; margin-right: 6px; vertical-align: middle;"></span>Fredde con Speranza</button>
                <button class="email-tab-btn" onclick="switchOppTab('fredda_gelo')" data-opp-tab="fredda_gelo" style="background: linear-gradient(135deg, #64748b 0%, #475569 100%); color: white; white-space: nowrap; padding: 10px 16px; font-size: 14px; font-weight: 600; box-shadow: 0 2px 4px rgba(100,116,139,0.3);"><span style="display: inline-block; width: 8px; height: 8px; border: 2px solid white; border-radius: 50%; margin-right: 6px; vertical-align: middle; opacity: 0.5;"></span>Fredde Gelo</button>
                <button class="email-tab-btn" onclick="switchOppTab('da_categorizzare')" data-opp-tab="da_categorizzare" style="background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); color: white; white-space: nowrap; padding: 10px 16px; font-size: 14px; font-weight: 600; box-shadow: 0 2px 4px rgba(168,85,247,0.3);"><span style="display: inline-block; width: 8px; height: 8px; background: white; border-radius: 2px; margin-right: 6px; vertical-align: middle; opacity: 0.8;"></span>Da Categorizzare</button>
                <button class="email-tab-btn" onclick="switchOppTab('UR')" data-opp-tab="UR" style="white-space: nowrap; padding: 10px 16px; font-size: 14px; font-weight: 600; border: 2px solid var(--primary); color: var(--primary); background: white;">UR</button>
                <button class="email-tab-btn" onclick="switchOppTab('MIR')" data-opp-tab="MIR" style="white-space: nowrap; padding: 10px 16px; font-size: 14px; font-weight: 600; border: 2px solid #3b82f6; color: #3b82f6; background: white;">MiR</button>
                <button class="email-tab-btn" onclick="switchOppTab('Unitree')" data-opp-tab="Unitree" style="white-space: nowrap; padding: 10px 16px; font-size: 14px; font-weight: 600; border: 2px solid #10b981; color: #10b981; background: white;">Unitree</button>
                <button class="email-tab-btn" onclick="switchOppTab('Altri')" data-opp-tab="Altri" style="white-space: nowrap; padding: 10px 16px; font-size: 14px; font-weight: 600; border: 2px solid var(--text-light); color: var(--text-light); background: white;">Altri Prodotti</button>
                <button class="email-tab-btn" onclick="switchOppTab('closed_won')" data-opp-tab="closed_won" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; white-space: nowrap; padding: 10px 16px; font-size: 14px; font-weight: 600; box-shadow: 0 2px 4px rgba(16,185,129,0.3);"><span style="display: inline-block; width: 12px; height: 12px; background: white; border-radius: 2px; margin-right: 6px; vertical-align: middle; position: relative;"><span style="position: absolute; top: 2px; left: 3px; width: 4px; height: 6px; border: 2px solid #10b981; border-top: none; border-left: none; transform: rotate(45deg);"></span></span>Chiuse Vinte</button>
                <button class="email-tab-btn" onclick="switchOppTab('closed_lost')" data-opp-tab="closed_lost" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; white-space: nowrap; padding: 10px 16px; font-size: 14px; font-weight: 600; box-shadow: 0 2px 4px rgba(239,68,68,0.3);"><span style="display: inline-block; width: 12px; height: 12px; background: white; border-radius: 2px; margin-right: 6px; vertical-align: middle; position: relative;"><span style="position: absolute; top: 4px; left: 2px; width: 8px; height: 2px; background: #ef4444; transform: rotate(45deg);"></span><span style="position: absolute; top: 4px; left: 2px; width: 8px; height: 2px; background: #ef4444; transform: rotate(-45deg);"></span></span>Chiuse Perse</button>
            </div>
            
            <div class="card" id="opportunity-form-card" style="display:none;">
                <h3 style="margin-bottom: 16px;">Crea Nuova OpportunitÃ </h3>
                <form id="opportunity-form" class="form-grid">
                    <div class="form-group">
                        <label>Nome OpportunitÃ  *</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Fase</label>
                        <select name="stage">
                            <option value="Qualification">Qualification</option>
                            <option value="Needs Analysis">Needs Analysis</option>
                            <option value="Value Proposition">Value Proposition</option>
                            <option value="Id. Decision Makers">Id. Decision Makers</option>
                            <option value="Perception Analysis">Perception Analysis</option>
                            <option value="Proposal/Price Quote">Proposal/Price Quote</option>
                            <option value="Negotiation/Review">Negotiation/Review</option>
                            <option value="Closed Won">Closed Won</option>
                            <option value="Closed Lost">Closed Lost</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Valore (â‚¬)</label>
                        <input type="number" step="0.01" name="amount" value="0">
                    </div>
                    <div class="form-group">
                        <label>ProbabilitÃ  (%)</label>
                        <input type="number" min="0" max="100" name="probability" value="10">
                    </div>
                    <div class="form-group">
                        <label>Data Chiusura Prevista</label>
                        <input type="date" name="close_date">
                    </div>
                    <div class="form-group">
                        <label>Tipo OpportunitÃ </label>
                        <input type="text" name="opportunity_type">
                    </div>
                    <div class="form-group">
                        <label>Categoria Prodotto *</label>
                        <select name="supplier_category" required>
                            <option value="">-- Seleziona --</option>
                            <option value="MiR">MiR</option>
                            <option value="Universal Robots">Universal Robots</option>
                            <option value="Unitree">Unitree</option>
                            <option value="MiR, Universal Robots">MiR + UR</option>
                            <option value="MiR, Unitree">MiR + Unitree</option>
                            <option value="Universal Robots, Unitree">UR + Unitree</option>
                            <option value="MiR, Universal Robots, Unitree">MiR + UR + Unitree</option>
                            <option value="Servizi">Servizi</option>
                            <option value="Altri Fornitori">Altri Fornitori</option>
                        </select>
                        <small style="color: var(--text-light); font-size: 12px;">Seleziona la categoria basata sui prodotti nell'offerta</small>
                    </div>
                    <div class="form-group full">
                        <label>Descrizione</label>
                        <textarea name="description"></textarea>
                    </div>
                    <div class="form-group full" style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="button secondary" onclick="hideOpportunityForm()">Annulla</button>
                        <button type="submit" class="button">Salva OpportunitÃ </button>
                    </div>
                </form>
            </div>
            
            <div class="card">
                <input type="text" class="table-search" id="opportunities-search" placeholder="ðŸ” Cerca opportunitÃ  per nome, account, categoria..." onkeyup="filterTable('opportunities-table', this.value)" onfocus="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px var(--primary-light)'" onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Account</th>
                                <th>Categoria</th>
                                <th>Calore</th>
                                <th>Fase</th>
                                <th>Valore</th>
                                <th>ProbabilitÃ </th>
                                <th>Date</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="opportunities-table"></tbody>
                    </table>
                </div>
                <div id="opportunities-pagination"></div>
            </div>
            
            <!-- Modal Chiusura OpportunitÃ  -->
            <div id="close-opportunity-modal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 500px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2>Chiudi OpportunitÃ </h2>
                        <button onclick="closeCloseOpportunityModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-medium);">&times;</button>
                    </div>
                    
                    <div class="card" style="margin-bottom: 24px;">
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Stato Chiusura *</label>
                                <div style="display: flex; gap: 12px;">
                                    <button type="button" id="close-won-btn" onclick="selectCloseStatus('won')" style="flex: 1; padding: 12px; background: var(--success); color: white; border: 2px solid var(--success); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                        âœ… Vinta
                                    </button>
                                    <button type="button" id="close-lost-btn" onclick="selectCloseStatus('lost')" style="flex: 1; padding: 12px; background: white; color: var(--danger); border: 2px solid var(--danger); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                                        âŒ Persa
                                    </button>
                                </div>
                            </div>
                            
                            <div id="won-details-container" style="display: none;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Valore Chiusura (â‚¬)</label>
                                <input type="number" id="closed-amount-input" step="0.01" min="0" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                                
                                <label style="display: block; margin-bottom: 8px; margin-top: 16px; font-weight: 600;">Margine (%)</label>
                                <input type="number" id="margin-input" step="0.01" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                                <p style="font-size: 11px; color: var(--text-medium); margin-top: 4px;">Lascia vuoto per calcolo automatico</p>
                            </div>
                            
                            <div id="lost-reason-container" style="display: none;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Motivazione *</label>
                                <textarea id="lost-reason-input" rows="4" placeholder="Inserisci la motivazione della chiusura persa..." style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
                            </div>
                            
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Data Chiusura</label>
                                <input type="date" id="close-date-input" value="${new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="button secondary" onclick="closeCloseOpportunityModal()">Annulla</button>
                        <button type="button" class="button" id="confirm-close-btn" onclick="confirmCloseOpportunity()" style="background: var(--primary);">Conferma Chiusura</button>
                    </div>
                </div>
            </div>
            
            <!-- Modal File Offerte OpportunitÃ  -->
            <div id="opportunity-files-modal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 id="opportunity-files-modal-title">ðŸ“ File Offerte</h2>
                        <button onclick="closeOpportunityFilesModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-medium);">&times;</button>
                    </div>
                    
                    <div id="opportunity-files-loading" style="text-align: center; padding: 40px;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-color); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <p style="margin-top: 16px; color: var(--text-medium);">Caricamento file...</p>
                    </div>
                    
                    <div id="opportunity-files-content" style="display: none;">
                        <div id="opportunity-files-list" style="display: grid; gap: 12px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Modal AttivitÃ  OpportunitÃ  -->
            <div id="opportunity-tasks-modal" class="modal" style="display: none;">
                <div class="modal-content" style="max-width: 800px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 id="opportunity-tasks-modal-title">ðŸ“‹ AttivitÃ  OpportunitÃ </h2>
                        <button onclick="closeOpportunityTasksModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-medium);">&times;</button>
                    </div>
                    
                    <!-- Form Crea AttivitÃ  -->
                    <div class="card" style="margin-bottom: 24px; background: var(--bg-light);">
                        <h3 style="margin-bottom: 16px; font-size: 18px;">âž• Crea Nuova AttivitÃ </h3>
                        <form id="opportunity-task-form" class="form-grid">
                            <div class="form-group">
                                <label>Tipo AttivitÃ  *</label>
                                <select name="task_type" required>
                                    <option value="">-- Seleziona --</option>
                                    <option value="call">ðŸ“ž CHIAMARE</option>
                                    <option value="visit">ðŸš— ANDARE IN VISITA</option>
                                    <option value="send_offer">ðŸ“„ MANDARE OFFERTA</option>
                                    <option value="email">âœ‰ï¸ INVIARE EMAIL</option>
                                    <option value="meeting">ðŸ¤ FISSARE RIUNIONE</option>
                                    <option value="follow_up">ðŸ”„ FOLLOW-UP</option>
                                    <option value="demo">ðŸŽ¬ DEMONSTRAZIONE</option>
                                    <option value="proposal">ðŸ“‹ PREPARARE PROPOSTA</option>
                                    <option value="other">ðŸ“ ALTRO</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Assegna a</label>
                                <select name="assigned_to_id" id="task-assigned-to-select">
                                    <option value="">-- Nessuno --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Scadenza</label>
                                <input type="date" name="due_date">
                            </div>
                            <div class="form-group full">
                                <label>Descrizione</label>
                                <textarea name="description" rows="3" placeholder="Dettagli dell'attivitÃ ..."></textarea>
                            </div>
                            <div class="form-group full" style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" class="button secondary" onclick="resetTaskForm()">Annulla</button>
                                <button type="submit" class="button">Crea AttivitÃ </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Lista AttivitÃ  -->
                    <div class="card">
                        <h3 style="margin-bottom: 16px; font-size: 18px;">ðŸ“‹ AttivitÃ </h3>
                        <div id="opportunity-tasks-list" style="min-height: 200px;">
                            <div style="text-align: center; padding: 40px; color: var(--text-medium);">Caricamento attivitÃ ...</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tickets Supporto -->
        <section id="tickets-view" class="view">
            <div class="hero">
                <div>
                    <h2>ðŸŽ« Ticket Supporto</h2>
                    <p style="color: var(--text-light);">Gestisci richieste e ticket di supporto</p>
                </div>
                <div class="hero-actions">
                    <button class="button" onclick="showTicketForm()">+ Nuovo Ticket</button>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div style="display: flex; gap: 12px; margin-bottom: 16px; border-bottom: 2px solid var(--border-color); flex-wrap: wrap;">
                <button class="email-tab-btn active" onclick="switchTicketTab('all')" data-ticket-tab="all">ðŸ“‹ Tutti</button>
                <button class="email-tab-btn" id="ticket-tab-my" onclick="switchTicketTab('my')" data-ticket-tab="my" style="display: none;">ðŸ‘¤ Assegnati a Me</button>
                <button class="email-tab-btn" onclick="switchTicketTab('open')" data-ticket-tab="open">ðŸ”“ Aperti</button>
                <button class="email-tab-btn" onclick="switchTicketTab('closed')" data-ticket-tab="closed">âœ… Chiusi</button>
            </div>
            
            <!-- Form Nuovo Ticket -->
            <div class="card" id="ticket-form-card" style="display:none;">
                <h3 style="margin-bottom: 16px;">Crea Nuovo Ticket</h3>
                <form id="ticket-form" class="form-grid">
                    <div class="form-group full">
                        <label>Titolo *</label>
                        <input type="text" name="title" required placeholder="Breve descrizione del problema/richiesta">
                    </div>
                    <div class="form-group">
                        <label>Tipo Richiesta</label>
                        <select name="category">
                            <option value="">-- Seleziona --</option>
                            <option value="Supporto">Supporto</option>
                            <option value="Richiesta">Richiesta</option>
                            <option value="Bug">Bug</option>
                            <option value="Altro">Altro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Prodotto *</label>
                        <select name="product_category" required>
                            <option value="">-- Seleziona Prodotto --</option>
                            <option value="MiR">MiR</option>
                            <option value="Universal Robots">Universal Robots</option>
                            <option value="Unitree">Unitree</option>
                            <option value="MiR, Universal Robots">MiR + Universal Robots</option>
                            <option value="MiR, Unitree">MiR + Unitree</option>
                            <option value="Universal Robots, Unitree">Universal Robots + Unitree</option>
                            <option value="MiR, Universal Robots, Unitree">MiR + UR + Unitree</option>
                            <option value="Altri Prodotti">Altri Prodotti</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>PrioritÃ </label>
                        <select name="priority">
                            <option value="Bassa">Bassa</option>
                            <option value="Media" selected>Media</option>
                            <option value="Alta">Alta</option>
                            <option value="Urgente">Urgente</option>
                        </select>
                    </div>
                    <div class="form-group full">
                        <label>Descrizione *</label>
                        <textarea name="description" required rows="6" placeholder="Descrivi in dettaglio il problema o la richiesta..."></textarea>
                    </div>
                    <div class="form-group full" style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="button secondary" onclick="hideTicketForm()">Annulla</button>
                        <button type="submit" class="button">Crea Ticket</button>
                    </div>
                </form>
            </div>
            
            <div class="card">
                <input type="text" class="table-search" id="tickets-search" placeholder="ðŸ” Cerca ticket per numero, titolo..." onkeyup="filterTickets()">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Numero</th>
                                <th>Titolo</th>
                                <th>Prodotto</th>
                                <th>Tipo Richiesta</th>
                                <th>PrioritÃ </th>
                                <th>Stato</th>
                                <th>Cliente</th>
                                <th>Assegnato a</th>
                                <th>Data Creazione</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="tickets-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Setup -->
        <section id="setup-view" class="view">
            <div class="hero">
                <div>
                    <h2>âš™ï¸ Setup & Manutenzione</h2>
                    <p style="color: var(--text-light);">Configurazione e attivitÃ  di import/manutenzione</p>
                </div>
            </div>
            
            <div class="card" style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px;">ðŸ”„ Sincronizzazione Dati</h3>
                <p style="color: var(--text-medium); margin-bottom: 16px;">
                    Sincronizza dati da sistemi esterni e cartelle locali.
                </p>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="button sync-button" onclick="syncPricebook()">
                        ðŸ”„ Sincronizza Listini
                    </button>
                    <button class="button sync-button" onclick="syncUR()">
                        ðŸ”„ Sync UR Portal
                    </button>
                    <button class="button sync-button" onclick="syncOffers()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        ðŸ”„ Sincronizza Offerte
                    </button>
                </div>
            </div>
            
            <div class="card" style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px;">ðŸ§¹ Pulizia Dati</h3>
                <p style="color: var(--text-medium); margin-bottom: 16px;">
                    Operazioni di pulizia e normalizzazione dei dati nel database.
                </p>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="button secondary" onclick="cleanAccountNames()">
                        ðŸ§¹ Pulisci Nomi Account
                    </button>
                    <button class="button secondary" onclick="associateAddresses()">
                        ðŸ“ Associa Indirizzi ai Contatti
                    </button>
                    <button class="button secondary" onclick="cleanDuplicateAccounts()">
                        ðŸ”„ Rimuovi Account Duplicati
                    </button>
                    <button class="button secondary" onclick="cleanOrphanedRecords()">
                        ðŸ—‘ï¸ Pulisci Record Orfani
                    </button>
                </div>
            </div>
            
            <div class="card" style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px;">ðŸ“¥ Import Dati CSV</h3>
                <p style="color: var(--text-medium); margin-bottom: 16px;">
                    Importa Lead e OpportunitÃ  da file CSV. Scarica i template per vedere il formato richiesto.
                </p>
                
                <!-- Import Leads -->
                <div style="margin-bottom: 24px; padding: 16px; background: #f9fafb; border-radius: 8px;">
                    <h4 style="margin: 0 0 12px 0; font-size: 16px;">ðŸ“‹ Import Lead</h4>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                        <a href="/api/import/template/leads" class="button secondary" download>
                            ðŸ“¥ Scarica Template Lead
                        </a>
                        <input type="file" id="leads-csv-file" accept=".csv" style="display: none;" onchange="handleLeadsFileSelect(event)">
                        <button class="button" onclick="document.getElementById('leads-csv-file').click()">
                            ðŸ“¤ Seleziona File CSV Lead
                        </button>
                        <span id="leads-file-name" style="color: var(--text-medium); font-size: 13px;"></span>
                        <button class="button" id="import-leads-btn" onclick="importLeadsCSV()" style="display: none;">
                            âœ… Importa Lead
                        </button>
                    </div>
                    <div id="leads-import-result" style="margin-top: 12px; display: none;"></div>
                </div>
                
                <!-- Import Opportunities -->
                <div style="margin-bottom: 24px; padding: 16px; background: #f9fafb; border-radius: 8px;">
                    <h4 style="margin: 0 0 12px 0; font-size: 16px;">ðŸ’¼ Import OpportunitÃ </h4>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                        <a href="/api/import/template/opportunities" class="button secondary" download>
                            ðŸ“¥ Scarica Template OpportunitÃ 
                        </a>
                        <input type="file" id="opportunities-csv-file" accept=".csv" style="display: none;" onchange="handleOpportunitiesFileSelect(event)">
                        <button class="button" onclick="document.getElementById('opportunities-csv-file').click()">
                            ðŸ“¤ Seleziona File CSV OpportunitÃ 
                        </button>
                        <span id="opportunities-file-name" style="color: var(--text-medium); font-size: 13px;"></span>
                        <button class="button" id="import-opportunities-btn" onclick="importOpportunitiesCSV()" style="display: none;">
                            âœ… Importa OpportunitÃ 
                        </button>
                    </div>
                    <div id="opportunities-import-result" style="margin-top: 12px; display: none;"></div>
                </div>
                
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="button secondary" onclick="importContactsFromCSV()">
                        ðŸ“§ Importa Contatti da CSV
                    </button>
                    <button class="button secondary" onclick="importLeadsFromFile()">
                        ðŸ“‹ Importa Leads da File
                    </button>
                </div>
            </div>
            
            <div class="card" style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px;">ðŸ’¾ Backup & Ripristino</h3>
                <p style="color: var(--text-medium); margin-bottom: 16px;">
                    Operazioni di backup e ripristino del database.
                </p>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="button secondary" onclick="backupDatabase()">
                        ðŸ’¾ Crea Backup Database
                    </button>
                    <button class="button secondary" onclick="exportDataToCSV()">
                        ðŸ“Š Esporta Dati in CSV
                    </button>
                    <button class="button secondary" onclick="restoreFromBackup()">
                        ðŸ”„ Ripristina da Backup
                    </button>
                </div>
            </div>
            
            <div class="card" style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px;">ðŸ”§ Manutenzione Database</h3>
                <p style="color: var(--text-medium); margin-bottom: 16px;">
                    Operazioni di manutenzione e ottimizzazione del database.
                </p>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="button secondary" onclick="optimizeDatabase()">
                        âš¡ Ottimizza Database
                    </button>
                    <button class="button secondary" onclick="rebuildIndexes()">
                        ðŸ”¨ Ricostruisci Indici
                    </button>
                    <button class="button secondary" onclick="vacuumDatabase()">
                        ðŸ§¹ Vacuum Database
                    </button>
                </div>
            </div>
            
            <div class="card" style="margin-bottom: 24px;">
                <h3 style="margin-bottom: 16px;">ðŸ“Š Statistiche & Report</h3>
                <p style="color: var(--text-medium); margin-bottom: 16px;">
                    Visualizza statistiche e report sul database.
                </p>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="button secondary" onclick="showDatabaseStats()">
                        ðŸ“Š Statistiche Database
                    </button>
                    <button class="button secondary" onclick="showDataQualityReport()">
                        âœ… Report QualitÃ  Dati
                    </button>
                </div>
            </div>
            
            <div id="setup-log" style="margin-top: 24px; display: none;">
                <div class="card">
                    <h3 style="margin-bottom: 16px;">ðŸ“ Log Operazioni</h3>
                    <div id="setup-log-content" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; background: #f9fafb; padding: 16px; border-radius: 6px;">
                    </div>
                </div>
            </div>
        </section>

        <!-- Products/Listini -->
        <section id="products-view" class="view">
            <div class="hero">
                <div>
                    <h2>Listini Prodotti</h2>
                    <p style="color: var(--text-light);">Gestisci prodotti e prezzi</p>
                </div>
                <div class="hero-actions">
                </div>
            </div>
            <div class="card">
                <input type="text" class="table-search" id="products-search" placeholder="ðŸ” Cerca prodotti..." onkeyup="filterTable('products-table', this.value)">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Codice</th>
                                <th>Nome</th>
                                <th>Categoria</th>
                                <th>Prezzi</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="products-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Email Marketing -->
        <section id="email-marketing-view" class="view">
            <div class="hero">
                <div>
                    <h2>ðŸ“§ Email Marketing</h2>
                    <p style="color: var(--text-light);">Sistema completo per gestire campagne email, liste contatti e template</p>
                </div>
                <div class="hero-actions">
                    <button class="button" onclick="switchEmailTab('compose')">âœ‰ï¸ Componi Email</button>
                    <button class="button secondary" onclick="initEmailTemplates()">ðŸ“¥ Carica Template</button>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div style="display: flex; gap: 12px; margin-bottom: 16px; border-bottom: 2px solid var(--border-color); flex-wrap: wrap;">
                <button class="email-tab-btn active" onclick="switchEmailTab('campaigns')" data-tab="campaigns">ðŸ“¬ Campagne</button>
                <button class="email-tab-btn" onclick="switchEmailTab('lists')" data-tab="lists">ðŸ‘¥ Liste Contatti</button>
                <button class="email-tab-btn" onclick="switchEmailTab('templates')" data-tab="templates">ðŸ“„ Template</button>
                <button class="email-tab-btn" onclick="switchEmailTab('compose')" data-tab="compose">âœ‰ï¸ Componi Email</button>
            </div>
            
            <!-- Tab: Campagne -->
            <div id="email-tab-campaigns" class="email-tab-content active">
            <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>Le tue Campagne Email</h3>
                        <button class="button" onclick="switchEmailTab('compose')">+ Nuova Campagna</button>
                    </div>
                    <input type="text" class="table-search" id="campaign-search" placeholder="ðŸ” Cerca campagne..." onkeyup="filterTable('campaigns-table', this.value)">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Oggetto</th>
                                    <th>Lista</th>
                                    <th>Destinatari</th>
                                    <th>Inviate</th>
                                    <th>Stato</th>
                                    <th>Data</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="campaigns-table">
                                <tr><td colspan="8" style="text-align: center; padding: 40px;">Caricamento...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Liste -->
            <div id="email-tab-lists" class="email-tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>Liste Contatti</h3>
                        <button class="button" onclick="showNewEmailListForm()">+ Nuova Lista</button>
                    </div>
                    
                    <!-- Form Nuova Lista (nascosto) -->
                    <div id="new-email-list-form" style="display: none; margin-bottom: 24px; padding: 20px; background: var(--bg-light); border-radius: 8px;">
                        <h4 style="margin-bottom: 16px;">Crea Nuova Lista</h4>
                        <form id="email-list-form" class="form-grid">
                            <div class="form-group">
                                <label>Nome Lista *</label>
                                <input type="text" id="list-name" name="name" required>
                            </div>
                            <div class="form-group full">
                                <label>Descrizione</label>
                                <textarea id="list-description" name="description" style="min-height: 80px;"></textarea>
                            </div>
                            <div class="form-group full" style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" class="button secondary" onclick="hideNewEmailListForm()">Annulla</button>
                                <button type="submit" class="button">Crea Lista</button>
                            </div>
                        </form>
                    </div>
                    
                    <input type="text" class="table-search" id="lists-search" placeholder="ðŸ” Cerca liste..." onkeyup="filterTable('email-lists-table', this.value)">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Descrizione</th>
                                    <th>Contatti</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="email-lists-table">
                                <tr><td colspan="4" style="text-align: center; padding: 40px;">Caricamento...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Template -->
            <div id="email-tab-templates" class="email-tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>Template Email</h3>
                        <button class="button" onclick="showNewEmailTemplateForm()">+ Nuovo Template</button>
                    </div>
                    
                    <!-- Form Nuovo Template (nascosto) -->
                    <div id="new-email-template-form" style="display: none; margin-bottom: 24px; padding: 20px; background: var(--bg-light); border-radius: 8px;">
                        <h4 style="margin-bottom: 16px;">Crea Nuovo Template</h4>
                        <form id="email-template-form" class="form-grid">
                            <div class="form-group">
                                <label>Nome *</label>
                                <input type="text" id="template-name" name="name" required>
                            </div>
                            <div class="form-group">
                                <label>Oggetto *</label>
                                <input type="text" id="template-subject" name="subject" required>
                            </div>
                            <div class="form-group">
                                <label>Categoria</label>
                                <select id="template-category" name="template_type">
                                    <option value="newsletter">Newsletter</option>
                                    <option value="promotional">Promozionale</option>
                                    <option value="transactional">Transazionale</option>
                                    <option value="other">Altro</option>
                                </select>
                            </div>
                            <div class="form-group full">
                                <label>Contenuto HTML *</label>
                                <textarea id="template-html" name="html_content" style="min-height: 300px; font-family: monospace;" required></textarea>
                                <small style="color: var(--text-light);">Variabili disponibili: %nome%, %first_name%, %last_name%</small>
                            </div>
                            <div class="form-group full" style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button type="button" class="button secondary" onclick="hideNewEmailTemplateForm()">Annulla</button>
                                <button type="submit" class="button">Salva Template</button>
                            </div>
                        </form>
                    </div>
                    
                    <input type="text" class="table-search" id="templates-search" placeholder="ðŸ” Cerca template..." onkeyup="filterTable('email-templates-table', this.value)">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Categoria</th>
                                    <th>Oggetto</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="email-templates-table">
                                <tr><td colspan="4" style="text-align: center; padding: 40px;">Caricamento...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Tab: Componi -->
            <div id="email-tab-compose" class="email-tab-content">
                <div class="card">
                    <h3 style="margin-bottom: 16px;">Componi Nuova Email</h3>
                    <form id="compose-email-form" class="form-grid">
                        <div class="form-group">
                            <label>Nome Campagna *</label>
                            <input type="text" id="compose-campaign-name" name="campaign_name" required>
                        </div>
                        <div class="form-group full">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="margin: 0;">Destinatari (Seleziona una o piÃ¹ liste) *</label>
                                <div style="display: flex; gap: 8px;">
                                    <button type="button" class="button secondary" onclick="selectAllLists()" style="padding: 4px 12px; font-size: 12px;">âœ“ Seleziona Tutto</button>
                                    <button type="button" class="button secondary" onclick="deselectAllLists()" style="padding: 4px 12px; font-size: 12px;">âœ— Deseleziona Tutto</button>
                                </div>
                            </div>
                            <div id="compose-lists-container" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; background: var(--bg-light);">
                                <div style="text-align: center; padding: 20px; color: var(--text-light);">Caricamento liste...</div>
                            </div>
                            <small id="recipient-count" style="color: var(--text-light); display: block; margin-top: 8px; font-weight: 500;"></small>
                            <small style="color: var(--text-light); display: block; margin-top: 4px;">Seleziona almeno una lista per continuare</small>
                        </div>
                        <div class="form-group">
                            <label>Oggetto Email *</label>
                            <input type="text" id="compose-subject" name="subject" required>
                        </div>
                        <div class="form-group">
                            <label>Usa Template (opzionale)</label>
                            <select id="compose-template-id" name="template_id" onchange="loadTemplateIntoComposer()">
                                <option value="">Nessun template</option>
                            </select>
                        </div>
                        <div class="form-group full">
                            <label>Contenuto HTML *</label>
                            <div style="margin-bottom: 8px;">
                                <button type="button" class="button secondary" onclick="insertVariable('%nome%')" style="padding: 4px 8px; font-size: 12px; margin-right: 4px;">%nome%</button>
                                <button type="button" class="button secondary" onclick="insertVariable('%first_name%')" style="padding: 4px 8px; font-size: 12px; margin-right: 4px;">%first_name%</button>
                                <button type="button" class="button secondary" onclick="insertVariable('%last_name%')" style="padding: 4px 8px; font-size: 12px;">%last_name%</button>
                            </div>
                            <textarea id="compose-html-content" name="html_content" style="min-height: 400px; font-family: 'Courier New', monospace;" required></textarea>
                            <small style="color: var(--text-light); display: block; margin-top: 4px;">Clicca sui pulsanti sopra per inserire variabili personalizzate</small>
                        </div>
                        <div class="form-group full" style="display: flex; gap: 12px; justify-content: flex-end; flex-wrap: wrap;">
                            <button type="button" class="button secondary" onclick="previewComposedEmail()">ðŸ‘ï¸ Anteprima</button>
                            <button type="button" class="button secondary" onclick="sendTestEmail()">ðŸ“§ Test Email</button>
                            <button type="button" class="button secondary" onclick="saveCampaignAsDraft()">ðŸ’¾ Salva Bozza</button>
                            <button type="submit" class="button">ðŸš€ Crea Campagna</button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Offer Generator - Sviluppi Futuri -->
        <section id="offers-view" class="view">
            <div class="hero">
                <div>
                    <h2>ðŸ”® Offer Generator</h2>
                    <p style="color: var(--text-light);">FunzionalitÃ  in sviluppo - Disponibile a breve</p>
                </div>
            </div>
            
            <div class="card" style="border-left: 4px solid var(--warning);">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <span style="font-size: 24px;">âš ï¸</span>
                    <div>
                        <h3 style="margin: 0; color: var(--warning);">FunzionalitÃ  in Sviluppo</h3>
                        <p style="margin: 4px 0 0 0; color: var(--text-light); font-size: 14px;">
                            Questa funzionalitÃ  Ã¨ attualmente in fase di sviluppo e sarÃ  disponibile nelle prossime versioni.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="card" style="opacity: 0.7;">
                <h3 style="margin-bottom: 16px;">Genera Nuova Offerta</h3>
                <form id="offer-form" class="form-grid">
                    <div class="form-group full">
                        <label>Richiesta in Linguaggio Naturale *</label>
                        <textarea name="request" placeholder="Es: due unitree G1 bronze per cliente XYZ" required disabled></textarea>
                    </div>
                    <div class="form-group">
                        <label>Nome Cliente</label>
                        <input type="text" name="client_name" disabled>
                    </div>
                    <div class="form-group full" style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="submit" class="button" disabled>ðŸš€ Genera Offerta (Disabilitato)</button>
                    </div>
                </form>
                <div id="offer-status" style="margin-top: 16px;"></div>
            </div>
            
            <div class="card" style="opacity: 0.7;">
                <h3 style="margin-bottom: 16px;">Offerte Generate</h3>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Numero</th>
                                <th>Cliente</th>
                                <th>Valore</th>
                                <th>Data</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="offers-table"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Impostazioni -->
        <section id="settings-view" class="view">
            <div class="hero">
                <div>
                    <h2>âš™ï¸ Impostazioni</h2>
                    <p style="color: var(--text-medium);">Configura l'accesso al server per aprire i file delle offerte</p>
                </div>
            </div>
            
            <div class="card" style="max-width: 800px;">
                <h3 style="margin-bottom: 24px; color: var(--text-dark);">ðŸ–¥ï¸ Configurazione Server</h3>
                <p style="color: var(--text-medium); margin-bottom: 24px; font-size: 14px;">
                    Configura l'accesso al server condiviso per aprire i file delle offerte direttamente dal browser.
                    I file non vengono copiati sul server AWS, ma vengono aperti tramite condivisione di rete.
                    <strong style="color: var(--primary);">Valori di default: IP=192.168.10.240, Share=commerciale (stessi per tutti i PC della subnet)</strong>
                </p>
                
                <form id="local-pc-config-form" style="display: grid; gap: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">
                            IP del Server *
                        </label>
                        <input type="text" id="local-pc-ip" placeholder="192.168.10.240" 
                               style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                        <small style="color: var(--text-light); font-size: 12px; margin-top: 4px; display: block;">
                            Indirizzo IP del server condiviso (default: 192.168.10.240 - stesso per tutti i PC della subnet)
                        </small>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">
                            Nome Condivisione *
                        </label>
                        <input type="text" id="local-pc-share" placeholder="commerciale" 
                               style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                        <small style="color: var(--text-light); font-size: 12px; margin-top: 4px; display: block;">
                            Nome della condivisione di rete (default: "commerciale" - stesso per tutti i PC della subnet)
                        </small>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">
                            Percorso Base
                        </label>
                        <input type="text" id="local-pc-base-path" placeholder="OFFERTE - K" 
                               style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                        <small style="color: var(--text-light); font-size: 12px; margin-top: 4px; display: block;">
                            Percorso base relativo alla condivisione (es. "OFFERTE - K"). Lascia vuoto se le offerte sono nella root della condivisione.
                        </small>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">
                            Username (Opzionale)
                        </label>
                        <input type="text" id="local-pc-username" placeholder="username" 
                               style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                        <small style="color: var(--text-light); font-size: 12px; margin-top: 4px; display: block;">
                            Username per autenticazione SMB (lascia vuoto se non necessario)
                        </small>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dark);">
                            Password (Opzionale)
                        </label>
                        <input type="password" id="local-pc-password" placeholder="password" 
                               style="width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px;">
                        <small style="color: var(--text-light); font-size: 12px; margin-top: 4px; display: block;">
                            Password per autenticazione SMB (lascia vuoto se non necessario)
                        </small>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 8px;">
                        <button type="submit" class="button" style="flex: 1;">ðŸ’¾ Salva Configurazione</button>
                        <button type="button" class="button secondary" onclick="testLocalPcConnection()">ðŸ” Test Connessione</button>
                    </div>
                </form>
                
                <div id="local-pc-config-status" style="margin-top: 24px; padding: 16px; border-radius: 8px; display: none;"></div>
            </div>
        </section>
    </main>

    <!-- Modal Modifica Prezzi -->
    <div id="price-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Modifica Prezzi - <span id="modal-product-name"></span></h3>
                <button class="close-modal" onclick="closePriceModal()">&times;</button>
            </div>
            <div id="modal-price-inputs"></div>
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                <button class="button secondary" onclick="closePriceModal()">Annulla</button>
                <button class="button" onclick="savePrices()">Salva Modifiche</button>
            </div>
        </div>
    </div>

    <script>
        let currentProduct = null;
        const views = document.querySelectorAll('.view');
        const navItems = document.querySelectorAll('.nav-item[data-target]');

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                navItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                const target = item.getAttribute('data-target');
                views.forEach(view => view.classList.toggle('active', view.id === target));
                if (target === 'products-view') loadProducts();
                if (target === 'dashboard-view') loadDashboard();
                if (target === 'my-tasks-view') loadMyTasks();
                if (target === 'leads-view') loadLeads(1);
                if (target === 'accounts-view') loadAccounts(1);
                if (target === 'opportunities-view') loadOpportunities(1);
                if (target === 'offers-view') loadOffers();
                if (target === 'email-marketing-view') loadEmailMarketing();
                if (target === 'tickets-view') loadTickets();
                if (target === 'map-view') {
                    // Inizializza mappa quando si entra nella vista
                    setTimeout(() => {
                        if (!map) {
                            initMap();
                        } else {
                            // Se la mappa esiste giÃ , ricarica solo i dati
                            loadMapData();
                        }
                    }, 100);
                }
                if (target === 'setup-view') {
                    // Setup view non richiede caricamento dati
                }
            });
        });

        // Gestione Configurazione Server
        async function loadLocalPcConfig() {
            try {
                const response = await fetch('/api/user/local-pc-config');
                if (!response.ok) throw new Error('Errore caricamento configurazione');
                
                const data = await response.json();
                
                // Usa valori di default se vuoti
                document.getElementById('local-pc-ip').value = data.local_pc_ip || data.default_ip || '192.168.10.240';
                document.getElementById('local-pc-share').value = data.local_pc_share || data.default_share || 'commerciale';
                document.getElementById('local-pc-base-path').value = data.local_pc_base_path || '';
                document.getElementById('local-pc-username').value = data.local_pc_username || '';
                // Password non viene mostrata per sicurezza
                
                // Mostra se sta usando valori di default
                if (data.is_using_default) {
                    const statusDiv = document.getElementById('local-pc-config-status');
                    if (statusDiv) {
                        statusDiv.innerHTML = '<div style="padding: 12px; background: #e7f3ff; border: 1px solid #2196F3; border-radius: 6px; color: #1976D2; font-size: 13px;">ðŸ’¡ Stai usando i valori di default (192.168.10.240 / commerciale). Puoi modificarli se necessario.</div>';
                        statusDiv.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Errore caricamento configurazione:', error);
                // In caso di errore, imposta valori di default
                document.getElementById('local-pc-ip').value = '192.168.10.240';
                document.getElementById('local-pc-share').value = 'commerciale';
            }
        }
        
        // Attendi che il DOM sia caricato prima di aggiungere l'event listener
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('local-pc-config-form');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = {
                        local_pc_ip: document.getElementById('local-pc-ip').value.trim(),
                        local_pc_share: document.getElementById('local-pc-share').value.trim(),
                        local_pc_base_path: document.getElementById('local-pc-base-path').value.trim(),
                        local_pc_username: document.getElementById('local-pc-username').value.trim(),
                        local_pc_password: document.getElementById('local-pc-password').value
                    };
                    
                    // Usa valori di default se vuoti
                    if (!formData.local_pc_ip) {
                        formData.local_pc_ip = '192.168.10.240';
                    }
                    if (!formData.local_pc_share) {
                        formData.local_pc_share = 'commerciale';
                    }
                    
                    try {
                        const response = await fetch('/api/user/local-pc-config', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            const statusDiv = document.getElementById('local-pc-config-status');
                            statusDiv.style.display = 'block';
                            statusDiv.style.background = '#d4edda';
                            statusDiv.style.border = '1px solid #c3e6cb';
                            statusDiv.style.color = '#155724';
                            statusDiv.innerHTML = 'âœ… Configurazione salvata con successo!';
                            
                            // Pulisci campo password
                            document.getElementById('local-pc-password').value = '';
                            
                            setTimeout(() => {
                                statusDiv.style.display = 'none';
                            }, 3000);
                        } else {
                            throw new Error(data.error || 'Errore nel salvataggio');
                        }
                    } catch (error) {
                        const statusDiv = document.getElementById('local-pc-config-status');
                        statusDiv.style.display = 'block';
                        statusDiv.style.background = '#f8d7da';
                        statusDiv.style.border = '1px solid #f5c6cb';
                        statusDiv.style.color = '#721c24';
                        statusDiv.innerHTML = `âŒ Errore: ${error.message}`;
                    }
                });
            }
        });
        
        async function testLocalPcConnection() {
            const ip = document.getElementById('local-pc-ip').value.trim();
            const share = document.getElementById('local-pc-share').value.trim();
            
            if (!ip || !share) {
                alert('âš ï¸ Inserisci IP e Nome Condivisione per testare la connessione');
                return;
            }
            
            const statusDiv = document.getElementById('local-pc-config-status');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fff3cd';
            statusDiv.style.border = '1px solid #ffc107';
            statusDiv.style.color = '#856404';
            statusDiv.innerHTML = 'ðŸ” Test connessione in corso...';
            
            // Test semplice: prova a costruire il link SMB
            const smbPath = `\\\\${ip}\\${share}`;
            statusDiv.innerHTML = `
                <div style="margin-bottom: 8px;"><strong>Test Connessione:</strong></div>
                <div style="font-family: monospace; background: white; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                    ${smbPath}
                </div>
                <div style="font-size: 12px;">
                    ðŸ’¡ Per testare, prova ad aprire questo percorso in Esplora File di Windows:<br>
                    <code style="background: white; padding: 4px 8px; border-radius: 4px; display: inline-block; margin-top: 4px;">${smbPath}</code>
                </div>
            `;
        }

        let chartTimeline, chartCategorie, chartStati;

        async function loadDashboard() {
            try {
                // Mostra spinner di caricamento
                const container = document.getElementById('dashboard-metrics');
                if (container) {
                    container.innerHTML = `
                        <div style="display: flex; justify-content: center; align-items: center; padding: 60px; width: 100%;">
                            <div style="text-align: center;">
                                <div class="spinner" style="width: 48px; height: 48px; border: 4px solid var(--border-color); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                                <div style="color: var(--text-medium); font-size: 14px;">Caricamento dashboard...</div>
                            </div>
                        </div>
                    `;
                }
                
                const res = await fetch('/api/dashboard/summary');
                const data = await res.json();
                if (!container) return;
                
                const leads = data.metrics?.leads || 0;
                const accounts = data.metrics?.accounts || 0;
                const opportunities = data.metrics?.opportunities || 0;
                const pipeline = data.metrics?.pipeline || 0;
                const closedWon = data.metrics?.closed_won || 0;
                const closedCount = data.metrics?.closed_count || 0;
                
                // Calcola i valori formattati PRIMA di inserirli nel template
                const pipelineFormatted = Number(pipeline).toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                const closedWonFormatted = Number(closedWon).toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                container.innerHTML = `
                    <div class="card">
                        <div style="font-size: 32px; font-weight: 700; color: var(--primary);">${leads}</div>
                        <div style="color: var(--text-light);">Leads</div>
                    </div>
                    <div class="card">
                        <div style="font-size: 32px; font-weight: 700; color: var(--primary);">${accounts}</div>
                        <div style="color: var(--text-light);">Accounts</div>
                    </div>
                    <div class="card">
                        <div style="font-size: 32px; font-weight: 700; color: var(--primary);">${opportunities}</div>
                        <div style="color: var(--text-light);">OpportunitÃ </div>
                    </div>
                    <div class="card">
                        <div style="font-size: 32px; font-weight: 700; color: var(--primary);">â‚¬${pipelineFormatted}</div>
                        <div style="color: var(--text-light);">Pipeline</div>
                        <div style="font-size: 12px; color: var(--success); margin-top: 4px;">Chiusi: â‚¬${closedWonFormatted} (${closedCount})</div>
                    </div>
                `;
                
                // Carica grafici
                await loadDashboardCharts(data);
                
                // Carica leaderboard
                loadLeaderboard(data.leaderboard || []);
                
                // Carica opportunitÃ  recenti
                await loadRecentOpportunities();
                
            } catch (err) {
                console.error('Errore caricamento dashboard:', err);
                const container = document.getElementById('dashboard-metrics');
                if (container) {
                    const errorMsg = err && err.message ? String(err.message).replace(/`/g, '\\`').replace(/\${/g, '\\${') : 'Errore sconosciuto';
                    container.innerHTML = `
                        <div class="card" style="grid-column: 1 / -1; border-left: 4px solid var(--danger);">
                            <div style="color: var(--danger); font-weight: 600;">âŒ Errore caricamento dashboard</div>
                            <div style="color: var(--text-light); font-size: 12px; margin-top: 4px;">${errorMsg}</div>
                        </div>
                    `;
                }
            }
        }
        
        async function loadDashboardCharts(dashboardData) {
            try {
                // Carica dati analytics
                const res = await fetch('/api/analytics/pipeline?period=month');
                if (!res.ok) {
                    console.error('Errore caricamento analytics:', res.status, res.statusText);
                    // Mostra messaggio di errore nei grafici
                    const chartContainer = document.getElementById('chart-timeline');
                    if (chartContainer && chartContainer.parentElement) {
                        chartContainer.parentElement.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-medium);">Errore nel caricamento dei grafici. Riprova piÃ¹ tardi.</div>';
                    }
                    return;
                }
                const analyticsData = await res.json();
                
                if (analyticsData.error) {
                    console.error('Errore analytics:', analyticsData.error);
                    return;
                }
                
                // Grafico Timeline
                if (analyticsData.data && analyticsData.data.length > 0) {
                    const labels = analyticsData.data.map(d => d.period);
                    const datasets = [
                        {
                            label: 'MIR',
                            data: analyticsData.data.map(d => d.MIR?.open || 0),
                            borderColor: '#1976d2',
                            backgroundColor: 'rgba(25, 118, 210, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'UR',
                            data: analyticsData.data.map(d => d.UR?.open || 0),
                            borderColor: '#7b1fa2',
                            backgroundColor: 'rgba(123, 31, 162, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Unitree',
                            data: analyticsData.data.map(d => d.Unitree?.open || 0),
                            borderColor: '#388e3c',
                            backgroundColor: 'rgba(56, 142, 60, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ];
                    
                    if (chartTimeline) chartTimeline.destroy();
                    chartTimeline = new Chart(document.getElementById('chart-timeline'), {
                        type: 'line',
                        data: { labels, datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom' },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => ctx.dataset.label + ': â‚¬' + ctx.parsed.y.toLocaleString('it-IT')
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return 'â‚¬' + value.toLocaleString('it-IT');
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Grafico Categorie (doughnut)
                const categorieData = {};
                if (analyticsData.data) {
                    analyticsData.data.forEach(period => {
                        Object.keys(period).forEach(key => {
                            if (key !== 'period' && period[key]) {
                                if (!categorieData[key]) categorieData[key] = 0;
                                categorieData[key] += (period[key].open || 0);
                            }
                        });
                    });
                }
                
                const catLabels = Object.keys(categorieData).filter(k => categorieData[k] > 0);
                const catValues = catLabels.map(k => categorieData[k]);
                
                if (chartCategorie) chartCategorie.destroy();
                chartCategorie = new Chart(document.getElementById('chart-categorie'), {
                    type: 'doughnut',
                    data: {
                        labels: catLabels,
                        datasets: [{
                            data: catValues,
                            backgroundColor: [
                                '#1976d2', '#7b1fa2', '#388e3c', '#f57c00', '#c2185b', '#00796b'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: {
                                callbacks: {
                                    label: ctx => ctx.label + ': â‚¬' + ctx.parsed.toLocaleString('it-IT')
                                }
                            }
                        }
                    }
                });
                
                // Grafico Stati - usa traduzioni italiane
                const stageTranslations = {
                    'Qualification': 'ðŸ“‹ Qualificazione',
                    'Needs Analysis': 'ðŸ” Analisi NecessitÃ ',
                    'Value Proposition': 'ðŸ’Ž Proposta di Valore',
                    'Id. Decision Makers': 'ðŸ‘¥ Identificazione Decision Maker',
                    'Perception Analysis': 'ðŸŽ¯ Analisi Percezione',
                    'Proposal/Price Quote': 'ðŸ“„ Offerta/Preventivo',
                    'Negotiation/Review': 'ðŸ¤ Negoziazione/Revisione',
                    'Closed Won': 'âœ… Chiusa Vinta',
                    'Closed Lost': 'âŒ Chiusa Persa'
                };
                
                const resOpps = await fetch('/api/opportunities?limit=10000');
                const oppsData = await resOpps.json();
                
                const statiCount = {};
                if (oppsData.opportunities) {
                    oppsData.opportunities.forEach(opp => {
                        const stage = opp.stage || 'Qualification';
                        statiCount[stage] = (statiCount[stage] || 0) + 1;
                    });
                }
                
                const statiLabels = Object.keys(statiCount).map(s => stageTranslations[s] || s);
                const statiValues = Object.values(statiCount);
                
                if (statiLabels.length === 0) {
                    console.warn('Nessun dato disponibile per grafico stati');
                    document.getElementById('chart-stati').parentElement.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-light);">Nessun dato disponibile</div>';
                } else {
                    if (chartStati) chartStati.destroy();
                    chartStati = new Chart(document.getElementById('chart-stati'), {
                        type: 'pie',
                        data: {
                        labels: statiLabels,
                        datasets: [{
                            data: statiValues,
                            backgroundColor: [
                                '#e4e6eb', '#ffc107', '#28a745', '#dc3545', '#007bff', '#17a2b8', '#6c757d', '#fd7e14', '#20c997'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                    });
                }
                
                // Mostra conteggio opportunitÃ  per stato di calore
                if (analyticsData.heat_counts) {
                    const heatContainer = document.getElementById('heat-counts-container');
                    if (heatContainer) {
                        const heatLabels = {
                            'calda': 'ðŸ”´ Calde (50%)',
                            'tiepida': 'ðŸŸ¡ Tiepide (15%)',
                            'fredda_speranza': 'ðŸ”µ Fredde con Speranza (5%)',
                            'fredda_gelo': 'âšª Fredde Gelo (0%)',
                            'da_categorizzare': 'âš« Da Categorizzare (0%)'
                        };
                        
                        let html = '<div style="padding: 16px; background: var(--bg-light); border-radius: 8px; margin-top: 16px;"><h3 style="margin-bottom: 12px; font-size: 14px; font-weight: 600;">ðŸ“Š OpportunitÃ  in Pipeline per Stato:</h3>';
                        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">';
                        
                        Object.keys(heatLabels).forEach(heat => {
                            const count = analyticsData.heat_counts[heat] || 0;
                            html += `<div style="padding: 8px; background: white; border-radius: 6px; border-left: 4px solid ${heat === 'calda' ? '#ef4444' : heat === 'tiepida' ? '#f59e0b' : heat === 'fredda_speranza' ? '#3b82f6' : heat === 'fredda_gelo' ? '#64748b' : '#a855f7'};">
                                <div style="font-weight: 600; font-size: 12px;">${heatLabels[heat]}</div>
                                <div style="font-size: 18px; font-weight: 700; color: var(--primary); margin-top: 4px;">${count}</div>
                            </div>`;
                        });
                        
                        html += `</div><div style="margin-top: 12px; padding: 8px; background: var(--primary); color: white; border-radius: 6px; text-align: center; font-weight: 600;">
                            Totale in Pipeline: ${analyticsData.total_in_pipeline || 0} opportunitÃ 
                        </div></div>`;
                        
                        heatContainer.innerHTML = html;
                    }
                }
                
            } catch (err) {
                console.error('Errore caricamento grafici:', err);
            }
        }
        
        function loadLeaderboard(leaderboard) {
            const container = document.getElementById('leaderboard-container');
            if (!leaderboard || leaderboard.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-light);">Nessun dato disponibile</div>';
                return;
            }
            
            container.innerHTML = leaderboard.map((user, idx) => {
                const pipelineFormatted = Number(user.pipeline || 0).toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border-color);">
                    <div>
                        <div style="font-weight: 600;">${idx + 1}. ${user.name}</div>
                        <div style="font-size: 12px; color: var(--text-light);">${user.opportunities} opportunitÃ </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: 700; color: var(--primary);">â‚¬${pipelineFormatted}</div>
                        <div style="font-size: 12px; color: var(--success);">${user.closed_count} chiusi</div>
                    </div>
                </div>
            `;
            }).join('');
        }
        
        async function updateLeadDate(leadId, field, value) {
            try {
                const res = await fetch(`/api/leads/${leadId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: value || null })
                });
                const data = await res.json();
                if (data.success) {
                    // Aggiorna il lead nella lista locale
                    const lead = allLeads.find(l => l.id === leadId);
                    if (lead) {
                        lead[field] = value || null;
                    }
                } else {
                    alert('Errore aggiornamento data: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        async function updateOpportunityStage(oppId, stage) {
            try {
                const res = await fetch(`/api/opportunities/${oppId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stage: stage })
                });
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}` }));
                    throw new Error(errorData.error || `HTTP ${res.status}`);
                }
                
                const data = await res.json();
                if (data.success) {
                    // Aggiorna localmente per feedback immediato
                    const opp = allOpportunities.find(o => o.id === oppId);
                    if (opp) {
                        opp.stage = stage;
                    }
                    renderOpportunities();
                    loadDashboard(); // Ricarica dashboard per aggiornare grafici
                } else {
                    throw new Error(data.error || 'Errore sconosciuto');
                }
            } catch (err) {
                console.error('Errore aggiornamento stage:', err);
                alert('Errore: ' + err.message);
            }
        }
        
        async function updateOpportunityCategory(oppId, category) {
            try {
                const res = await fetch(`/api/opportunities/${oppId}/update-category`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ supplier_category: category })
                });
                const data = await res.json();
                if (data.success) {
                    // Aggiorna localmente
                    const opp = allOpportunities.find(o => o.id === oppId);
                    if (opp) {
                        opp.supplier_category = category;
                    }
                    renderOpportunities();
                    loadDashboard(); // Ricarica dashboard per aggiornare grafici
                } else {
                    alert('Errore: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        async function updateOpportunityDate(oppId, field, value) {
            try {
                const res = await fetch(`/api/opportunities/${oppId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: value || null })
                });
                const data = await res.json();
                if (data.success) {
                    // Aggiorna l'opportunitÃ  nella lista locale
                    const opp = allOpportunities.find(o => o.id === oppId);
                    if (opp) {
                        opp[field] = value || null;
                    }
                } else {
                    alert('Errore aggiornamento data: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        async function changeOpportunityCategory(oppId) {
            const opp = allOpportunities.find(o => o.id === oppId);
            if (!opp) return;
            
            const currentCat = opp.supplier_category || '';
            const newCat = prompt(`Cambia categoria per "${opp.name}"\n\nCategoria attuale: ${currentCat || 'Nessuna'}\n\nInserisci nuova categoria (MiR, Universal Robots, Unitree, o combinazioni separate da virgola):`, currentCat);
            
            if (newCat === null) return; // Utente ha annullato
            
            try {
                const res = await fetch(`/api/opportunities/${oppId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ supplier_category: newCat.trim() || null })
                });
                const data = await res.json();
                if (data.success) {
                    opp.supplier_category = newCat.trim() || null;
                    renderOpportunities();
                    loadDashboard(); // Ricarica dashboard per aggiornare grafici
                } else {
                    alert('Errore: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        async function takeOpportunityOwnership(oppId) {
            if (!confirm('Vuoi prendere la proprietÃ  di questa opportunitÃ ?')) return;
            
            try {
                const res = await fetch(`/api/opportunities/${oppId}/take-ownership`, {
                    method: 'POST'
                });
                const data = await res.json();
                if (data.success) {
                    alert('âœ… ProprietÃ  dell\'opportunitÃ  presa con successo!');
                    loadOpportunities();
                    loadDashboard(); // Ricarica dashboard per aggiornare leaderboard
                } else {
                    alert('Errore: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        let currentCloseOppId = null;
        let selectedCloseStatus = null;
        
        function showCloseOpportunityModal(oppId) {
            currentCloseOppId = oppId;
            selectedCloseStatus = null;
            document.getElementById('close-opportunity-modal').style.display = 'flex';
            document.getElementById('lost-reason-container').style.display = 'none';
            document.getElementById('won-details-container').style.display = 'none';
            document.getElementById('lost-reason-input').value = '';
            document.getElementById('closed-amount-input').value = '';
            document.getElementById('margin-input').value = '';
            document.getElementById('close-date-input').value = new Date().toISOString().split('T')[0];
            
            // Reset button styles
            document.getElementById('close-won-btn').style.background = 'white';
            document.getElementById('close-won-btn').style.color = 'var(--success)';
            document.getElementById('close-lost-btn').style.background = 'white';
            document.getElementById('close-lost-btn').style.color = 'var(--danger)';
            
            // Carica valore attuale dell'opportunitÃ  se disponibile
            const opp = allOpportunities.find(o => o.id === oppId);
            if (opp && opp.amount > 0) {
                document.getElementById('closed-amount-input').value = opp.amount;
            }
        }
        
        function closeCloseOpportunityModal() {
            document.getElementById('close-opportunity-modal').style.display = 'none';
            currentCloseOppId = null;
            selectedCloseStatus = null;
        }
        
        function selectCloseStatus(status) {
            selectedCloseStatus = status;
            
            if (status === 'won') {
                document.getElementById('close-won-btn').style.background = 'var(--success)';
                document.getElementById('close-won-btn').style.color = 'white';
                document.getElementById('close-lost-btn').style.background = 'white';
                document.getElementById('close-lost-btn').style.color = 'var(--danger)';
                document.getElementById('lost-reason-container').style.display = 'none';
                document.getElementById('lost-reason-input').value = '';
                document.getElementById('won-details-container').style.display = 'block';
                document.getElementById('closed-amount-input').value = '';
                document.getElementById('margin-input').value = '';
            } else {
                document.getElementById('close-lost-btn').style.background = 'var(--danger)';
                document.getElementById('close-lost-btn').style.color = 'white';
                document.getElementById('close-won-btn').style.background = 'white';
                document.getElementById('close-won-btn').style.color = 'var(--success)';
                document.getElementById('lost-reason-container').style.display = 'block';
                document.getElementById('won-details-container').style.display = 'none';
            }
        }
        
        async function confirmCloseOpportunity() {
            if (!selectedCloseStatus) {
                alert('âš ï¸ Seleziona se l\'opportunitÃ  Ã¨ Vinta o Persa');
                return;
            }
            
            if (selectedCloseStatus === 'lost') {
                const reason = document.getElementById('lost-reason-input').value.trim();
                if (!reason) {
                    alert('âš ï¸ Inserisci la motivazione della chiusura persa');
                    return;
                }
            }
            
            try {
                const newStage = selectedCloseStatus === 'won' ? 'Closed Won' : 'Closed Lost';
                const closeDate = document.getElementById('close-date-input').value;
                const lostReason = selectedCloseStatus === 'lost' ? document.getElementById('lost-reason-input').value.trim() : null;
                
                const updateData = {
                    stage: newStage,
                    close_date: closeDate,
                    lost_reason: lostReason
                };
                
                // Se chiusa come vinta, aggiungi valore chiusura e margine
                if (selectedCloseStatus === 'won') {
                    const closedAmount = parseFloat(document.getElementById('closed-amount-input').value);
                    const margin = parseFloat(document.getElementById('margin-input').value);
                    
                    if (closedAmount > 0) {
                        updateData.amount = closedAmount; // Aggiorna anche il valore dell'opportunitÃ 
                    }
                    
                    // Aggiorna anche le offerte associate
                    const oppResponse = await fetch(`/api/opportunities/${currentCloseOppId}`);
                    const oppData = await oppResponse.json();
                    
                    if (oppData.success && oppData.opportunity.offers) {
                        // Aggiorna ogni offerta associata
                        for (const offer of oppData.opportunity.offers) {
                            const offerUpdate = {
                                status: 'accepted',
                                closed_amount: closedAmount > 0 ? closedAmount : null
                            };
                            
                            // Calcola margine se fornito o se abbiamo amount originale
                            if (!isNaN(margin) && margin !== 0) {
                                offerUpdate.margin = margin;
                            } else if (closedAmount > 0 && offer.amount > 0) {
                                offerUpdate.margin = ((closedAmount - offer.amount) / offer.amount) * 100;
                            }
                            
                            await fetch(`/api/offers/${offer.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(offerUpdate)
                            });
                        }
                    }
                }
                
                const res = await fetch(`/api/opportunities/${currentCloseOppId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                const data = await res.json();
                if (data.success) {
                    const statusText = selectedCloseStatus === 'won' ? 'VINTA' : 'PERSA';
                    alert(`âœ… OpportunitÃ  chiusa come ${statusText}!`);
                    closeCloseOpportunityModal();
                    loadOpportunities();
                    loadDashboard(); // Ricarica dashboard per aggiornare metriche
                } else {
                    alert('Errore: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        async function reopenOpportunity(oppId) {
            if (!confirm('Vuoi riaprire questa opportunitÃ ?')) return;
            
            try {
                const res = await fetch(`/api/opportunities/${oppId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stage: 'Qualification'
                    })
                });
                const data = await res.json();
                if (data.success) {
                    alert('âœ… OpportunitÃ  riaperta!');
                    loadOpportunities();
                    loadDashboard(); // Ricarica dashboard per aggiornare metriche
                } else {
                    alert('Errore: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        async function loadRecentOpportunities() {
            try {
                const res = await fetch('/api/opportunities?limit=10&sort=created_at');
                const data = await res.json();
                const tbody = document.getElementById('recent-opportunities-table');
                
                if (!data.opportunities || data.opportunities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">Nessuna opportunitÃ </td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.opportunities.map(opp => {
                    const stageColors = {
                        'Qualification': 'blue',
                        'Proposal': 'amber',
                        'Negotiation': 'orange',
                        'Closed Won': 'green',
                        'Closed Lost': 'red'
                    };
                    const stageColor = stageColors[opp.stage] || 'blue';
                    
                    const amountFormatted = Number(opp.amount || 0).toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    return `
                        <tr>
                            <td><strong>${opp.name || 'Senza nome'}</strong></td>
                            <td>${opp.account_name || '-'}</td>
                            <td><span class="tag ${stageColor}">${opp.stage || 'Qualification'}</span></td>
                            <td>â‚¬${amountFormatted}</td>
                            <td>${opp.probability || 0}%</td>
                            <td>${opp.created_at ? new Date(opp.created_at).toLocaleDateString('it-IT') : '-'}</td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                console.error('Errore caricamento opportunitÃ  recenti:', err);
            }
        }

        let leadsSearchTimeout = null;
        let isSearchingLeads = false;
        
        async function searchLeads() {
            const searchTerm = document.getElementById('leads-search')?.value.trim() || '';
            
            // Se c'Ã¨ un termine di ricerca, usa l'API per cercare su TUTTE le pagine
            if (searchTerm.length >= 2) {
                clearTimeout(leadsSearchTimeout);
                leadsSearchTimeout = setTimeout(async () => {
                    if (isSearchingLeads) return;
                    isSearchingLeads = true;
                    
                    try {
                        const res = await fetch(`/api/leads/search-all?q=${encodeURIComponent(searchTerm)}&page=1&per_page=50`);
                        const data = await res.json();
                        
                        if (data.error) {
                            console.error('Errore ricerca:', data.error);
                            return;
                        }
                        
                        // Aggiorna allLeads con i risultati della ricerca
                        allLeads = data.leads || [];
                        leadsPagination = data.pagination || null;
                        
                        // Renderizza i risultati
                        renderLeads();
                        renderLeadsPagination();
                    } catch (err) {
                        console.error('Errore ricerca leads:', err);
                    } finally {
                        isSearchingLeads = false;
                    }
                }, 300); // Debounce 300ms
            } else if (searchTerm.length === 0) {
                // Se il campo Ã¨ vuoto, ricarica la pagina corrente normale
                clearTimeout(leadsSearchTimeout);
                const currentPage = currentLeadsPage || 1;
                await loadLeads(currentPage);
            } else {
                // Meno di 2 caratteri, mostra messaggio
                renderLeads();
            }
        }
        
        function renderLeads() {
                const tbody = document.getElementById('leads-table');
            let filtered = allLeads;
            
            if (currentLeadTab !== 'all') {
                if (['MIR', 'UR', 'Unitree'].includes(currentLeadTab)) {
                    filtered = allLeads.filter(l => l.interest === currentLeadTab);
                } else {
                    filtered = allLeads.filter(l => l.source === currentLeadTab);
                }
            }
            
            if (!filtered.length) {
                tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 40px;">Nessun lead ${currentLeadTab !== 'all' ? `per ${currentLeadTab}` : ''}.</td></tr>`;
                    return;
                }
                
            tbody.innerHTML = filtered.map(l => {
                const createdDate = l.created_at ? new Date(l.created_at).toISOString().split('T')[0] : '';
                const lastContactDate = l.last_contact_at ? new Date(l.last_contact_at).toISOString().split('T')[0] : '';
                
                const address = l.address || '';
                const addressDisplay = address.length > 30 ? address.substring(0, 30) + '...' : address;
                
                return `
                    <tr>
                        <td title="${l.company_name}"><strong>${l.company_name}</strong></td>
                        <td title="${[l.contact_first_name, l.contact_last_name].filter(Boolean).join(' ') || '-'}">${[l.contact_first_name, l.contact_last_name].filter(Boolean).join(' ') || '-'}</td>
                        <td title="${l.email || '-'}">${l.email || '-'}</td>
                        <td><span class="tag ${l.status === 'Converted' ? 'green' : 'blue'}">${l.status || 'New'}</span></td>
                        <td><span class="tag">${l.interest || '-'}</span></td>
                        <td>${l.source || '-'}</td>
                        <td>
                            ${address ? `<div style="display: flex; align-items: center; gap: 4px;">
                                <span title="${address}" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${addressDisplay}</span>
                                <button class="button secondary" onclick="openGoogleMaps('${address.replace(/'/g, "\\'")}')" style="padding: 2px 6px; font-size: 10px;" title="Apri in Google Maps">ðŸ—ºï¸</button>
                            </div>` : '-'}
                        </td>
                        <td>
                            <input type="date" value="${createdDate}" 
                                   onchange="updateLeadDate(${l.id}, 'created_at', this.value)"
                                   style="border: 1px solid var(--border-color); padding: 4px 8px; border-radius: 4px; font-size: 13px;">
                        </td>
                        <td>
                            <input type="date" value="${lastContactDate}" 
                                   onchange="updateLeadDate(${l.id}, 'last_contact_at', this.value)"
                                   style="border: 1px solid var(--border-color); padding: 4px 8px; border-radius: 4px; font-size: 13px;">
                        </td>
                        <td style="display: flex; gap: 8px;">
                            <button class="button secondary" onclick="editLead(${l.id})">Modifica</button>
                            ${l.status !== 'Converted' ? `<button class="button secondary" onclick="convertLead(${l.id})">Converti</button>` : `<button class="button secondary" onclick="revertLeadConversion(${l.id})" style="background: var(--warning); color: white;">â†©ï¸ Annulla Conversione</button>`}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        let currentLeadsPage = 1;
        let leadsPagination = null;
        
        async function loadLeads(page = 1) {
            try {
                currentLeadsPage = page;
                const perPage = 50;
                const res = await fetch(`/api/leads?page=${page}&per_page=${perPage}`);
                const data = await res.json();
                if (data.error) {
                    console.error('Errore API:', data.error);
                    const tbody = document.getElementById('leads-table');
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 40px;">Errore: ${data.error}</td></tr>`;
                    }
                    return;
                }
                allLeads = data.leads || [];
                leadsPagination = data.pagination || null;
                console.log(`ðŸ“Š Caricati ${allLeads.length} Lead (pagina ${page}/${leadsPagination?.pages || 1})`);
                renderLeads();
                renderLeadsPagination();
            } catch (err) {
                console.error('Errore caricamento leads:', err);
                const tbody = document.getElementById('leads-table');
                if (tbody) {
                    tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 40px;">Errore nel caricamento dei leads</td></tr>`;
                }
            }
        }
        
        function renderLeadsPagination() {
            const paginationDiv = document.getElementById('leads-pagination');
            if (!paginationDiv || !leadsPagination) return;
            
            const { page, pages, has_next, has_prev, next_page, prev_page, total } = leadsPagination;
            
            if (pages <= 1) {
                paginationDiv.innerHTML = `<div style="text-align: center; padding: 16px; color: var(--text-medium);">Totale: ${total} leads</div>`;
                return;
            }
            
            paginationDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; flex-wrap: wrap; gap: 12px;">
                    <div style="color: var(--text-medium); font-size: 14px;">
                        Pagina ${page} di ${pages} (Totale: ${total} leads)
                    </div>
                    <div style="display: flex; gap: 8px;">
                        ${has_prev ? `<button class="button secondary" onclick="loadLeads(${prev_page})" style="padding: 8px 16px;">â† Precedente</button>` : ''}
                        ${has_next ? `<button class="button secondary" onclick="loadLeads(${next_page})" style="padding: 8px 16px;">Successivo â†’</button>` : ''}
                    </div>
                </div>
            `;
        }

        function showLeadForm() {
            document.getElementById('lead-form-card').style.display = 'block';
        }

        function hideLeadForm() {
            document.getElementById('lead-form-card').style.display = 'none';
            document.getElementById('lead-form').reset();
            editingLeadId = null;
            document.querySelector('#lead-form-card h3').textContent = 'Crea Nuovo Lead';
            document.querySelector('#lead-form button[type="submit"]').textContent = 'Salva Lead';
        }

        document.getElementById('lead-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                let res;
                if (editingLeadId) {
                    res = await fetch(`/api/leads/${editingLeadId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    res = await fetch('/api/leads', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                const result = await res.json();
                if (result.success) {
                    alert(editingLeadId ? 'Lead aggiornato con successo!' : 'Lead creato con successo!');
                    hideLeadForm();
                    loadLeads(currentLeadsPage);
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        });

        let currentAccountTab = 'all';
        let allAccounts = [];
        let currentAccountSort = 'name-asc';
        
        function switchAccountTab(tab) {
            currentAccountTab = tab;
            document.querySelectorAll('[data-account-tab]').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-account-tab="${tab}"]`)?.classList.add('active');
            renderAccounts();
        }
        
        function sortAccounts() {
            currentAccountSort = document.getElementById('accounts-sort').value;
            renderAccounts();
        }
        
        let accountsSearchTimeout = null;
        let isSearchingAccounts = false;
        
        function filterAccounts() {
            const searchTerm = document.getElementById('accounts-search')?.value.trim() || '';
            console.log('ðŸ” Ricerca account:', searchTerm);
            
            // Se c'Ã¨ un termine di ricerca, usa l'API per cercare su TUTTE le pagine
            if (searchTerm.length >= 2) {
                clearTimeout(accountsSearchTimeout);
                accountsSearchTimeout = setTimeout(async () => {
                    if (isSearchingAccounts) {
                        console.log('â³ Ricerca giÃ  in corso, aspetto...');
                        return;
                    }
                    isSearchingAccounts = true;
                    console.log('ðŸš€ Avvio ricerca account:', searchTerm);
                    
                    try {
                        const url = `/api/accounts/search-all?q=${encodeURIComponent(searchTerm)}&page=1&per_page=50`;
                        console.log('ðŸ“¡ Chiamata API:', url);
                        const res = await fetch(url);
                        
                        if (!res.ok) {
                            console.error('âŒ Errore HTTP:', res.status, res.statusText);
                            const errorText = await res.text();
                            console.error('Errore risposta:', errorText);
                            return;
                        }
                        
                        const data = await res.json();
                        console.log('âœ… Risposta API:', data);
                        
                        if (data.error) {
                            console.error('âŒ Errore ricerca:', data.error);
                            alert('Errore nella ricerca: ' + data.error);
                            return;
                        }
                        
                        // Aggiorna allAccounts con i risultati della ricerca
                        allAccounts = data.accounts || [];
                        accountsPagination = data.pagination || null;
                        console.log(`ðŸ“Š Trovati ${allAccounts.length} account su ${accountsPagination?.total || 0} totali`);
                        
                        // Renderizza i risultati
                        renderAccounts();
                        renderAccountsPagination();
                    } catch (err) {
                        console.error('âŒ Errore ricerca account:', err);
                        alert('Errore nella ricerca: ' + err.message);
                    } finally {
                        isSearchingAccounts = false;
                    }
                }, 300); // Debounce 300ms
            } else if (searchTerm.length === 0) {
                // Se il campo Ã¨ vuoto, ricarica la pagina corrente normale
                console.log('ðŸ”„ Campo vuoto, ricarico pagina normale');
                clearTimeout(accountsSearchTimeout);
                const currentPage = currentAccountsPage || 1;
                loadAccounts(currentPage);
            } else {
                // Meno di 2 caratteri, mostra messaggio
                console.log('â¸ï¸ Meno di 2 caratteri, aspetto...');
                renderAccounts();
            }
        }
        
        function renderAccounts() {
            const tbody = document.getElementById('accounts-table');
            if (!tbody) {
                console.error('âŒ tbody accounts-table non trovato!');
                return;
            }
            
            let filtered = [...allAccounts];
            console.log(`ðŸ“‹ Renderizzo ${filtered.length} account (da ${allAccounts.length} totali)`);
            
            // Filtro per tab
            if (currentAccountTab === 'con-opportunita') {
                filtered = filtered.filter(a => (a.opportunities_count || 0) > 0);
            } else if (currentAccountTab === 'senza-opportunita') {
                filtered = filtered.filter(a => (a.opportunities_count || 0) === 0);
            } else if (currentAccountTab === 'recenti') {
                // Ultimi 30 giorni
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                filtered = filtered.filter(a => {
                    if (!a.created_at) return false;
                    return new Date(a.created_at) >= thirtyDaysAgo;
                });
            }
            
            // NOTA: La ricerca viene fatta dall'API (/api/accounts/search-all)
            // quindi allAccounts contiene giÃ  i risultati filtrati se c'Ã¨ una ricerca attiva
            // Non serve filtrare di nuovo qui
            
            // Ordinamento
            filtered.sort((a, b) => {
                const [field, order] = currentAccountSort.split('-');
                
                if (field === 'name') {
                    const aName = (a.name || '').toLowerCase();
                    const bName = (b.name || '').toLowerCase();
                    return order === 'asc' ? aName.localeCompare(bName) : bName.localeCompare(aName);
                } else if (field === 'created') {
                    const aDate = a.created_at ? new Date(a.created_at) : new Date(0);
                    const bDate = b.created_at ? new Date(b.created_at) : new Date(0);
                    return order === 'desc' ? bDate - aDate : aDate - bDate;
                } else if (field === 'opp-count') {
                    const aCount = a.opportunities_count || 0;
                    const bCount = b.opportunities_count || 0;
                    return order === 'desc' ? bCount - aCount : aCount - bCount;
                } else if (field === 'last-opp') {
                    const aDate = a.last_opportunity_date ? new Date(a.last_opportunity_date) : new Date(0);
                    const bDate = b.last_opportunity_date ? new Date(b.last_opportunity_date) : new Date(0);
                    return order === 'desc' ? bDate - aDate : aDate - bDate;
                }
                return 0;
            });
            
            if (!filtered.length) {
                const searchTerm = document.getElementById('accounts-search')?.value.trim() || '';
                const message = searchTerm.length >= 2 
                    ? `Nessun account trovato per "${searchTerm}"`
                    : `Nessun account ${currentAccountTab !== 'all' ? `per il filtro selezionato` : ''}`;
                tbody.innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 40px;">${message}.</td></tr>`;
                console.log('âš ï¸ Nessun account da mostrare');
                return;
            }
                
            tbody.innerHTML = filtered.map(a => {
                const createdDate = a.created_at ? new Date(a.created_at).toISOString().split('T')[0] : '';
                const oppCount = a.opportunities_count || 0;
                const lastOppDate = a.last_opportunity_date ? new Date(a.last_opportunity_date).toISOString().split('T')[0] : '';
                
                const address = a.billing_address || a.shipping_address || '';
                const addressDisplay = address.length > 30 ? address.substring(0, 30) + '...' : address;
                
                return `
                    <tr data-account-id="${a.id}">
                        <td title="${a.name}">
                            <strong>${a.name}</strong>
                            ${a.image_url ? `<img src="${a.image_url}" style="width: 32px; height: 32px; border-radius: 50%; margin-left: 8px; object-fit: cover;" onerror="this.style.display='none'">` : ''}
                        </td>
                        <td><span class="tag">${a.industry || 'N/A'}</span></td>
                        <td title="${a.phone || '-'}">${a.phone || '-'}</td>
                        <td>
                            ${address ? `<div style="display: flex; align-items: center; gap: 4px;">
                                <span title="${address}" style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${addressDisplay}</span>
                                <button class="button secondary" onclick="openGoogleMaps('${address.replace(/'/g, "\\'")}')" style="padding: 2px 6px; font-size: 10px;" title="Apri in Google Maps">ðŸ—ºï¸</button>
                            </div>` : '-'}
                        </td>
                        <td>
                            ${oppCount > 0 ? `
                                <a href="#" onclick="viewAccountOpportunities(${a.id}); return false;" 
                                   style="color: var(--primary); font-weight: 600; text-decoration: none; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 4px; transition: all 0.2s;"
                                   onmouseover="this.style.background='var(--primary-light)'; this.style.textDecoration='underline';"
                                   onmouseout="this.style.background='transparent'; this.style.textDecoration='none';"
                                   title="Clicca per vedere le ${oppCount} opportunitÃ ">
                                    <strong>${oppCount}</strong>
                                    <span style="font-size: 12px;">ðŸ“‹</span>
                                </a>
                            ` : `<span style="color: var(--text-light);">0</span>`}
                        </td>
                        <td>
                            <input type="date" value="${createdDate}" 
                                   onchange="updateAccountDate(${a.id}, 'created_at', this.value)"
                                   style="border: 1px solid var(--border-color); padding: 4px 8px; border-radius: 4px; font-size: 13px;">
                        </td>
                        <td>${a.last_opportunity_date ? new Date(a.last_opportunity_date).toLocaleDateString('it-IT') : '-'}</td>
                        <td style="display: flex; gap: 8px;">
                            <button class="button secondary" onclick="editAccount(${a.id})">Modifica</button>
                            <button class="button secondary" onclick="viewAccountDetails(${a.id})">Dettagli</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        let currentAccountsPage = 1;
        let accountsPagination = null;
        
        async function loadAccounts(page = 1) {
            try {
                currentAccountsPage = page;
                const perPage = 50;
                const res = await fetch(`/api/accounts?page=${page}&per_page=${perPage}`);
                const data = await res.json();
                
                // Calcola statistiche per ogni account
                allAccounts = (data.accounts || []).map(a => {
                    const opps = a.opportunities || [];
                    const oppsCount = opps.length;
                    
                    // Trova l'opportunitÃ  piÃ¹ recente
                    let lastOppDate = null;
                    if (opps.length > 0) {
                        const dates = opps
                            .map(opp => opp.created_at ? new Date(opp.created_at) : null)
                            .filter(d => d !== null);
                        if (dates.length > 0) {
                            lastOppDate = new Date(Math.max(...dates.map(d => d.getTime())));
                        }
                    }
                    
                    return {
                        ...a,
                        opportunities_count: oppsCount,
                        last_opportunity_date: lastOppDate ? lastOppDate.toISOString() : null
                    };
                });
                
                accountsPagination = data.pagination || null;
                renderAccounts();
                renderAccountsPagination();
            } catch (err) {
                console.error('Errore caricamento accounts:', err);
            }
        }
        
        function renderAccountsPagination() {
            const container = document.getElementById('accounts-pagination');
            if (!container || !accountsPagination) return;
            
            const { page, pages, has_next, has_prev, total } = accountsPagination;
            
            let paginationHTML = `<div style="display: flex; align-items: center; gap: 8px; justify-content: center; padding: 16px; flex-wrap: wrap;">`;
            paginationHTML += `<span style="color: var(--text-medium); font-size: 13px;">Totale: ${total} | Pagina ${page} di ${pages}</span>`;
            
            if (has_prev) {
                paginationHTML += `<button class="button secondary" onclick="loadAccounts(${page - 1})" style="padding: 6px 12px; font-size: 12px;">â€¹ Precedente</button>`;
            }
            
            const startPage = Math.max(1, page - 2);
            const endPage = Math.min(pages, page + 2);
            
            if (startPage > 1) {
                paginationHTML += `<button class="button secondary" onclick="loadAccounts(1)" style="padding: 6px 10px; font-size: 12px;">1</button>`;
                if (startPage > 2) paginationHTML += `<span style="padding: 6px;">...</span>`;
            }
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === page) {
                    paginationHTML += `<button class="button" style="padding: 6px 10px; font-size: 12px; background: var(--primary); color: white;">${i}</button>`;
                } else {
                    paginationHTML += `<button class="button secondary" onclick="loadAccounts(${i})" style="padding: 6px 10px; font-size: 12px;">${i}</button>`;
                }
            }
            
            if (endPage < pages) {
                if (endPage < pages - 1) paginationHTML += `<span style="padding: 6px;">...</span>`;
                paginationHTML += `<button class="button secondary" onclick="loadAccounts(${pages})" style="padding: 6px 10px; font-size: 12px;">${pages}</button>`;
            }
            
            if (has_next) {
                paginationHTML += `<button class="button secondary" onclick="loadAccounts(${page + 1})" style="padding: 6px 12px; font-size: 12px;">Successiva â€º</button>`;
            }
            
            paginationHTML += `</div>`;
            container.innerHTML = paginationHTML;
        }
        
        function renderOpportunitiesPagination() {
            const container = document.getElementById('opportunities-pagination');
            if (!container || !opportunitiesPagination) return;
            
            const { page, pages, has_next, has_prev, total } = opportunitiesPagination;
            
            let paginationHTML = `<div style="display: flex; align-items: center; gap: 8px; justify-content: center; padding: 16px; flex-wrap: wrap;">`;
            paginationHTML += `<span style="color: var(--text-medium); font-size: 13px;">Totale: ${total} | Pagina ${page} di ${pages}</span>`;
            
            if (has_prev) {
                paginationHTML += `<button class="button secondary" onclick="loadOpportunities(${page - 1})" style="padding: 6px 12px; font-size: 12px;">â€¹ Precedente</button>`;
            }
            
            const startPage = Math.max(1, page - 2);
            const endPage = Math.min(pages, page + 2);
            
            if (startPage > 1) {
                paginationHTML += `<button class="button secondary" onclick="loadOpportunities(1)" style="padding: 6px 10px; font-size: 12px;">1</button>`;
                if (startPage > 2) paginationHTML += `<span style="padding: 6px;">...</span>`;
            }
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === page) {
                    paginationHTML += `<button class="button" style="padding: 6px 10px; font-size: 12px; background: var(--primary); color: white;">${i}</button>`;
                } else {
                    paginationHTML += `<button class="button secondary" onclick="loadOpportunities(${i})" style="padding: 6px 10px; font-size: 12px;">${i}</button>`;
                }
            }
            
            if (endPage < pages) {
                if (endPage < pages - 1) paginationHTML += `<span style="padding: 6px;">...</span>`;
                paginationHTML += `<button class="button secondary" onclick="loadOpportunities(${pages})" style="padding: 6px 10px; font-size: 12px;">${pages}</button>`;
            }
            
            if (has_next) {
                paginationHTML += `<button class="button secondary" onclick="loadOpportunities(${page + 1})" style="padding: 6px 12px; font-size: 12px;">Successiva â€º</button>`;
            }
            
            paginationHTML += `</div>`;
            container.innerHTML = paginationHTML;
        }
        
        async function updateAccountDate(accountId, field, value) {
            try {
                const res = await fetch(`/api/accounts/${accountId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: value || null })
                });
                const data = await res.json();
                if (data.success) {
                    const account = allAccounts.find(a => a.id === accountId);
                    if (account) {
                        account[field] = value || null;
                    }
                } else {
                    alert('Errore aggiornamento data: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        function viewAccountOpportunities(accountId) {
            // Vai alla vista opportunitÃ  e filtra per account
            switchView('opportunities-view');
            setTimeout(() => {
                // Carica opportunitÃ  se non ancora caricate
                if (!allOpportunities || allOpportunities.length === 0) {
                    loadOpportunities(1).then(() => {
                        filterOpportunitiesByAccount(accountId);
                    });
                } else {
                    filterOpportunitiesByAccount(accountId);
                }
            }, 100);
        }
        
        function filterOpportunitiesByAccount(accountId) {
            // Filtra le opportunitÃ  per account
            const account = allAccounts.find(a => a.id === accountId);
            if (!account) {
                console.error('Account non trovato:', accountId);
                return;
            }
            
            // Imposta il filtro account corrente
            currentAccountFilter = accountId;
            
            // Cambia tab a "all" per vedere tutte le opportunitÃ  dell'account
            switchOppTab('all');
            
            // RICARICA le opportunitÃ  dal server filtrate per account_id
            loadOpportunities(1, accountId).then(() => {
                // Filtra e renderizza le opportunitÃ 
                setTimeout(() => {
                    renderOpportunities();
                
                // Mostra un messaggio informativo
                const searchInput = document.getElementById('opportunities-search');
                if (searchInput) {
                    searchInput.value = `Account: ${account.name}`;
                    searchInput.style.background = 'var(--primary-light)';
                    searchInput.title = `Filtrato per account: ${account.name}. Clicca X per rimuovere il filtro.`;
                    
                    // Aggiungi pulsante per rimuovere il filtro
                    const existingClearBtn = document.getElementById('clear-account-filter');
                    if (existingClearBtn) {
                        existingClearBtn.remove();
                    }
                    
                    const clearBtn = document.createElement('button');
                    clearBtn.id = 'clear-account-filter';
                    clearBtn.innerHTML = 'âœ•';
                    clearBtn.style.cssText = 'position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: var(--primary); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; font-weight: bold;';
                    clearBtn.onclick = () => {
                        currentAccountFilter = null;
                        searchInput.value = '';
                        searchInput.style.background = '';
                        searchInput.title = '';
                        clearBtn.remove();
                        renderOpportunities();
                    };
                    
                    const searchContainer = searchInput.parentElement;
                    if (searchContainer) {
                        searchContainer.style.position = 'relative';
                        searchContainer.appendChild(clearBtn);
                    }
                }
                }, 200);
            });
        }
        
        function switchView(viewName) {
            // Trova il nav-item corrispondente e simula il click
            const navItem = document.querySelector(`[data-target="${viewName}"]`);
            if (navItem) {
                navItem.click();
            }
        }
        
        function viewAccountFromOpportunity(accountId) {
            // Vai alla vista account e evidenzia l'account
            switchView('accounts-view');
            // Attendi che la vista sia caricata
            setTimeout(() => {
                loadAccounts(currentAccountsPage).then(() => {
                    // Evidenzia la riga dell'account
                    const accountRow = document.querySelector(`tr[data-account-id="${accountId}"]`);
                    if (accountRow) {
                        accountRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        accountRow.style.background = 'var(--primary-light)';
                        accountRow.style.transition = 'background 0.3s';
                        setTimeout(() => {
                            accountRow.style.background = '';
                        }, 2000);
                    }
                    // Cerca la riga dell'account
                    setTimeout(() => {
                        const accountRow = document.querySelector(`[data-account-id="${accountId}"]`);
                        if (accountRow) {
                            accountRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            accountRow.style.background = '#e0f2fe';
                            setTimeout(() => {
                                accountRow.style.background = '';
                            }, 3000);
                        } else {
                            // Se non trovato, prova a cercare dopo un altro delay
                            setTimeout(() => {
                                const accountRow = document.querySelector(`[data-account-id="${accountId}"]`);
                                if (accountRow) {
                                    accountRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    accountRow.style.background = '#e0f2fe';
                                    setTimeout(() => {
                                        accountRow.style.background = '';
                                    }, 3000);
                                }
                            }, 500);
                        }
                    }, 200);
                });
            }, 100);
        }
        
        async function viewAccountDetails(accountId) {
            try {
                console.log(`Navigazione verso account ${accountId}`);
                
                // Pulisci la ricerca se attiva (per vedere l'account nella lista normale)
                const searchInput = document.getElementById('accounts-search');
                if (searchInput && searchInput.value.trim()) {
                    searchInput.value = '';
                }
                
                // Vai alla vista account PRIMA di caricare i dati
                const navItem = document.querySelector('[data-target="accounts-view"]');
                if (navItem) {
                    navItem.click();
                }
                
                // Attendi che la vista sia cambiata
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Funzione helper per evidenziare la riga
                const highlightRow = (row) => {
                    if (!row) return;
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    row.style.background = 'var(--primary-light)';
                    row.style.transition = 'background 0.3s';
                    row.style.borderLeft = '4px solid var(--primary)';
                    row.style.boxShadow = '0 2px 8px rgba(37, 99, 235, 0.3)';
                    setTimeout(() => {
                        row.style.background = '';
                        row.style.borderLeft = '';
                        row.style.boxShadow = '';
                    }, 3000);
                };
                
                // Usa l'endpoint API per trovare direttamente la pagina (VELOCISSIMO!)
                try {
                    const res = await fetch(`/api/accounts/find-page?id=${accountId}&per_page=50`);
                    if (res.ok) {
                        const data = await res.json();
                        const page = data.page;
                        console.log(`Account ${accountId} trovato alla pagina ${page}, carico...`);
                        
                        // Carica la pagina corretta (senza ricerca)
                        await loadAccounts(page);
                        await new Promise(resolve => setTimeout(resolve, 600));
                        
                        // Evidenzia la riga
                        const accountRow = document.querySelector(`tr[data-account-id="${accountId}"]`);
                        if (accountRow) {
                            highlightRow(accountRow);
                            return;
                        }
                    }
                } catch (err) {
                    console.warn('Errore ricerca pagina account:', err);
                }
                
                // Fallback: alert
                alert(`Account ID ${accountId} non trovato nel database.`);
            } catch (error) {
                console.error('Errore caricamento dettagli account:', error);
                alert('Errore nel caricamento dei dettagli dell\'account: ' + error.message);
            }
        }
        
        async function viewLeadDetails(leadId) {
            try {
                // Pulisci la ricerca se attiva (per vedere il lead nella lista normale)
                const searchInput = document.getElementById('leads-search');
                if (searchInput && searchInput.value.trim()) {
                    searchInput.value = '';
                }
                
                // Vai alla vista leads PRIMA di caricare i dati
                const navItem = document.querySelector('[data-target="leads-view"]');
                if (navItem) {
                    navItem.click();
                } else {
                    switchView('leads-view');
                }
                
                // Attendi che la vista sia cambiata
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Funzione helper per evidenziare la riga
                const highlightRow = (row) => {
                    if (!row) return;
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    row.style.background = 'var(--primary-light)';
                    row.style.transition = 'background 0.3s';
                    row.style.borderLeft = '4px solid var(--primary)';
                    row.style.boxShadow = '0 2px 8px rgba(37, 99, 235, 0.3)';
                    setTimeout(() => {
                        row.style.background = '';
                        row.style.borderLeft = '';
                        row.style.boxShadow = '';
                    }, 3000);
                };
                
                // Usa l'endpoint API per trovare direttamente la pagina
                try {
                    const res = await fetch(`/api/leads/find-page?id=${leadId}&per_page=50`);
                    if (res.ok) {
                        const data = await res.json();
                        const page = data.page;
                        console.log(`Lead ${leadId} trovato alla pagina ${page}, carico...`);
                        
                        // Carica la pagina corretta (senza ricerca)
                        await loadLeads(page);
                        await new Promise(resolve => setTimeout(resolve, 600));
                        
                        // Evidenzia la riga
                        const leadRow = document.querySelector(`tr[data-lead-id="${leadId}"]`);
                        if (leadRow) {
                            highlightRow(leadRow);
                            return;
                        }
                    }
                } catch (err) {
                    console.warn('Errore ricerca pagina lead:', err);
                }
                
                // Fallback: se non trovato come lead, cerca come account
                console.warn(`Lead ${leadId} non trovato nei leads, cerco negli account...`);
                
                // Pulisci anche la ricerca account se attiva
                const accountSearchInput = document.getElementById('accounts-search');
                if (accountSearchInput && accountSearchInput.value.trim()) {
                    accountSearchInput.value = '';
                }
                
                // Vai alla vista account
                const accountNavItem = document.querySelector('[data-target="accounts-view"]');
                if (accountNavItem) {
                    accountNavItem.click();
                } else {
                    switchView('accounts-view');
                }
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Cerca come account
                try {
                    const res = await fetch(`/api/accounts/find-page?id=${leadId}&per_page=50`);
                    if (res.ok) {
                        const data = await res.json();
                        const page = data.page;
                        console.log(`Account ${leadId} trovato alla pagina ${page} (era marcato come lead nella mappa)`);
                        
                        // Carica la pagina corretta (senza ricerca)
                        await loadAccounts(page);
                        await new Promise(resolve => setTimeout(resolve, 600));
                        
                        // Evidenzia la riga
                        const accountRow = document.querySelector(`tr[data-account-id="${leadId}"]`);
                        if (accountRow) {
                            highlightRow(accountRow);
                            return;
                        }
                    }
                } catch (err) {
                    console.warn('Errore ricerca pagina account:', err);
                }
                
                // Ultimo tentativo: alert
                alert(`ID ${leadId} non trovato nÃ© come lead nÃ© come account.`);
            } catch (error) {
                console.error('Errore caricamento dettagli lead:', error);
                alert('Errore nel caricamento dei dettagli del lead: ' + error.message);
            }
        }

        function showAccountForm() {
            document.getElementById('account-form-card').style.display = 'block';
        }

        function hideAccountForm() {
            document.getElementById('account-form-card').style.display = 'none';
            document.getElementById('account-form').reset();
            editingAccountId = null;
            document.querySelector('#account-form-card h3').textContent = 'Crea Nuovo Account';
            document.querySelector('#account-form button[type="submit"]').textContent = 'Salva Account';
        }

        document.getElementById('account-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                let res;
                if (editingAccountId) {
                    res = await fetch(`/api/accounts/${editingAccountId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    res = await fetch('/api/accounts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                const result = await res.json();
                if (result.success) {
                    alert(editingAccountId ? 'Account aggiornato con successo!' : 'Account creato con successo!');
                    hideAccountForm();
                    loadAccounts(currentAccountsPage);
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        });

        function showOpportunityForm() {
            document.getElementById('opportunity-form-card').style.display = 'block';
        }

        function hideOpportunityForm() {
            document.getElementById('opportunity-form-card').style.display = 'none';
            document.getElementById('opportunity-form').reset();
            editingOpportunityId = null;
            document.querySelector('#opportunity-form-card h3').textContent = 'Crea Nuova OpportunitÃ ';
            document.querySelector('#opportunity-form button[type="submit"]').textContent = 'Salva OpportunitÃ ';
        }

        document.getElementById('opportunity-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Se non c'Ã¨ supplier_category, prova a categorizzare automaticamente
            if (!data.supplier_category && data.name) {
                const autoCategory = categorizzaOpportunita(data.name, data.description || '');
                if (autoCategory && autoCategory !== 'Altri Fornitori') {
                    data.supplier_category = autoCategory;
                    // Aggiorna anche il select nel form
                    const categorySelect = document.querySelector('#opportunity-form select[name="supplier_category"]');
                    if (categorySelect) {
                        categorySelect.value = autoCategory;
                    }
                }
            }
            
            try {
                let res;
                if (editingOpportunityId) {
                    res = await fetch(`/api/opportunities/${editingOpportunityId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    res = await fetch('/api/opportunities', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }
                const result = await res.json();
                if (result.success) {
                    alert(editingOpportunityId ? 'OpportunitÃ  aggiornata con successo!' : 'OpportunitÃ  creata con successo!');
                    hideOpportunityForm();
                    loadOpportunities();
                    loadDashboard(); // Ricarica dashboard per aggiornare grafici
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        });

        let currentOppTab = 'all';
        let currentLeadTab = 'all';
        let allOpportunities = [];
        let currentAccountFilter = null; // Traccia il filtro account corrente
        let allLeads = [];
        
        function switchOppTab(tab) {
            currentOppTab = tab;
            
            // Animazione transizione tab con ripple effect
            const buttons = document.querySelectorAll('[data-opp-tab]');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.transform = 'scale(0.95)';
                btn.style.opacity = '0.7';
            });
            
            const activeBtn = document.querySelector(`[data-opp-tab="${tab}"]`);
            if (activeBtn) {
                setTimeout(() => {
                    activeBtn.classList.add('active');
                    activeBtn.style.transform = 'scale(1)';
                    activeBtn.style.opacity = '1';
                    // Ripple effect
                    activeBtn.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                }, 50);
            }
            
            // Animazione fade-out/fade-in per la tabella con smooth transition
            const tbody = document.getElementById('opportunities-table');
            if (tbody) {
                tbody.style.opacity = '0';
                tbody.style.transform = 'translateY(-10px)';
                tbody.style.transition = 'all 0.25s cubic-bezier(0.4, 0, 0.2, 1)';
                
                setTimeout(() => {
                    loadOpportunities(1); // Ricarica dalla prima pagina quando cambia tab
                    setTimeout(() => {
                        tbody.style.opacity = '1';
                        tbody.style.transform = 'translateY(0)';
                    }, 100);
                }, 250);
            } else {
                loadOpportunities(1); // Ricarica dalla prima pagina quando cambia tab
            }
        }
        
        function switchLeadTab(tab) {
            currentLeadTab = tab;
            document.querySelectorAll('[data-lead-tab]').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-lead-tab="${tab}"]`)?.classList.add('active');
            loadLeads(1); // Ricarica dalla prima pagina quando cambia tab
        }
        
        function categorizzaOpportunita(nome, descrizione) {
            // Categorizza automaticamente un'opportunitÃ  basandosi sul nome e descrizione
            const testo = ((nome || '') + ' ' + (descrizione || '')).toUpperCase();
            
            const categorie = [];
            if (testo.includes('MIR') || testo.includes('MOBILE') || testo.includes('AMR')) {
                categorie.push('MiR');
            }
            if (testo.includes('UR') || testo.includes('UNIVERSAL ROBOT') || testo.includes('COBOT')) {
                categorie.push('Universal Robots');
            }
            if (testo.includes('UNITREE') || testo.includes('G1') || testo.includes('GO2') || testo.includes('B2') || testo.includes('R1')) {
                categorie.push('Unitree');
            }
            
            if (categorie.length === 0) {
                return 'Altri Fornitori';
            }
            
            return categorie.join(', ');
        }
        
        function renderOpportunities() {
            const tbody = document.getElementById('opportunities-table');
            if (!tbody) {
                console.error('Elemento opportunities-table non trovato!');
                return;
            }
            
            let filtered = allOpportunities || [];
            
            // Applica filtro account se presente
            if (currentAccountFilter) {
                filtered = filtered.filter(o => o.account_id === currentAccountFilter);
            }
            
            if (currentOppTab !== 'all') {
                // Filtri per calore (prioritÃ )
                if (currentOppTab === 'calda') {
                    filtered = allOpportunities.filter(o => (o.heat_level || 'tiepida') === 'calda' && o.stage !== 'Closed Won' && o.stage !== 'Closed Lost');
                } else if (currentOppTab === 'tiepida') {
                    filtered = allOpportunities.filter(o => o.heat_level === 'tiepida' && o.stage !== 'Closed Won' && o.stage !== 'Closed Lost');
                } else if (currentOppTab === 'fredda_speranza') {
                    filtered = allOpportunities.filter(o => (o.heat_level || 'tiepida') === 'fredda_speranza' && o.stage !== 'Closed Won' && o.stage !== 'Closed Lost');
                } else if (currentOppTab === 'fredda_gelo') {
                    filtered = allOpportunities.filter(o => (o.heat_level || 'tiepida') === 'fredda_gelo' && o.stage !== 'Closed Won' && o.stage !== 'Closed Lost');
                } else if (currentOppTab === 'da_categorizzare') {
                    filtered = allOpportunities.filter(o => (!o.heat_level || o.heat_level === 'da_categorizzare' || o.heat_level === null || o.heat_level === '') && o.stage !== 'Closed Won' && o.stage !== 'Closed Lost');
                }
                // Filtri per categoria prodotto (secondari)
                else if (currentOppTab === 'Altri') {
                    filtered = allOpportunities.filter(o => {
                        const cat = (o.supplier_category || '').toUpperCase();
                        return !cat.includes('UR') && !cat.includes('UNIVERSAL') && !cat.includes('MIR') && !cat.includes('UNITREE') && o.stage !== 'Closed Won' && o.stage !== 'Closed Lost';
                    });
                } else if (currentOppTab === 'UR') {
                    filtered = allOpportunities.filter(o => {
                        const cat = (o.supplier_category || '').toUpperCase();
                        return (cat.includes('UNIVERSAL') || cat.includes('UR')) && o.stage !== 'Closed Won' && o.stage !== 'Closed Lost';
                    });
                } else if (currentOppTab === 'MIR') {
                    filtered = allOpportunities.filter(o => {
                        const cat = (o.supplier_category || '').toUpperCase();
                        return cat.includes('MIR') && o.stage !== 'Closed Won' && o.stage !== 'Closed Lost';
                    });
                } else if (currentOppTab === 'Unitree') {
                    filtered = allOpportunities.filter(o => {
                        const cat = (o.supplier_category || '').toUpperCase();
                        const hasUnitree = cat.includes('UNITREE');
                        const isOpen = o.stage !== 'Closed Won' && o.stage !== 'Closed Lost';
                        return hasUnitree && isOpen;
                    });
                    console.log(`Filtro Unitree: ${filtered.length} opportunitÃ  su ${allOpportunities.length} totali`);
                    console.log('Prime 5 opportunitÃ  Unitree:', filtered.slice(0, 5).map(o => ({
                        id: o.id,
                        name: o.name,
                        category: o.supplier_category,
                        owner: o.owner_name
                    })));
                }
                // Filtri per opportunitÃ  chiuse
                else if (currentOppTab === 'closed_won') {
                    filtered = allOpportunities.filter(o => o.stage === 'Closed Won');
                } else if (currentOppTab === 'closed_lost') {
                    filtered = allOpportunities.filter(o => o.stage === 'Closed Lost');
                }
            } else {
                // Mostra tutte le opportunitÃ  (incluse chiuse)
                filtered = allOpportunities;
            }
            
            if (!filtered.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 60px 40px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“­</div>
                            <h3 style="color: var(--text-dark); margin-bottom: 8px; font-weight: 600;">Nessuna opportunitÃ  trovata</h3>
                            <p style="color: var(--text-medium); font-weight: 500;">${currentOppTab !== 'all' ? `Nessuna opportunitÃ  per "${currentOppTab}"` : 'Crea la tua prima opportunitÃ !'}</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Renderizza le righe con animazione
            const rows = filtered.map((o, index) => {
                const stageColors = {
                    'Closed Won': 'green',
                    'Closed Lost': 'red',
                    'Negotiation/Review': 'orange',
                    'Proposal/Price Quote': 'amber'
                };
                const stageColor = stageColors[o.stage] || 'blue';
                
                const createdDate = o.created_at ? new Date(o.created_at).toISOString().split('T')[0] : '';
                const closeDate = o.close_date ? new Date(o.close_date).toISOString().split('T')[0] : '';
                
                const categoryDisplay = o.supplier_category || 'Non categorizzata';
                // Se la categoria contiene virgole, mostra tag multipli
                let categoryTags = '';
                if (categoryDisplay.includes(',')) {
                    const categories = categoryDisplay.split(',').map(c => c.trim()).filter(c => c);
                    categoryTags = categories.map(c => {
                        const color = c.includes('MiR') || c.includes('MIR') ? 'blue' : 
                                     c.includes('UR') || c.includes('Universal') ? 'purple' : 
                                     c.includes('Unitree') ? 'green' : 'gray';
                        return `<span class="tag" style="margin-right: 4px; background: var(--${color === 'purple' ? 'primary' : color}); color: white;">${c}</span>`;
                    }).join('');
                } else {
                    const color = categoryDisplay.includes('MiR') || categoryDisplay.includes('MIR') ? 'blue' : 
                                 categoryDisplay.includes('UR') || categoryDisplay.includes('Universal') ? 'purple' : 
                                 categoryDisplay.includes('Unitree') ? 'green' : 'gray';
                    categoryTags = `<span class="tag" style="background: var(--${color === 'purple' ? 'primary' : color}); color: white;">${categoryDisplay}</span>`;
                }
                
                // Aggiungi dropdown per cambiare categoria
                const categorySelect = `
                    <div style="position: relative; display: inline-block;">
                        ${categoryTags}
                        <select onchange="updateOpportunityCategory(${o.id}, this.value)" 
                                style="margin-left: 4px; padding: 2px 6px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 11px; background: white; cursor: pointer;"
                                title="Cambia categoria">
                            <option value="${categoryDisplay}" selected>Cambia...</option>
                            <option value="MiR">MiR</option>
                            <option value="Universal Robots">Universal Robots</option>
                            <option value="Unitree">Unitree</option>
                            <option value="MiR, Universal Robots">MiR + UR</option>
                            <option value="MiR, Unitree">MiR + Unitree</option>
                            <option value="Universal Robots, Unitree">UR + Unitree</option>
                            <option value="MiR, Universal Robots, Unitree">MiR + UR + Unitree</option>
                            <option value="Servizi">Servizi</option>
                            <option value="Altri Fornitori">Altri Fornitori</option>
                        </select>
                    </div>
                `;
                
                const amountFormatted = Number(o.amount || 0).toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                // Colori per heat_level
                const heatLevel = o.heat_level || 'da_categorizzare';
                const heatColors = {
                    'calda': '#ef4444',
                    'tiepida': '#f59e0b',
                    'fredda_speranza': '#3b82f6',
                    'fredda_gelo': '#64748b',
                    'da_categorizzare': '#a855f7'
                };
                const heatIcons = {
                    'calda': 'â—',
                    'tiepida': 'â—',
                    'fredda_speranza': 'â—‹',
                    'fredda_gelo': 'â—‹',
                    'da_categorizzare': 'â–¡'
                };
                const heatLabels = {
                    'calda': 'Calda',
                    'tiepida': 'Tiepida',
                    'fredda_speranza': 'Fredda con Speranza',
                    'fredda_gelo': 'Fredda Gelo',
                    'da_categorizzare': 'Da Categorizzare'
                };
                const heatColor = heatColors[heatLevel] || '#a855f7';
                const heatIcon = heatIcons[heatLevel] || 'â–¡';
                const heatLabel = heatLabels[heatLevel] || 'Da Categorizzare';
                
                return `
                    <tr data-opp-id="${o.id}" style="border-left: 4px solid ${heatColor}; transition: all 0.2s ease;" 
                        onmouseover="this.style.background='#f8fafc'; this.style.transform='translateX(2px)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.05)'" 
                        onmouseout="this.style.background='white'; this.style.transform='translateX(0)'; this.style.boxShadow='none'"
                        class="opp-row" data-animate="true">
                        <td style="max-width: 200px;" title="${o.name || 'Senza nome'}">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <strong style="font-size: 13px;">${o.name || 'Senza nome'}</strong>
                                ${(!o.offers || o.offers.length === 0) ? `<span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #f59e0b; border: 1px solid #d97706;" title="Nessuna offerta associata"></span>` : ''}
                                ${(!o.created_at || !o.close_date) && o.stage !== 'Closed Won' && o.stage !== 'Closed Lost' ? `<span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #ef4444; border: 1px solid #dc2626;" title="Data mancante per pipeline"></span>` : ''}
                            </div>
                            ${o.owner_name && o.owner_name !== 'Unknown' ? `<br><small style="color: var(--text-medium); font-size: 10px; display: flex; align-items: center; gap: 4px; margin-top: 4px;"><span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; border: 1.5px solid currentColor; position: relative;"><span style="position: absolute; top: 2px; left: 2px; width: 3px; height: 3px; background: currentColor; border-radius: 50%;"></span></span>${o.owner_name}</small>` : ''}
                        </td>
                        <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${o.account_name || '-'}">
                            <div style="display: flex; align-items: center; gap: 4px; flex-wrap: wrap;">
                                ${o.account_id ? `
                                    <a href="#" onclick="viewAccountFromOpportunity(${o.account_id}); return false;" 
                                       style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--primary); text-decoration: none; font-weight: 600; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px;"
                                       onmouseover="this.style.background='var(--primary-light)'; this.style.textDecoration='underline';"
                                       onmouseout="this.style.background='transparent'; this.style.textDecoration='none';"
                                       title="Clicca per vedere l'account ${o.account_name || ''}">
                                        <span>${o.account_name || '-'}</span>
                                        <span style="font-size: 12px;">ðŸ¢</span>
                                    </a>
                                ` : `<span style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text-light);">${o.account_name || '-'}</span>`}
                                ${o.account_address ? `<button class="button secondary" onclick="openGoogleMaps('${o.account_address.replace(/'/g, "\\'")}')" style="padding: 4px 6px; font-size: 10px; border: 1px solid var(--primary); background: white; color: var(--primary); font-weight: 600; border-radius: 4px;" title="Apri in Google Maps"><span style="display: inline-block; width: 10px; height: 10px; border: 1.5px solid currentColor; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); position: relative; vertical-align: middle; margin-right: 2px;"><span style="position: absolute; top: 2px; left: 2px; width: 3px; height: 3px; background: currentColor; border-radius: 50%;"></span></span>Maps</button>` : ''}
                            </div>
                        </td>
                        <td style="max-width: 200px;">
                            <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 6px;">
                                ${categoryTags}
                            </div>
                            <select onchange="updateOpportunityCategory(${o.id}, this.value)" 
                                    style="padding: 6px 8px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 12px; background: white; width: 100%; cursor: pointer; font-weight: 500; color: var(--text-dark); transition: all 0.2s ease;"
                                    onmouseover="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px rgba(37, 99, 235, 0.1)'"
                                    onmouseout="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'"
                                    title="Cambia categoria prodotto">
                                <option value="${categoryDisplay}" selected disabled>ðŸ“¦ ${categoryDisplay}</option>
                                <option value="MiR">ðŸ¤– MiR</option>
                                <option value="Universal Robots">ðŸ”§ Universal Robots</option>
                                <option value="Unitree">ðŸš¶ Unitree</option>
                                <option value="MiR, Universal Robots">ðŸ¤–ðŸ”§ MiR + UR</option>
                                <option value="MiR, Unitree">ðŸ¤–ðŸš¶ MiR + Unitree</option>
                                <option value="Universal Robots, Unitree">ðŸ”§ðŸš¶ UR + Unitree</option>
                                <option value="MiR, Universal Robots, Unitree">ðŸ¤–ðŸ”§ðŸš¶ MiR + UR + Unitree</option>
                                <option value="Servizi">âš™ï¸ Servizi</option>
                                <option value="Altri Fornitori">ðŸ“¦ Altri Fornitori</option>
                            </select>
                        </td>
                        <td style="max-width: 150px;">
                            <div style="display: flex; flex-direction: column; gap: 6px;">
                                <div style="display: flex; align-items: center; gap: 6px; padding: 4px 8px; background: ${heatColor}15; border: 1px solid ${heatColor}; border-radius: 6px;">
                                    <span style="color: ${heatColor}; font-size: 14px; font-weight: 700;">${heatIcon}</span>
                                    <span style="color: ${heatColor}; font-weight: 600; font-size: 11px; flex: 1;">${heatLabel}</span>
                                </div>
                                <select onchange="updateOpportunityHeatLevel(${o.id}, this.value)" 
                                        style="padding: 6px 8px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 12px; background: white; width: 100%; cursor: pointer; font-weight: 500; color: var(--text-dark); transition: all 0.2s ease;"
                                        onmouseover="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px rgba(37, 99, 235, 0.1)'"
                                        onmouseout="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                                    <option value="da_categorizzare" ${(!heatLevel || heatLevel === 'da_categorizzare' || heatLevel === null || heatLevel === '') ? 'selected' : ''} style="color: #a855f7; font-weight: 600;">â–¡ Da Categorizzare</option>
                                    <option value="calda" ${heatLevel === 'calda' ? 'selected' : ''} style="color: #ef4444; font-weight: 600;">â— Calda</option>
                                    <option value="tiepida" ${heatLevel === 'tiepida' ? 'selected' : ''} style="color: #f59e0b; font-weight: 600;">â— Tiepida</option>
                                    <option value="fredda_speranza" ${heatLevel === 'fredda_speranza' ? 'selected' : ''} style="color: #3b82f6; font-weight: 600;">â—‹ Fredda con Speranza</option>
                                    <option value="fredda_gelo" ${heatLevel === 'fredda_gelo' ? 'selected' : ''} style="color: #64748b; font-weight: 600;">â—‹ Fredda Gelo</option>
                                </select>
                            </div>
                        </td>
                        <td style="max-width: 150px;">
                            <select onchange="updateOpportunityStage(${o.id}, this.value)" 
                                    style="padding: 6px 8px; border: 2px solid var(--border-color); border-radius: 6px; font-size: 11px; background: white; width: 100%; cursor: pointer; font-weight: 600; color: var(--text-dark); transition: all 0.2s ease;"
                                    onmouseover="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 0 0 3px rgba(37, 99, 235, 0.1)'"
                                    onmouseout="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'">
                                <option value="Qualification" ${o.stage === 'Qualification' ? 'selected' : ''}>ðŸ“‹ Qualificazione</option>
                                <option value="Needs Analysis" ${o.stage === 'Needs Analysis' ? 'selected' : ''}>ðŸ” Analisi NecessitÃ </option>
                                <option value="Value Proposition" ${o.stage === 'Value Proposition' ? 'selected' : ''}>ðŸ’Ž Proposta di Valore</option>
                                <option value="Id. Decision Makers" ${o.stage === 'Id. Decision Makers' ? 'selected' : ''}>ðŸ‘¥ Identificazione Decision Maker</option>
                                <option value="Perception Analysis" ${o.stage === 'Perception Analysis' ? 'selected' : ''}>ðŸŽ¯ Analisi Percezione</option>
                                <option value="Proposal/Price Quote" ${o.stage === 'Proposal/Price Quote' ? 'selected' : ''}>ðŸ“„ Offerta/Preventivo</option>
                                <option value="Negotiation/Review" ${o.stage === 'Negotiation/Review' ? 'selected' : ''}>ðŸ¤ Negoziazione/Revisione</option>
                                <option value="Closed Won" ${o.stage === 'Closed Won' ? 'selected' : ''} style="color: #10b981; font-weight: 600;">âœ… Chiusa Vinta</option>
                                <option value="Closed Lost" ${o.stage === 'Closed Lost' ? 'selected' : ''} style="color: #ef4444; font-weight: 600;">âŒ Chiusa Persa</option>
                            </select>
                        </td>
                        <td style="font-weight: 600; color: var(--primary);">â‚¬${amountFormatted}</td>
                        <td style="text-align: center;">${o.probability || 0}%</td>
                        <td style="max-width: 150px;">
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                <div style="font-size: 10px; color: var(--text-medium); font-weight: 600;">Creazione:</div>
                                <input type="date" value="${createdDate}" 
                                       onchange="updateOpportunityDate(${o.id}, 'created_at', this.value)"
                                       style="border: 1px solid var(--border-color); padding: 3px 5px; border-radius: 4px; font-size: 11px; width: 100%;">
                                <div style="font-size: 10px; color: var(--text-medium); font-weight: 600; margin-top: 4px;">Chiusura:</div>
                                <input type="date" value="${closeDate}" 
                                       onchange="updateOpportunityDate(${o.id}, 'close_date', this.value)"
                                       style="border: 1px solid var(--border-color); padding: 3px 5px; border-radius: 4px; font-size: 11px; width: 100%;">
                            </div>
                        </td>
                        <td style="max-width: 200px; display: flex; gap: 2px; flex-wrap: wrap;">
                            ${o.stage !== 'Closed Won' && o.stage !== 'Closed Lost' ? `
                                <button class="button secondary" onclick="editOpportunity(${o.id})" style="padding: 6px 10px; font-size: 11px; border: 1.5px solid var(--primary); background: white; color: var(--primary); font-weight: 600; border-radius: 6px;" title="Modifica"><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid currentColor; border-radius: 2px; position: relative; vertical-align: middle; margin-right: 4px;"><span style="position: absolute; top: 2px; left: 3px; width: 6px; height: 2px; background: currentColor; transform: rotate(45deg);"></span></span>Modifica</button>
                                <button class="button secondary" onclick="showOpportunityTasks(${o.id})" style="padding: 6px 10px; font-size: 11px; border: 1.5px solid var(--primary); background: white; color: var(--primary); font-weight: 600; border-radius: 6px;" title="AttivitÃ "><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid currentColor; border-radius: 2px; position: relative; vertical-align: middle; margin-right: 4px;"><span style="position: absolute; top: 2px; left: 2px; width: 8px; height: 2px; background: currentColor;"></span><span style="position: absolute; top: 5px; left: 2px; width: 8px; height: 2px; background: currentColor;"></span><span style="position: absolute; top: 8px; left: 2px; width: 8px; height: 2px; background: currentColor;"></span></span>AttivitÃ </button>
                                <button class="button" onclick="showOpportunityFiles(${o.id})" style="padding: 8px 14px; font-size: 12px; background: var(--success); color: white; font-weight: 600; border-radius: 6px; border: none; box-shadow: 0 2px 4px rgba(34,197,94,0.3); cursor: pointer;" title="Visualizza File Offerte">ðŸ“ File Offerte</button>
                                ${o.folder_path ? `<button class="button secondary" onclick="openOpportunityFolder(${o.id})" style="padding: 6px 10px; font-size: 11px; border: 1.5px solid var(--text-light); background: white; color: var(--text-dark); font-weight: 600; border-radius: 6px;" title="Apri cartella"><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid currentColor; border-radius: 2px; position: relative; vertical-align: middle; margin-right: 4px;"><span style="position: absolute; top: -2px; left: 2px; width: 6px; height: 4px; border: 2px solid currentColor; border-bottom: none; border-radius: 2px 2px 0 0;"></span></span>Cartella</button>` : ''}
                                ${!o.is_my_opportunity ? `<button class="button secondary" onclick="takeOpportunityOwnership(${o.id})" style="padding: 6px 10px; font-size: 11px; border: 1.5px solid var(--primary); background: white; color: var(--primary); font-weight: 600; border-radius: 6px;" title="Prendi ownership"><span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; border: 2px solid currentColor; position: relative; vertical-align: middle; margin-right: 4px;"><span style="position: absolute; top: 2px; left: 2px; width: 4px; height: 4px; background: currentColor; border-radius: 50%;"></span></span>Prendi</button>` : ''}
                                <button class="button" onclick="showCloseOpportunityModal(${o.id})" style="padding: 6px 10px; font-size: 11px; background: var(--primary); color: white; font-weight: 600; border-radius: 6px; border: none; box-shadow: 0 2px 4px rgba(37,99,235,0.3);" title="Chiudi OpportunitÃ "><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid white; border-radius: 2px; position: relative; vertical-align: middle; margin-right: 4px;"><span style="position: absolute; top: 2px; left: 2px; width: 6px; height: 2px; background: white;"></span><span style="position: absolute; top: 5px; left: 2px; width: 6px; height: 2px; background: white;"></span><span style="position: absolute; top: 8px; left: 2px; width: 6px; height: 2px; background: white;"></span></span>Chiudi</button>
                            ` : `
                                <button class="button secondary" onclick="editOpportunity(${o.id})" style="padding: 6px 10px; font-size: 11px; border: 1.5px solid var(--primary); background: white; color: var(--primary); font-weight: 600; border-radius: 6px;" title="Modifica"><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid currentColor; border-radius: 2px; position: relative; vertical-align: middle; margin-right: 4px;"><span style="position: absolute; top: 2px; left: 3px; width: 6px; height: 2px; background: currentColor; transform: rotate(45deg);"></span></span>Modifica</button>
                                <button class="button secondary" onclick="showOpportunityTasks(${o.id})" style="padding: 6px 10px; font-size: 11px; border: 1.5px solid var(--primary); background: white; color: var(--primary); font-weight: 600; border-radius: 6px;" title="AttivitÃ "><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid currentColor; border-radius: 2px; position: relative; vertical-align: middle; margin-right: 4px;"><span style="position: absolute; top: 2px; left: 2px; width: 8px; height: 2px; background: currentColor;"></span><span style="position: absolute; top: 5px; left: 2px; width: 8px; height: 2px; background: currentColor;"></span><span style="position: absolute; top: 8px; left: 2px; width: 8px; height: 2px; background: currentColor;"></span></span>AttivitÃ </button>
                                <button class="button secondary" onclick="showOpportunityFiles(${o.id})" style="padding: 6px 10px; font-size: 11px; border: 1.5px solid var(--success); background: white; color: var(--success); font-weight: 600; border-radius: 6px;" title="Visualizza Offerte"><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid currentColor; border-radius: 2px; position: relative; vertical-align: middle; margin-right: 4px;"><span style="position: absolute; top: 2px; left: 2px; width: 8px; height: 6px; border: 1.5px solid currentColor; border-top: none; border-radius: 0 0 2px 2px;"></span></span>Offerte</button>
                                ${o.folder_path ? `<button class="button secondary" onclick="openOpportunityFolder(${o.id})" style="padding: 6px 10px; font-size: 11px; border: 1.5px solid var(--text-light); background: white; color: var(--text-dark); font-weight: 600; border-radius: 6px;" title="Apri cartella"><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid currentColor; border-radius: 2px; position: relative; vertical-align: middle; margin-right: 4px;"><span style="position: absolute; top: -2px; left: 2px; width: 6px; height: 4px; border: 2px solid currentColor; border-bottom: none; border-radius: 2px 2px 0 0;"></span></span>Cartella</button>` : ''}
                                <button class="button secondary" onclick="reopenOpportunity(${o.id})" style="padding: 6px 10px; font-size: 11px; background: var(--primary); color: white; font-weight: 600; border-radius: 6px; border: none; box-shadow: 0 2px 4px rgba(37,99,235,0.3);" title="Riapri"><span style="display: inline-block; width: 12px; height: 12px; border: 2px solid white; border-radius: 50%; position: relative; vertical-align: middle; margin-right: 4px;"><span style="position: absolute; top: 3px; left: 3px; width: 4px; height: 4px; background: white; border-radius: 50%;"></span></span>Riapri</button>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
            
            // INSERISCI LE RIGHE NEL TBODY!
            tbody.innerHTML = rows;
            
            // Animazione fade-in per le righe
            setTimeout(() => {
                const allRows = tbody.querySelectorAll('tr[data-animate="true"]');
                allRows.forEach((row, index) => {
                    row.style.opacity = '0';
                    row.style.transform = 'translateY(10px)';
                    setTimeout(() => {
                        row.style.transition = 'all 0.3s ease';
                        row.style.opacity = '1';
                        row.style.transform = 'translateY(0)';
                    }, index * 20); // Stagger animation
                });
            }, 50);
        }

        let currentOpportunitiesPage = 1;
        let opportunitiesPagination = null;
        
        async function loadOpportunities(page = 1, accountIdFilter = null) {
            try {
                currentOpportunitiesPage = page;
                const perPage = 50;
                let url = `/api/opportunities?page=${page}&per_page=${perPage}`;
                if (accountIdFilter) {
                    url += `&account_id=${accountIdFilter}`;
                }
                const res = await fetch(url);
                if (!res.ok) {
                    console.error('Errore API opportunitÃ :', res.status, res.statusText);
                    const tbody = document.getElementById('opportunities-table');
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 40px;">Errore nel caricamento delle opportunitÃ  (${res.status})</td></tr>`;
                    }
                    return;
                }
                const data = await res.json();
                if (data.error) {
                    console.error('Errore API:', data.error);
                const tbody = document.getElementById('opportunities-table');
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 40px;">Errore: ${data.error}</td></tr>`;
                    }
                    return;
                }
                allOpportunities = data.opportunities || [];
                opportunitiesPagination = data.pagination || null;
                console.log('Caricate', allOpportunities.length, 'opportunitÃ ');
                
                // Debug: conta opportunitÃ  Unitree
                const unitreeCount = allOpportunities.filter(o => {
                    const cat = (o.supplier_category || '').toUpperCase();
                    return cat.includes('UNITREE');
                }).length;
                console.log(`OpportunitÃ  Unitree trovate: ${unitreeCount}`);
                
                // Debug: mostra prime 5 opportunitÃ  Unitree
                const unitreeOpps = allOpportunities.filter(o => {
                    const cat = (o.supplier_category || '').toUpperCase();
                    return cat.includes('UNITREE');
                }).slice(0, 5);
                if (unitreeOpps.length > 0) {
                    console.log('Prime 5 opportunitÃ  Unitree caricate:', unitreeOpps.map(o => ({
                        id: o.id,
                        name: o.name,
                        category: o.supplier_category,
                        owner: o.owner_name,
                        owner_id: o.owner_id
                    })));
                }
                
                renderOpportunities();
            } catch (err) {
                console.error('Errore caricamento opportunitÃ :', err);
                const tbody = document.getElementById('opportunities-table');
                if (tbody) {
                    tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 40px;">Errore: ${err.message}</td></tr>`;
                }
            }
        }
        
        async function updateOpportunityHeatLevel(oppId, heatLevel) {
            try {
                const res = await fetch(`/api/opportunities/${oppId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ heat_level: heatLevel })
                });
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}` }));
                    throw new Error(errorData.error || `HTTP ${res.status}`);
                }
                
                const data = await res.json();
                if (data.success) {
                    const opp = allOpportunities.find(o => o.id === oppId);
                    if (opp) {
                        opp.heat_level = heatLevel;
                        // Aggiorna anche probability localmente per feedback immediato
                        if (heatLevel === 'calda') {
                            opp.probability = 50;
                        } else if (heatLevel === 'tiepida') {
                            opp.probability = 15;
                        } else if (heatLevel === 'fredda_speranza') {
                            opp.probability = 5;
                        } else if (heatLevel === 'fredda_gelo') {
                            opp.probability = 0;
                        } else {
                            opp.probability = 0;
                        }
                    }
                    renderOpportunities();
                    loadDashboard(); // Ricarica dashboard per aggiornare grafici
                } else {
                    throw new Error(data.error || 'Errore sconosciuto');
                }
            } catch (err) {
                console.error('Errore aggiornamento heat_level:', err);
                alert('Errore: ' + err.message);
            }
        }
        
        async function openOpportunityFolder(oppId) {
            try {
                const res = await fetch(`/api/opportunities/${oppId}/open-folder`, {
                    method: 'POST'
                });
                const data = await res.json();
                if (data.success && data.smb_path) {
                    // Usa lo stesso meccanismo di downloadOpportunityFile per aprire la cartella
                    downloadOpportunityFile(oppId, '', data.smb_path, true);
                } else if (data.success) {
                    // Fallback: mostra percorso e copia negli appunti
                    navigator.clipboard.writeText(data.folder_path).then(() => {
                        alert('ðŸ“ Percorso cartella copiato negli appunti!\n\n' +
                              '1. Apri Esplora File (premi Win+E)\n' +
                              '2. Incolla il percorso nella barra degli indirizzi (Ctrl+V)\n' +
                              '3. Premi Invio\n\n' +
                              'Percorso: ' + data.folder_path);
                    });
                } else {
                    alert('Errore: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }

        async function loadProducts() {
            try {
                // Limita a 50 record su mobile per migliorare performance
                const limit = window.innerWidth <= 768 ? 50 : 100;
                const res = await fetch(`/api/products?limit=${limit}`);
                const data = await res.json();
                const tbody = document.getElementById('products-table');
                
                if (!data.products.length) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">Nessun prodotto. Clicca "Sincronizza Listini" per caricare i prodotti.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.products.map(prod => {
                    const allPrices = prod.prices || [];
                    const priceDisplay = allPrices.map(p => {
                        const amountFormatted = Number(p.amount || 0).toLocaleString('it-IT', {minimumFractionDigits: 2});
                        return `<span class="price-pill">${p.price_level}: â‚¬${amountFormatted}</span>`;
                    }).join('');
                    
                    return `
                        <tr>
                            <td><strong>${prod.code}</strong></td>
                            <td>${prod.name}</td>
                            <td>${prod.category || '-'}</td>
                            <td><div class="price-levels">${priceDisplay || 'Nessun prezzo'}</div></td>
                            <td><button class="button secondary" onclick="openPriceModal(${prod.id})">Modifica</button></td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                console.error(err);
            }
        }

        async function openPriceModal(productId) {
            try {
                const res = await fetch('/api/products');
                const data = await res.json();
                const product = data.products.find(p => p.id === productId);
                
                if (!product) return;
                
                currentProduct = product;
                document.getElementById('modal-product-name').textContent = `${product.code} - ${product.name}`;
                
                const container = document.getElementById('modal-price-inputs');
                const allPrices = product.prices || [];
                
                if (allPrices.length === 0) {
                    container.innerHTML = '<p>Nessun prezzo configurato. Sincronizza i listini prima.</p>';
                } else {
                    container.innerHTML = allPrices.map(p => `
                        <div class="price-input-group">
                            <label>${p.price_level} ${p.is_override ? '(Override)' : ''}</label>
                            <input type="number" step="0.01" value="${p.amount}" data-level="${p.price_level}" placeholder="Prezzo EUR">
                        </div>
                    `).join('');
                }
                
                document.getElementById('price-modal').classList.add('active');
            } catch (err) {
                console.error(err);
                alert('Errore nel caricamento prodotto');
            }
        }

        function closePriceModal() {
            document.getElementById('price-modal').classList.remove('active');
            currentProduct = null;
        }

        async function savePrices() {
            if (!currentProduct) return;
            
            const inputs = document.querySelectorAll('#modal-price-inputs input');
            const updates = [];
            
            inputs.forEach(input => {
                const level = input.dataset.level;
                const newValue = parseFloat(input.value);
                if (!isNaN(newValue) && newValue >= 0) {
                    updates.push({ price_level: level, amount: newValue });
                }
            });
            
            try {
                for (const update of updates) {
                    await fetch(`/api/products/${currentProduct.id}/prices`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(update)
                    });
                }
                alert('Prezzi aggiornati con successo!');
                closePriceModal();
                loadProducts();
            } catch (err) {
                console.error(err);
                alert('Errore nel salvataggio');
            }
        }

        async function syncPricebook() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Sincronizzazione...';
            
            try {
                const res = await fetch('/api/pricebook/sync', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert(`âœ“ ${data.message}`);
                    loadProducts();
                    loadDashboard();
                } else {
                    alert('Errore: ' + (data.error || 'Sincronizzazione fallita'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function syncOffers() {
            if (!confirm('Sincronizzare le offerte dalle cartelle 2025 e 2026?\nQuesto processo puÃ² richiedere alcuni minuti.')) {
                return;
            }
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'ðŸ”„ Sincronizzazione...';
            
            try {
                const res = await fetch('/api/offers/sync', { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    alert(`âœ… ${data.message || 'Sincronizzazione offerte completata!'}`);
                    loadOpportunities();
                    loadDashboard();
                } else {
                    alert('âŒ Errore: ' + (data.error || 'Sincronizzazione fallita'));
                }
            } catch (err) {
                alert('âŒ Errore: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        async function syncUR() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Sincronizzazione...';
            
            // Crea/modifica modale per i log
            let logModal = document.getElementById('ur-sync-log-modal');
            if (!logModal) {
                logModal = document.createElement('div');
                logModal.id = 'ur-sync-log-modal';
                logModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                logModal.innerHTML = `
                    <div style="background: white; border-radius: 8px; padding: 20px; max-width: 800px; max-height: 80vh; width: 90%; display: flex; flex-direction: column;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h2 style="margin: 0;">ðŸ“‹ Log Sincronizzazione UR Portal</h2>
                            <button onclick="closeURLogModal()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">âœ• Chiudi</button>
                        </div>
                        <div id="ur-sync-log-content" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 12px; overflow-y: auto; flex: 1; white-space: pre-wrap; max-height: 60vh;">
                            <div style="color: #4ec9b0;">ðŸš€ Avvio sincronizzazione...</div>
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button onclick="refreshURLogs()" style="background: #007bff; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">ðŸ”„ Aggiorna Log</button>
                            <button onclick="clearURLogs()" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">ðŸ—‘ï¸ Pulisci</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(logModal);
            }
            logModal.style.display = 'flex';
            
            const logContent = document.getElementById('ur-sync-log-content');
            logContent.innerHTML = '<div style="color: #4ec9b0;">ðŸš€ Avvio sincronizzazione...</div>';
            
            // Funzione per aggiungere log
            const addLog = (message, type = 'info') => {
                const colors = {
                    'info': '#4ec9b0',
                    'success': '#4ec9b0',
                    'warning': '#dcdcaa',
                    'error': '#f48771'
                };
                const color = colors[type] || colors.info;
                const timestamp = new Date().toLocaleTimeString();
                logContent.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
                logContent.scrollTop = logContent.scrollHeight;
            };
            
            // Polling dei log durante la sincronizzazione
            let logPollInterval;
            let lastLogCount = 0;
            
            const pollLogs = async () => {
                try {
                    const logRes = await fetch('/api/ur/logs?lines=200');
                    const logData = await logRes.json();
                    if (logData.success && logData.logs.length > lastLogCount) {
                        const newLogs = logData.logs.slice(lastLogCount);
                        newLogs.forEach(line => {
                            if (line.trim()) {
                                let type = 'info';
                                if (line.includes('âŒ') || line.includes('ERRORE') || line.includes('ERROR')) type = 'error';
                                else if (line.includes('âš ') || line.includes('WARNING')) type = 'warning';
                                else if (line.includes('âœ“') || line.includes('âœ…') || line.includes('SUCCESS')) type = 'success';
                                addLog(line, type);
                            }
                        });
                        lastLogCount = logData.logs.length;
                    }
                } catch (e) {
                    // Ignora errori di polling
                }
            };
            
            // Avvia polling ogni 500ms
            logPollInterval = setInterval(pollLogs, 500);
            
            try {
                addLog('ðŸ“¡ Invio richiesta sincronizzazione...', 'info');
                const res = await fetch('/api/ur/sync', { method: 'POST' });
                const data = await res.json();
                
                // Ferma polling
                clearInterval(logPollInterval);
                
                // Ultimo aggiornamento log
                setTimeout(async () => {
                    const logRes = await fetch('/api/ur/logs?lines=200');
                    const logData = await logRes.json();
                    if (logData.success) {
                        logContent.innerHTML = '';
                        logData.logs.forEach(line => {
                            if (line.trim()) {
                                let type = 'info';
                                if (line.includes('âŒ') || line.includes('ERRORE') || line.includes('ERROR')) type = 'error';
                                else if (line.includes('âš ') || line.includes('WARNING')) type = 'warning';
                                else if (line.includes('âœ“') || line.includes('âœ…') || line.includes('SUCCESS')) type = 'success';
                                addLog(line, type);
                            }
                        });
                    }
                }, 1000);
                
                if (data.success) {
                    addLog(`âœ… Sincronizzazione completata! Leads: ${data.stats.leads_imported}, Opportunities: ${data.stats.opportunities_imported}, Accounts: ${data.stats.accounts_created}`, 'success');
                    setTimeout(() => {
                        loadLeads(currentLeadsPage);
                        loadAccounts(currentAccountsPage);
                        loadOpportunities();
                        loadDashboard();
                    }, 2000);
                } else {
                    addLog(`âŒ Errore: ${data.error || JSON.stringify(data.stats?.errors || [])}`, 'error');
                }
            } catch (err) {
                clearInterval(logPollInterval);
                addLog(`âŒ Errore di connessione: ${err.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }
        
        function closeURLogModal() {
            const modal = document.getElementById('ur-sync-log-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        async function refreshURLogs() {
            const logContent = document.getElementById('ur-sync-log-content');
            if (!logContent) return;
            
            try {
                const res = await fetch('/api/ur/logs?lines=200');
                const data = await res.json();
                if (data.success) {
                    logContent.innerHTML = '';
                    data.logs.forEach(line => {
                        if (line.trim()) {
                            let type = 'info';
                            if (line.includes('âŒ') || line.includes('ERRORE') || line.includes('ERROR')) type = 'error';
                            else if (line.includes('âš ') || line.includes('WARNING')) type = 'warning';
                            else if (line.includes('âœ“') || line.includes('âœ…') || line.includes('SUCCESS')) type = 'success';
                            const colors = {
                                'info': '#4ec9b0',
                                'success': '#4ec9b0',
                                'warning': '#dcdcaa',
                                'error': '#f48771'
                            };
                            const color = colors[type] || colors.info;
                            const timestamp = new Date().toLocaleTimeString();
                            logContent.innerHTML += `<div style="color: ${color};">${line}</div>`;
                        }
                    });
                    logContent.scrollTop = logContent.scrollHeight;
                }
            } catch (err) {
                logContent.innerHTML += `<div style="color: #f48771;">Errore caricamento log: ${err.message}</div>`;
            }
        }
        
        function clearURLogs() {
            const logContent = document.getElementById('ur-sync-log-content');
            if (logContent) {
                logContent.innerHTML = '<div style="color: #4ec9b0;">Log puliti</div>';
            }
        }

        let editingLeadId = null;
        let editingAccountId = null;
        let editingOpportunityId = null;

        async function editLead(id) {
            try {
                const res = await fetch(`/api/leads/${id}`);
                const data = await res.json();
                const lead = data.lead;
                
                editingLeadId = id;
                const companyInput = document.querySelector('#lead-form input[name="company_name"]');
                const firstNameInput = document.querySelector('#lead-form input[name="contact_first_name"]');
                const lastNameInput = document.querySelector('#lead-form input[name="contact_last_name"]');
                const emailInput = document.querySelector('#lead-form input[name="email"]');
                const phoneInput = document.querySelector('#lead-form input[name="phone"]');
                const interestSelect = document.querySelector('#lead-form select[name="interest"]');
                const sourceInput = document.querySelector('#lead-form input[name="source"]');
                const ratingSelect = document.querySelector('#lead-form select[name="rating"]');
                const notesTextarea = document.querySelector('#lead-form textarea[name="notes"]');
                
                if (companyInput) companyInput.value = lead.company_name || '';
                if (firstNameInput) firstNameInput.value = lead.contact_first_name || '';
                if (lastNameInput) lastNameInput.value = lead.contact_last_name || '';
                if (emailInput) emailInput.value = lead.email || '';
                if (phoneInput) phoneInput.value = lead.phone || '';
                if (interestSelect) interestSelect.value = lead.interest || '';
                if (sourceInput) sourceInput.value = lead.source || '';
                if (ratingSelect) ratingSelect.value = lead.rating || 'Warm';
                if (notesTextarea) notesTextarea.value = lead.notes || '';
                
                const h3 = document.querySelector('#lead-form-card h3');
                const submitBtn = document.querySelector('#lead-form button[type="submit"]');
                if (h3) h3.textContent = 'Modifica Lead';
                if (submitBtn) submitBtn.textContent = 'Aggiorna Lead';
                showLeadForm();
            } catch (err) {
                alert('Errore nel caricamento: ' + err.message);
            }
        }

        async function editAccount(id) {
            try {
                const res = await fetch(`/api/accounts/${id}`);
                const data = await res.json();
                const account = data.account;
                
                editingAccountId = id;
                const nameInput = document.querySelector('#account-form input[name="name"]');
                const industryInput = document.querySelector('#account-form input[name="industry"]');
                const phoneInput = document.querySelector('#account-form input[name="phone"]');
                const websiteInput = document.querySelector('#account-form input[name="website"]');
                const billingTextarea = document.querySelector('#account-form textarea[name="billing_address"]');
                const shippingTextarea = document.querySelector('#account-form textarea[name="shipping_address"]');
                const descTextarea = document.querySelector('#account-form textarea[name="description"]');
                
                if (nameInput) nameInput.value = account.name || '';
                if (industryInput) industryInput.value = account.industry || '';
                if (phoneInput) phoneInput.value = account.phone || '';
                if (websiteInput) websiteInput.value = account.website || '';
                if (billingTextarea) billingTextarea.value = account.billing_address || '';
                if (shippingTextarea) shippingTextarea.value = account.shipping_address || '';
                if (descTextarea) descTextarea.value = account.description || '';
                
                const h3 = document.querySelector('#account-form-card h3');
                const submitBtn = document.querySelector('#account-form button[type="submit"]');
                if (h3) h3.textContent = 'Modifica Account';
                if (submitBtn) submitBtn.textContent = 'Aggiorna Account';
                showAccountForm();
            } catch (err) {
                alert('Errore nel caricamento: ' + err.message);
            }
        }

        async function editOpportunity(id) {
            try {
                const res = await fetch(`/api/opportunities/${id}`);
                const data = await res.json();
                const opp = data.opportunity;
                
                editingOpportunityId = id;
                const nameInput = document.querySelector('#opportunity-form input[name="name"]');
                const stageSelect = document.querySelector('#opportunity-form select[name="stage"]');
                const amountInput = document.querySelector('#opportunity-form input[name="amount"]');
                const probInput = document.querySelector('#opportunity-form input[name="probability"]');
                const closeDateInput = document.querySelector('#opportunity-form input[name="close_date"]');
                const typeInput = document.querySelector('#opportunity-form input[name="opportunity_type"]');
                const descTextarea = document.querySelector('#opportunity-form textarea[name="description"]');
                
                if (nameInput) nameInput.value = opp.name || '';
                if (stageSelect) stageSelect.value = opp.stage || 'Qualification';
                if (amountInput) amountInput.value = opp.amount || '';
                if (probInput) probInput.value = opp.probability || '';
                if (closeDateInput && opp.close_date) {
                    const date = new Date(opp.close_date);
                    closeDateInput.value = date.toISOString().split('T')[0];
                } else if (closeDateInput) {
                    closeDateInput.value = '';
                }
                if (typeInput) typeInput.value = opp.opportunity_type || '';
                if (descTextarea) descTextarea.value = opp.description || '';
                
                const categorySelect = document.querySelector('#opportunity-form select[name="supplier_category"]');
                if (categorySelect) {
                    categorySelect.value = opp.supplier_category || '';
                }
                
                const formCard = document.querySelector('#opportunity-form-card') || document.querySelector('#opportunity-form').closest('.card');
                if (formCard) {
                    const h3 = formCard.querySelector('h3');
                    const submitBtn = formCard.querySelector('button[type="submit"]');
                    if (h3) h3.textContent = 'Modifica OpportunitÃ ';
                    if (submitBtn) submitBtn.textContent = 'Aggiorna OpportunitÃ ';
                    formCard.style.display = 'block';
                    
                    // Scroll verso l'alto per mostrare il form
                    formCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
                showOpportunityForm();
            } catch (err) {
                alert('Errore nel caricamento: ' + err.message);
            }
        }

        async function convertLead(id) {
            if (!confirm('Vuoi convertire questo lead? VerrÃ  creato un Account, un Contact e un\'OpportunitÃ .')) {
                return;
            }
            try {
                const res = await fetch(`/api/leads/${id}/convert`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert('âœ… Lead convertito con successo! Account, Contact e OpportunitÃ  creati.');
                loadLeads();
                loadAccounts();
                loadOpportunities();
                } else {
                    alert('Errore: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        async function revertLeadConversion(id) {
            if (!confirm('Vuoi annullare la conversione di questo lead? Lo stato tornerÃ  a "Qualified".')) {
                return;
            }
            try {
                const res = await fetch(`/api/leads/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'Qualified' })
                });
                const data = await res.json();
                if (data.success) {
                    alert('âœ… Conversione annullata!');
                    loadLeads(currentLeadsPage);
                } else {
                    alert('Errore: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        // Gestione AttivitÃ  OpportunitÃ 
        let currentOpportunityIdForTasks = null;
        
        async function showOpportunityFiles(oppId) {
            const modal = document.getElementById('opportunity-files-modal');
            const loading = document.getElementById('opportunity-files-loading');
            const content = document.getElementById('opportunity-files-content');
            const filesList = document.getElementById('opportunity-files-list');
            const title = document.getElementById('opportunity-files-modal-title');
            
            modal.style.display = 'flex';
            loading.style.display = 'block';
            content.style.display = 'none';
            filesList.innerHTML = '';
            
            // Mostra log di ricerca
            const loadingText = loading.querySelector('p') || document.createElement('p');
            loadingText.innerHTML = 'ðŸ” Ricerca file in corso...<br><span style="font-size: 12px; color: var(--text-light);">Questo potrebbe richiedere alcuni secondi</span>';
            if (!loading.querySelector('p')) {
                loading.appendChild(loadingText);
            }
            
            const startTime = Date.now();
            
            try {
                // Timeout piÃ¹ lungo per la ricerca
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 secondi
                
                const response = await fetch(`/api/opportunities/${oppId}/files`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                if (!response.ok) throw new Error('Errore caricamento file');
                
                const data = await response.json();
                const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
                
                // Trova il nome dell'opportunitÃ 
                const opp = allOpportunities.find(o => o.id === oppId);
                const oppName = opp ? opp.name : 'OpportunitÃ ';
                title.textContent = `ðŸ“ File Offerte - ${oppName}`;
                
                // Mostra informazioni di ricerca
                let searchInfo = '';
                if (data.debug_info && data.debug_info.length > 0) {
                    searchInfo = `<div style="margin-bottom: 16px; padding: 12px; background: var(--bg-light); border-radius: 8px; font-size: 12px;">
                        <strong>â±ï¸ Tempo di ricerca:</strong> ${elapsedTime}s<br>
                        <strong>ðŸ“‚ File trovati:</strong> ${data.files_found || 0}<br>
                        <details style="margin-top: 8px;">
                            <summary style="cursor: pointer; color: var(--primary);">ðŸ” Dettagli ricerca</summary>
                            <ul style="margin-top: 8px; padding-left: 20px; color: var(--text-medium);">
                                ${data.debug_info.map(info => `<li>${info}</li>`).join('')}
                            </ul>
                        </details>
                    </div>`;
                }
                
                if (data.files && data.files.length > 0) {
                    filesList.innerHTML = searchInfo + data.files.map(file => {
                        const fileSize = file.size > 0 ? (file.size / 1024).toFixed(2) : '0';
                        const fileIcon = file.is_folder_link ? 'ðŸ“' : getFileIcon(file.extension);
                        const fileType = file.type === 'offer_folder' || file.type === 'offer_folder_link' ? `Offerta ${file.offer_number || ''}` : 'Cartella OpportunitÃ ';
                        const smbPath = file.smb_path || null;
                        const isFolder = file.is_folder_link || false;
                        const onClickAction = smbPath ? 
                            `downloadOpportunityFile(${oppId}, '${file.name.replace(/'/g, "\\'")}', '${smbPath.replace(/'/g, "\\'").replace(/\\/g, '\\\\')}', ${isFolder})` :
                            `downloadOpportunityFile(${oppId}, '${file.name.replace(/'/g, "\\'")}')`;
                        
                        return `
                            <div class="card" style="padding: 16px; display: flex; align-items: center; gap: 16px; cursor: pointer; transition: all 0.2s;" 
                                 onmouseover="this.style.background='var(--bg-light)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.1)'" 
                                 onmouseout="this.style.background='white'; this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                                 onclick="${onClickAction}">
                                <div style="font-size: 32px; flex-shrink: 0;">${fileIcon}</div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.name}">${file.name}</div>
                                    <div style="font-size: 12px; color: var(--text-medium);">
                                        <span style="background: var(--bg-light); padding: 2px 8px; border-radius: 4px; margin-right: 8px;">${fileType}</span>
                                        ${file.size > 0 ? `<span>${fileSize} KB</span>` : '<span style="color: var(--primary);">Link SMB</span>'}
                                        <span style="margin-left: 8px; text-transform: uppercase;">${file.extension || 'file'}</span>
                                    </div>
                                </div>
                                <div style="flex-shrink: 0;">
                                    <button class="button" style="padding: 8px 16px; font-size: 12px;">${file.is_folder_link ? 'Apri' : 'Scarica'}</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    // Nessun file trovato - mostra opzioni per riassociare cartelle
                    let debugHtml = '';
                    let reassociateHtml = '';
                    
                    if (data.debug_info && data.debug_info.length > 0) {
                        debugHtml = `<div style="margin-top: 16px; padding: 12px; background: var(--bg-light); border-radius: 8px; text-align: left;">
                            <p style="font-weight: 600; margin-bottom: 8px;">ðŸ” Informazioni di ricerca:</p>
                            <ul style="font-size: 11px; color: var(--text-medium); margin: 0; padding-left: 20px;">
                                ${data.debug_info.map(info => `<li>${info}</li>`).join('')}
                            </ul>
                        </div>`;
                    }
                    
                    // Mostra opzione per riassociare cartelle se ci sono offerte associate
                    if (data.offers_count > 0) {
                        reassociateHtml = `
                            <div style="margin-top: 24px; padding: 16px; background: #e7f3ff; border: 2px solid #2196F3; border-radius: 8px;">
                                <p style="font-weight: 600; margin-bottom: 12px; color: #1976D2;">ðŸ”— Riassocia Cartelle Offerte</p>
                                <p style="font-size: 12px; color: #424242; margin-bottom: 12px;">
                                    Le cartelle delle offerte non sono state trovate. Puoi cercare e riassociare manualmente le cartelle:
                                </p>
                                <div id="reassociate-offers-container"></div>
                            </div>
                        `;
                    }
                    
                    filesList.innerHTML = searchInfo + `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“‚</div>
                            <p style="font-size: 16px; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">
                                Nessun file trovato
                            </p>
                            <p style="font-size: 12px; color: var(--text-medium); margin-bottom: 16px;">
                                ${data.offers_count || 0} offerte associate, ma le cartelle non sono state trovate.
                            </p>
                            ${debugHtml}
                            ${reassociateHtml}
                        </div>
                    `;
                    
                    // Carica offerte per riassociazione
                    if (data.offers_count > 0) {
                        loadOffersForReassociation(oppId);
                    }
                }
                
                loading.style.display = 'none';
                content.style.display = 'block';
            } catch (error) {
                console.error('Errore caricamento file:', error);
                const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
                loadingText.innerHTML = `âŒ Errore dopo ${elapsedTime}s: ${error.message}`;
                setTimeout(() => {
                    loading.style.display = 'none';
                    content.style.display = 'block';
                    filesList.innerHTML = `
                        <div class="card" style="padding: 40px; text-align: center; color: var(--text-medium);">
                            <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
                            <p style="font-weight: 600; margin-bottom: 12px;">Errore durante la ricerca</p>
                            <p style="font-size: 12px; color: var(--text-light);">${error.message}</p>
                            <p style="font-size: 11px; margin-top: 12px; color: var(--text-light);">Tempo trascorso: ${elapsedTime}s</p>
                        </div>
                    `;
                }, 2000);
                loading.innerHTML = `
                    <div style="color: var(--danger);">
                        <div style="font-size: 48px; margin-bottom: 16px;">âŒ</div>
                        <p>Errore nel caricamento dei file.</p>
                        <p style="font-size: 12px; margin-top: 8px;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        function closeOpportunityFilesModal() {
            document.getElementById('opportunity-files-modal').style.display = 'none';
        }
        
        function downloadOpportunityFile(oppId, filename, smbPath = null, isFolder = false) {
            // Se abbiamo un percorso SMB, prova ad aprire direttamente
            if (smbPath) {
                // Rimuovi "Apri cartella" se presente
                const cleanPath = smbPath.replace(/Apri cartella:?\s*/i, '').trim();
                
                // Prova ad aprire direttamente usando vari metodi
                let opened = false;
                
                // Metodo 1: Prova con link file:// (puÃ² essere bloccato)
                try {
                    const link = document.createElement('a');
                    link.href = 'file:///' + cleanPath.replace(/\\\\/g, '/');
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    setTimeout(() => document.body.removeChild(link), 100);
                    opened = true;
                } catch (e) {
                    // Browser blocca file:// per percorsi UNC
                }
                
                // Metodo 2: Prova con ActiveX (solo IE/Edge legacy)
                if (!opened) {
                    try {
                        if (window.ActiveXObject) {
                            const shell = new ActiveXObject('Shell.Application');
                            shell.Open(cleanPath);
                            opened = true;
                        }
                    } catch (e) {
                        // ActiveX non disponibile
                    }
                }
                
                // Metodo 3: Copia negli appunti e mostra istruzioni
                navigator.clipboard.writeText(cleanPath).then(() => {
                    if (isFolder || cleanPath !== smbPath) {
                        // Ãˆ una cartella
                        if (opened) {
                            alert('âœ… Cartella aperta!\n\nPercorso copiato negli appunti: ' + cleanPath);
                        } else {
                            alert('ðŸ“ Percorso cartella copiato negli appunti!\n\n' +
                                  '1. Apri Esplora File (premi Win+E)\n' +
                                  '2. Incolla il percorso nella barra degli indirizzi (Ctrl+V)\n' +
                                  '3. Premi Invio\n\n' +
                                  'Percorso: ' + cleanPath);
                        }
                    } else {
                        // Ãˆ un file - apri la cartella contenente
                        const folderPath = cleanPath.substring(0, cleanPath.lastIndexOf('\\'));
                        if (opened) {
                            alert('âœ… Cartella aperta!\n\nCerca il file: ' + filename + '\n\n' +
                                  'Percorso file: ' + cleanPath);
                        } else {
                            alert('ðŸ“„ Percorso file copiato negli appunti!\n\n' +
                                  '1. Apri Esplora File (premi Win+E)\n' +
                                  '2. Incolla il percorso nella barra degli indirizzi (Ctrl+V)\n' +
                                  '3. Premi Invio per aprire la cartella\n' +
                                  '4. Cerca il file: ' + filename + '\n\n' +
                                  'Percorso cartella: ' + folderPath + '\n' +
                                  'Percorso file completo: ' + cleanPath);
                        }
                    }
                }).catch(() => {
                    // Fallback per browser vecchi
                    const textArea = document.createElement('textarea');
                    textArea.value = cleanPath;
                    textArea.style.position = 'fixed';
                    textArea.style.opacity = '0';
                    textArea.style.left = '-9999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        alert('âœ… Percorso copiato negli appunti!\n\n' +
                              'Apri Esplora File e incolla nella barra degli indirizzi.\n\n' +
                              'Percorso: ' + cleanPath);
                    } catch (e) {
                        document.body.removeChild(textArea);
                        alert('âš ï¸ Impossibile copiare automaticamente.\n\n' +
                              'Copia manualmente questo percorso:\n\n' + cleanPath);
                    }
                });
                return;
            }
            
            // Altrimenti usa l'endpoint normale che genererÃ  il link SMB
            window.location.href = `/api/opportunities/${oppId}/files/${encodeURIComponent(filename)}`;
        }
        
        async function loadOffersForReassociation(oppId) {
            const container = document.getElementById('reassociate-offers-container');
            if (!container) return;
            
            try {
                // Recupera opportunitÃ  con offerte
                const oppResponse = await fetch(`/api/opportunities/${oppId}`);
                const oppData = await oppResponse.json();
                
                if (oppData.success && oppData.opportunity.offers) {
                    container.innerHTML = oppData.opportunity.offers.map(offer => `
                        <div style="margin-bottom: 12px; padding: 12px; background: white; border-radius: 6px; border: 1px solid #ddd;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="font-size: 13px;">${offer.number || 'N/A'}</strong>
                                    <div style="font-size: 11px; color: var(--text-medium); margin-top: 4px;">
                                        Cartella attuale: ${offer.folder_path || 'Nessuna'}
                                    </div>
                                </div>
                                <button onclick="searchAndReassociateFolder(${offer.id}, '${(offer.number || '').replace(/'/g, "\\'")}')" 
                                        class="button" style="padding: 6px 12px; font-size: 11px;">
                                    ðŸ” Cerca Cartella
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Errore caricamento offerte:', error);
            }
        }
        
        async function searchAndReassociateFolder(offerId, offerNumber) {
            try {
                // Cerca cartelle disponibili
                const response = await fetch(`/api/offers/${offerId}/search-folders`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success && data.possible_folders.length > 0) {
                    // Mostra dialog per selezionare cartella
                    const folderList = data.possible_folders.map((f, i) => `${i + 1}. ${f.name}`).join('\n');
                    
                    const selectedPath = prompt(
                        `Seleziona cartella per offerta ${offerNumber}:\n\n${folderList}\n\n` +
                        `Inserisci il numero (1-${data.possible_folders.length}) o il percorso completo:`
                    );
                    
                    if (selectedPath) {
                        let folderPath = selectedPath;
                        // Se Ã¨ un numero, usa l'indice
                        const num = parseInt(selectedPath);
                        if (!isNaN(num) && num > 0 && num <= data.possible_folders.length) {
                            folderPath = data.possible_folders[num - 1].path;
                        }
                        
                        // Aggiorna offerta
                        await updateOfferFolder(offerId, folderPath);
                    }
                } else {
                    alert('Nessuna cartella trovata. Inserisci manualmente il percorso della cartella.');
                    const manualPath = prompt(`Inserisci il percorso completo della cartella per offerta ${offerNumber}:`);
                    if (manualPath) {
                        await updateOfferFolder(offerId, manualPath);
                    }
                }
            } catch (error) {
                console.error('Errore ricerca cartelle:', error);
                alert('Errore durante la ricerca delle cartelle. Inserisci manualmente il percorso.');
                const manualPath = prompt(`Inserisci il percorso completo della cartella per offerta ${offerNumber}:`);
                if (manualPath) {
                    await updateOfferFolder(offerId, manualPath);
                }
            }
        }
        
        async function updateOfferFolder(offerId, folderPath) {
            try {
                const response = await fetch(`/api/offers/${offerId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({folder_path: folderPath})
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('âœ… Cartella riassociata con successo!');
                    // Ricarica i file - trova l'opportunitÃ  associata
                    const oppResponse = await fetch(`/api/offers/${offerId}`);
                    const offerData = await oppResponse.json();
                    if (offerData.success && offerData.offer.opportunity_id) {
                        showOpportunityFiles(offerData.offer.opportunity_id);
                    }
                } else {
                    alert('âŒ Errore durante la riassociazione: ' + (data.error || 'Errore sconosciuto'));
                }
            } catch (error) {
                console.error('Errore aggiornamento cartella:', error);
                alert('âŒ Errore durante la riassociazione della cartella');
            }
        }
        
        function getFileIcon(extension) {
            const icons = {
                '.pdf': 'ðŸ“„',
                '.docx': 'ðŸ“',
                '.doc': 'ðŸ“',
                '.xlsx': 'ðŸ“Š',
                '.xls': 'ðŸ“Š',
                '.pptx': 'ðŸ“Š',
                '.ppt': 'ðŸ“Š',
                '.png': 'ðŸ–¼ï¸',
                '.jpg': 'ðŸ–¼ï¸',
                '.jpeg': 'ðŸ–¼ï¸',
                '.gif': 'ðŸ–¼ï¸',
                '.zip': 'ðŸ“¦',
                '.rar': 'ðŸ“¦',
                '.txt': 'ðŸ“„',
                '.csv': 'ðŸ“Š'
            };
            return icons[extension?.toLowerCase()] || 'ðŸ“„';
        }
        
        async function showOpportunityTasks(oppId) {
            currentOpportunityIdForTasks = oppId;
            const modal = document.getElementById('opportunity-tasks-modal');
            const title = document.getElementById('opportunity-tasks-modal-title');
            
            // Trova il nome dell'opportunitÃ 
            const opp = allOpportunities.find(o => o.id === oppId);
            if (opp) {
                title.textContent = `ðŸ“‹ AttivitÃ : ${opp.name}`;
            }
            
            modal.style.display = 'flex';
            modal.classList.add('active');
            await loadUsersForTasks();
            await loadOpportunityTasks(oppId);
        }
        
        function closeOpportunityTasksModal() {
            const modal = document.getElementById('opportunity-tasks-modal');
            modal.style.display = 'none';
            modal.classList.remove('active');
            currentOpportunityIdForTasks = null;
            resetTaskForm();
        }
        
        async function loadUsersForTasks() {
            try {
                const res = await fetch('/api/users/commerciali');
                const data = await res.json();
                const select = document.getElementById('task-assigned-to-select');
                if (select && data.users) {
                    select.innerHTML = '<option value="">-- Nessuno --</option>' + 
                        data.users.map(u => `<option value="${u.id}">${u.name || u.username}</option>`).join('');
                }
            } catch (err) {
                console.error('Errore caricamento utenti:', err);
            }
        }
        
        async function loadOpportunityTasks(oppId) {
            try {
                const res = await fetch(`/api/opportunities/${oppId}/tasks`);
                const data = await res.json();
                const container = document.getElementById('opportunity-tasks-list');
                
                if (!data.tasks || data.tasks.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-medium);">Nessuna attivitÃ . Crea la prima attivitÃ !</div>';
                    return;
                }
                
                const taskTypeLabels = {
                    'call': 'ðŸ“ž CHIAMARE',
                    'visit': 'ðŸš— ANDARE IN VISITA',
                    'send_offer': 'ðŸ“„ MANDARE OFFERTA',
                    'email': 'âœ‰ï¸ INVIARE EMAIL',
                    'meeting': 'ðŸ¤ FISSARE RIUNIONE',
                    'follow_up': 'ðŸ”„ FOLLOW-UP',
                    'demo': 'ðŸŽ¬ DEMONSTRAZIONE',
                    'proposal': 'ðŸ“‹ PREPARARE PROPOSTA',
                    'other': 'ðŸ“ ALTRO'
                };
                
                // Usa la stessa mappa per le attivitÃ  dell'utente
                window.taskTypeLabels = taskTypeLabels;
                
                container.innerHTML = data.tasks.map(task => {
                    const dueDate = task.due_date ? new Date(task.due_date).toLocaleDateString('it-IT') : 'Nessuna scadenza';
                    const isOverdue = task.due_date && !task.is_completed && new Date(task.due_date) < new Date();
                    const completedClass = task.is_completed ? 'style="opacity: 0.6; text-decoration: line-through;"' : '';
                    const overdueStyle = isOverdue ? 'style="border-left: 4px solid var(--danger); background: var(--danger-light);"' : '';
                    
                    return `
                        <div class="card" ${overdueStyle} style="margin-bottom: 12px; padding: 16px; ${completedClass}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div>
                                    <strong style="font-size: 16px; color: var(--text-dark);">${taskTypeLabels[task.task_type] || task.task_type}</strong>
                                    ${task.description ? `<p style="margin-top: 8px; color: var(--text-medium);">${task.description}</p>` : ''}
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    ${!task.is_completed ? `<button class="button secondary" onclick="completeTask(${oppId}, ${task.id})" style="padding: 4px 12px; font-size: 12px;">âœ“ Completata</button>` : ''}
                                    <button class="button secondary" onclick="deleteTask(${oppId}, ${task.id})" style="padding: 4px 12px; font-size: 12px; background: var(--danger); color: white;">ðŸ—‘ï¸ Elimina</button>
                                </div>
                            </div>
                            <div style="display: flex; gap: 16px; font-size: 13px; color: var(--text-medium); flex-wrap: wrap;">
                                <span>ðŸ‘¤ ${task.assigned_to_name || 'Non assegnato'}</span>
                                <span>ðŸ“… ${dueDate}</span>
                                ${task.is_completed ? `<span style="color: var(--success);">âœ“ Completata ${task.completed_at ? new Date(task.completed_at).toLocaleDateString('it-IT') : ''}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('Errore caricamento attivitÃ :', err);
                document.getElementById('opportunity-tasks-list').innerHTML = 
                    '<div style="text-align: center; padding: 40px; color: var(--danger);">Errore nel caricamento delle attivitÃ </div>';
            }
        }
        
        document.getElementById('opportunity-task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentOpportunityIdForTasks) return;
            
            const formData = new FormData(e.target);
            const data = {
                task_type: formData.get('task_type'),
                description: formData.get('description') || '',
                assigned_to_id: formData.get('assigned_to_id') || null,
                due_date: formData.get('due_date') || null
            };
            
            try {
                const res = await fetch(`/api/opportunities/${currentOpportunityIdForTasks}/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    alert('âœ… AttivitÃ  creata con successo!');
                    resetTaskForm();
                    await loadOpportunityTasks(currentOpportunityIdForTasks);
                } else {
                    alert('Errore: ' + (result.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        });
        
        function resetTaskForm() {
            document.getElementById('opportunity-task-form').reset();
        }
        
        async function completeTask(oppId, taskId) {
            try {
                const res = await fetch(`/api/opportunities/${oppId}/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_completed: true })
                });
                const data = await res.json();
                if (data.success) {
                    await loadOpportunityTasks(oppId);
                } else {
                    alert('Errore: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        async function deleteTask(oppId, taskId) {
            if (!confirm('Vuoi eliminare questa attivitÃ ?')) return;
            try {
                const res = await fetch(`/api/opportunities/${oppId}/tasks/${taskId}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                if (data.success) {
                    await loadOpportunityTasks(oppId);
                    if (document.getElementById('my-tasks-view').classList.contains('active')) {
                        await loadMyTasks();
                    }
                } else {
                    alert('Errore: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        // Gestione Mie AttivitÃ 
        let currentMyTasksTab = 'all';
        let allMyTasks = [];
        
        function switchMyTasksTab(tab) {
            currentMyTasksTab = tab;
            
            // Aggiorna tab attive
            const buttons = document.querySelectorAll('[data-my-tasks-tab]');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                btn.style.opacity = '0.7';
            });
            
            const activeBtn = document.querySelector(`[data-my-tasks-tab="${tab}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.opacity = '1';
            }
            
            renderMyTasks();
        }
        
        async function loadMyTasks() {
            try {
                const res = await fetch('/api/my-tasks');
                const data = await res.json();
                allMyTasks = [
                    ...(data.global_tasks || []),
                    ...(data.opportunity_tasks || [])
                ];
                renderMyTasks();
            } catch (err) {
                console.error('Errore caricamento mie attivitÃ :', err);
                const container = document.getElementById('my-tasks-container');
                if (container) {
                    container.innerHTML = 
                        '<div style="text-align: center; padding: 40px; color: var(--danger);">Errore nel caricamento delle attivitÃ </div>';
                }
            }
        }
        
        function renderMyTasks() {
            const container = document.getElementById('my-tasks-container');
            if (!container) return;
            
            let filtered = allMyTasks;
            
            if (currentMyTasksTab === 'pending') {
                filtered = allMyTasks.filter(t => !t.is_completed);
            } else if (currentMyTasksTab === 'completed') {
                filtered = allMyTasks.filter(t => t.is_completed);
            } else if (currentMyTasksTab === 'overdue') {
                const now = new Date();
                filtered = allMyTasks.filter(t => {
                    if (t.is_completed || !t.due_date) return false;
                    return new Date(t.due_date) < now;
                });
            }
            
            if (!filtered.length) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 40px;">
                        <div style="font-size: 48px; margin-bottom: 16px;">ðŸ“­</div>
                        <h3 style="color: var(--text-dark); margin-bottom: 8px; font-weight: 600;">Nessuna attivitÃ  trovata</h3>
                        <p style="color: var(--text-medium); font-weight: 500;">${currentMyTasksTab !== 'all' ? `Nessuna attivitÃ  per questo filtro` : 'Non hai attivitÃ  assegnate!'}</p>
                    </div>
                `;
                return;
            }
            
            const taskTypeLabels = window.taskTypeLabels || {
                'call': 'ðŸ“ž CHIAMARE',
                'visit': 'ðŸš— ANDARE IN VISITA',
                'send_offer': 'ðŸ“„ MANDARE OFFERTA',
                'email': 'âœ‰ï¸ INVIARE EMAIL',
                'meeting': 'ðŸ¤ FISSARE RIUNIONE',
                'follow_up': 'ðŸ”„ FOLLOW-UP',
                'demo': 'ðŸŽ¬ DEMONSTRAZIONE',
                'proposal': 'ðŸ“‹ PREPARARE PROPOSTA',
                'other': 'ðŸ“ ALTRO'
            };
            
            container.innerHTML = filtered.map(task => {
                const dueDate = task.due_date ? new Date(task.due_date).toLocaleDateString('it-IT') : 'Nessuna scadenza';
                const isOverdue = task.due_date && !task.is_completed && new Date(task.due_date) < new Date();
                const completedClass = task.is_completed ? 'style="opacity: 0.6; text-decoration: line-through;"' : '';
                const overdueStyle = isOverdue ? 'style="border-left: 4px solid var(--danger); background: var(--danger-light);"' : '';
                const taskLabel = taskTypeLabels[task.task_type] || task.task_type;
                
                return `
                    <div class="card" ${overdueStyle} style="margin-bottom: 12px; padding: 16px; ${completedClass}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; flex-wrap: wrap; gap: 12px;">
                            <div style="flex: 1; min-width: 250px;">
                                <strong style="font-size: 16px; color: var(--text-dark);">${taskLabel}</strong>
                                ${task.description ? `<p style="margin-top: 8px; color: var(--text-medium);">${task.description}</p>` : ''}
                                ${task.opportunity_name ? `<p style="margin-top: 4px; font-size: 13px; color: var(--text-medium);"><strong>OpportunitÃ :</strong> ${task.opportunity_name}</p>` : ''}
                                ${task.account_name ? `<p style="margin-top: 4px; font-size: 13px; color: var(--text-medium);"><strong>Account:</strong> ${task.account_name}</p>` : ''}
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                ${!task.is_completed ? `<button class="button secondary" onclick="completeMyTask(${task.opportunity_id || 'null'}, ${task.id})" style="padding: 6px 12px; font-size: 12px;">âœ“ Completata</button>` : ''}
                                ${task.opportunity_id ? `<button class="button secondary" onclick="viewOpportunityFromTask(${task.opportunity_id})" style="padding: 6px 12px; font-size: 12px;">ðŸ‘ï¸ Vedi OpportunitÃ </button>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; font-size: 13px; color: var(--text-medium); flex-wrap: wrap;">
                            <span>ðŸ“… ${dueDate}</span>
                            ${task.is_completed ? `<span style="color: var(--success);">âœ“ Completata ${task.completed_at ? new Date(task.completed_at).toLocaleDateString('it-IT') : ''}</span>` : ''}
                            ${isOverdue ? `<span style="color: var(--danger); font-weight: 600;">âš ï¸ SCADUTA</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function completeMyTask(oppId, taskId) {
            try {
                let res;
                if (oppId && oppId !== 'null') {
                    res = await fetch(`/api/opportunities/${oppId}/tasks/${taskId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ is_completed: true })
                    });
                } else {
                    res = await fetch(`/api/tasks/${taskId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ is_completed: true })
                    });
                }
                const data = await res.json();
                if (data.success) {
                    await loadMyTasks();
                } else {
                    alert('Errore: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        function viewOpportunityFromTask(oppId) {
            // Cambia vista e carica opportunitÃ 
            const navItem = document.querySelector(`[data-target="opportunities-view"]`);
            if (navItem) {
                navItem.click();
                setTimeout(() => {
                    loadOpportunities();
                    // Scroll alla riga dell'opportunitÃ 
                    setTimeout(() => {
                        const row = document.querySelector(`[data-opp-id="${oppId}"]`);
                        if (row) {
                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            row.style.background = '#fef3c7';
                            setTimeout(() => row.style.background = '', 2000);
                        }
                    }, 500);
                }, 100);
            }
        }

        async function loadOffers() {
            try {
                const res = await fetch('/api/offers');
                const data = await res.json();
                const tbody = document.getElementById('offers-table');
                
                if (!data.offers.length) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">Nessuna offerta generata.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.offers.map(o => {
                    const amountFormatted = Number(o.amount || 0).toLocaleString('it-IT');
                    return `
                    <tr>
                        <td><strong>${o.number}</strong></td>
                        <td>-</td>
                        <td>â‚¬${amountFormatted}</td>
                        <td>${o.created_at ? new Date(o.created_at).toLocaleDateString('it-IT') : '-'}</td>
                        <td>${o.pdf_path ? `<a href="/offers/download?path=${encodeURIComponent(o.pdf_path)}" target="_blank" class="button secondary">PDF</a>` : ''}</td>
                    </tr>
                `;
                }).join('');
            } catch (err) {
                console.error(err);
            }
        }

        document.getElementById('offer-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const status = document.getElementById('offer-status');
            status.textContent = 'âš ï¸ FunzionalitÃ  in sviluppo - Non disponibile al momento';
            status.style.color = 'var(--warning)';
            return false;
        });

        // Funzione filtro tabelle
        function filterTable(tableId, searchText) {
            const table = document.getElementById(tableId);
            const rows = table.getElementsByTagName('tr');
            const searchLower = searchText.toLowerCase();
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const text = row.textContent || row.innerText;
                if (text.toLowerCase().indexOf(searchLower) > -1) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }
        
        // ========== EMAIL MARKETING FUNCTIONS ==========
        
        // Variabili globali
        let emailMarketingData = { lists: [], templates: [], campaigns: [] };
        
        // Tab switching
        function switchEmailTab(tabName) {
            document.querySelectorAll('.email-tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.email-tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabName}"]`)?.classList.add('active');
            document.getElementById(`email-tab-${tabName}`)?.classList.add('active');
            
            if (tabName === 'campaigns') loadEmailCampaigns();
            if (tabName === 'lists') loadEmailLists();
            if (tabName === 'templates') loadEmailTemplates();
            if (tabName === 'compose') loadComposeForm();
        }
        
        // Main loader
        async function loadEmailMarketing() {
            await Promise.all([
                loadEmailCampaigns(),
                loadEmailLists(),
                loadEmailTemplates(),
                loadComposeForm()
            ]);
        }
        
        // ==================== TICKET MANAGEMENT ====================
        let currentTicketTab = 'all';
        let allTickets = [];
        let isOperatore = false;
        
        function switchTicketTab(tab) {
            currentTicketTab = tab;
            document.querySelectorAll('[data-ticket-tab]').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-ticket-tab="${tab}"]`)?.classList.add('active');
            renderTickets();
        }
        
        function filterTickets() {
            renderTickets();
        }
        
        function renderTickets() {
            const tbody = document.getElementById('tickets-table');
            let filtered = [...allTickets];
            
            // Filtro per tab
            if (currentTicketTab === 'my') {
                filtered = filtered.filter(t => t.is_my_ownership);
            } else if (currentTicketTab === 'open') {
                filtered = filtered.filter(t => ['Aperto', 'In Lavorazione', 'In Attesa Cliente'].includes(t.status));
            } else if (currentTicketTab === 'closed') {
                filtered = filtered.filter(t => t.status === 'Chiuso');
            }
            
            // Filtro per ricerca
            const searchTerm = document.getElementById('tickets-search')?.value.toLowerCase() || '';
            if (searchTerm) {
                filtered = filtered.filter(t => 
                    (t.ticket_number || '').toLowerCase().includes(searchTerm) ||
                    (t.title || '').toLowerCase().includes(searchTerm) ||
                    (t.customer_name || '').toLowerCase().includes(searchTerm)
                );
            }
            
            if (!filtered.length) {
                tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 40px;">Nessun ticket ${currentTicketTab !== 'all' ? `per il filtro selezionato` : ''}.</td></tr>`;
                return;
            }
            
            tbody.innerHTML = filtered.map(t => {
                const statusColors = {
                    'Aperto': 'blue',
                    'In Lavorazione': 'orange',
                    'In Attesa Cliente': 'amber',
                    'Chiuso': 'green'
                };
                const priorityColors = {
                    'Bassa': 'gray',
                    'Media': 'blue',
                    'Alta': 'orange',
                    'Urgente': 'red'
                };
                const statusColor = statusColors[t.status] || 'blue';
                const priorityColor = priorityColors[t.priority] || 'blue';
                const createdDate = t.created_at ? new Date(t.created_at).toLocaleDateString('it-IT') : '';
                
                // Gestione categoria prodotto multipla
                let productTags = '';
                if (t.product_category) {
                    if (t.product_category.includes(',')) {
                        const products = t.product_category.split(',').map(p => p.trim());
                        productTags = products.map(p => {
                            const color = p.includes('MiR') || p.includes('MIR') ? 'blue' : 
                                         p.includes('UR') || p.includes('Universal') ? 'purple' : 
                                         p.includes('Unitree') ? 'green' : 'gray';
                            return `<span class="tag ${color}" style="margin-right: 4px;">${p}</span>`;
                        }).join('');
                    } else {
                        const color = t.product_category.includes('MiR') || t.product_category.includes('MIR') ? 'blue' : 
                                     t.product_category.includes('UR') || t.product_category.includes('Universal') ? 'purple' : 
                                     t.product_category.includes('Unitree') ? 'green' : 'gray';
                        productTags = `<span class="tag ${color}">${t.product_category}</span>`;
                    }
                } else {
                    productTags = '<span class="tag gray">-</span>';
                }
                
                return `
                    <tr>
                        <td><strong style="color: var(--primary);">${t.ticket_number}</strong></td>
                        <td><strong>${t.title}</strong></td>
                        <td>${productTags}</td>
                        <td><span class="tag">${t.category || '-'}</span></td>
                        <td><span class="tag" style="background: var(--${priorityColor}); color: white;">${t.priority}</span></td>
                        <td><span class="tag ${statusColor}">${t.status}</span></td>
                        <td>${t.customer_name || '-'}</td>
                        <td>${t.owner_name || '<em style="color: var(--text-light);">Non assegnato</em>'}</td>
                        <td>${createdDate}</td>
                        <td style="display: flex; gap: 4px; flex-wrap: wrap;">
                            <button class="button secondary" onclick="viewTicket(${t.id})" style="padding: 4px 8px; font-size: 12px;">Dettagli</button>
                            ${isOperatore && !t.is_my_ownership ? `<button class="button secondary" onclick="takeTicketOwnership(${t.id})" style="padding: 4px 8px; font-size: 12px;">ðŸ‘¤ Prendi</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        async function loadTickets() {
            try {
                const res = await fetch('/api/tickets');
                const data = await res.json();
                
                allTickets = data.tickets || [];
                isOperatore = data.is_operatore || false;
                
                // Mostra/nascondi tab "Assegnati a Me" per operatori
                const myTab = document.getElementById('ticket-tab-my');
                if (myTab) {
                    myTab.style.display = isOperatore ? 'block' : 'none';
                }
                
                renderTickets();
            } catch (err) {
                console.error('Errore caricamento ticket:', err);
            }
        }
        
        function showTicketForm() {
            document.getElementById('ticket-form-card').style.display = 'block';
        }
        
        function hideTicketForm() {
            document.getElementById('ticket-form-card').style.display = 'none';
            document.getElementById('ticket-form').reset();
        }
        
        document.getElementById('ticket-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const res = await fetch('/api/tickets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    alert(`âœ… Ticket ${result.ticket.ticket_number} creato con successo!`);
                    hideTicketForm();
                    loadTickets();
                } else {
                    alert('Errore: ' + (result.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        });
        
        async function viewTicket(ticketId) {
            try {
                const res = await fetch(`/api/tickets/${ticketId}`);
                const data = await res.json();
                const ticket = data.ticket;
                
                // Separa commenti pubblici e interni
                const publicComments = (ticket.comments || []).filter(c => !c.is_internal);
                const internalComments = (ticket.comments || []).filter(c => c.is_internal);
                
                // HTML per commenti pubblici
                let publicCommentsHtml = '';
                if (publicComments.length > 0) {
                    publicCommentsHtml = publicComments.map(c => `
                        <div style="padding: 16px; border-bottom: 1px solid #e0f2fe; background: linear-gradient(to right, #e0f2fe 0%, #f0f9ff 100%); border-left: 4px solid #0284c7; margin-bottom: 12px; border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <strong style="color: #0284c7; font-size: 15px;">${c.user_name}</strong>
                                    <span style="padding: 4px 12px; background: #0284c7; color: white; border-radius: 20px; font-size: 11px; font-weight: 600;">ðŸ‘¤ PUBBLICO</span>
                                </div>
                                <small style="color: #64748b; font-size: 12px;">${c.created_at ? new Date(c.created_at).toLocaleString('it-IT') : ''}</small>
                            </div>
                            <div style="color: #1e293b; line-height: 1.6; white-space: pre-wrap;">${c.message.replace(/\n/g, '<br>')}</div>
                        </div>
                    `).join('');
                } else {
                    publicCommentsHtml = '<div style="padding: 40px; text-align: center; color: #94a3b8; background: #f8fafc; border-radius: 8px;">ðŸ’¬ Nessun commento pubblico</div>';
                }
                
                // HTML per commenti interni (solo operatori)
                let internalCommentsHtml = '';
                if (data.is_operatore) {
                    if (internalComments.length > 0) {
                        internalCommentsHtml = internalComments.map(c => `
                            <div style="padding: 16px; border-bottom: 1px solid #fed7aa; background: linear-gradient(to right, #fed7aa 0%, #fff7ed 100%); border-left: 4px solid #ea580c; margin-bottom: 12px; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <strong style="color: #ea580c; font-size: 15px;">${c.user_name}</strong>
                                        <span style="padding: 4px 12px; background: #ea580c; color: white; border-radius: 20px; font-size: 11px; font-weight: 600;">ðŸ”’ INTERNO</span>
                                    </div>
                                    <small style="color: #64748b; font-size: 12px;">${c.created_at ? new Date(c.created_at).toLocaleString('it-IT') : ''}</small>
                                </div>
                                <div style="color: #1e293b; line-height: 1.6; white-space: pre-wrap;">${c.message.replace(/\n/g, '<br>')}</div>
                            </div>
                        `).join('');
                    } else {
                        internalCommentsHtml = '<div style="padding: 40px; text-align: center; color: #94a3b8; background: #fff7ed; border-radius: 8px;">ðŸ”’ Nessun commento interno</div>';
                    }
                }
                
                const modal = `
                    <div id="ticket-modal" class="modal" style="display: block;">
                        <div class="modal-content" style="max-width: 800px;">
                            <div class="modal-header">
                                <h3>Ticket ${ticket.ticket_number}</h3>
                                <button class="close-modal" onclick="closeTicketModal()">&times;</button>
                            </div>
                            <div style="padding: 24px;">
                                <div style="margin-bottom: 24px;">
                                    <h4 style="margin-bottom: 8px;">${ticket.title}</h4>
                                    <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                                        ${ticket.product_category ? `<span class="tag" style="background: var(--primary); color: white;">${ticket.product_category}</span>` : ''}
                                        <span class="tag">${ticket.category || '-'}</span>
                                        <span class="tag">${ticket.priority}</span>
                                        <span class="tag">${ticket.status}</span>
                                    </div>
                                    <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                                        <strong>Descrizione:</strong>
                                        <div style="margin-top: 8px; white-space: pre-wrap;">${ticket.description}</div>
                                    </div>
                                    <div style="background: #f8fafc; padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 1px solid var(--border-color);">
                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                            <div>
                                                <strong style="color: var(--text-light); font-size: 12px; text-transform: uppercase;">Cliente</strong>
                                                <div style="font-size: 16px; font-weight: 600; margin-top: 4px; color: var(--primary);">${ticket.customer_name || 'Unknown'}</div>
                                                ${ticket.customer_email ? `<div style="font-size: 12px; color: var(--text-light); margin-top: 2px;">${ticket.customer_email}</div>` : ''}
                                            </div>
                                            <div>
                                                <strong style="color: var(--text-light); font-size: 12px; text-transform: uppercase;">Assegnato a</strong>
                                                <div style="font-size: 16px; margin-top: 4px;">${ticket.owner_name ? `<span style="color: var(--primary); font-weight: 600;">${ticket.owner_name}</span>` : '<em style="color: var(--text-light);">Non assegnato</em>'}</div>
                                            </div>
                                            <div>
                                                <strong style="color: var(--text-light); font-size: 12px; text-transform: uppercase;">Creato</strong>
                                                <div style="font-size: 14px; margin-top: 4px;">${ticket.created_at ? new Date(ticket.created_at).toLocaleString('it-IT') : '-'}</div>
                                            </div>
                                            <div>
                                                <strong style="color: var(--text-light); font-size: 12px; text-transform: uppercase;">Ultimo Aggiornamento</strong>
                                                <div style="font-size: 14px; margin-top: 4px;">${ticket.updated_at ? new Date(ticket.updated_at).toLocaleString('it-IT') : '-'}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="border-top: 1px solid var(--border-color); padding-top: 24px; margin-top: 24px;">
                                    <h4 style="margin-bottom: 16px;">Allegati</h4>
                                    <div id="attachments-list-${ticketId}" style="margin-bottom: 16px;">
                                        <div style="text-align: center; padding: 20px; color: var(--text-light);">Caricamento...</div>
                                    </div>
                                    <form id="ticket-attachment-form-${ticketId}" onsubmit="uploadAttachment(event, ${ticketId})" enctype="multipart/form-data" style="margin-bottom: 16px;">
                                        <input type="file" name="file" id="file-input-${ticketId}" accept="image/*,video/*,application/pdf" required style="margin-bottom: 8px;">
                                        <button type="submit" class="button">ðŸ“Ž Carica File</button>
                                        <small style="display: block; margin-top: 4px; color: var(--text-light);">Immagini (JPG, PNG), Video (MP4) o PDF - Max 500MB. I file verranno compressi automaticamente.</small>
                                    </form>
                                </div>
                                
                                <div style="border-top: 1px solid var(--border-color); padding-top: 24px; margin-top: 24px;">
                                    <h4 style="margin-bottom: 16px;">Commenti</h4>
                                    ${data.is_operatore ? `
                                    <!-- Tab per operatori -->
                                    <div style="margin-bottom: 16px;">
                                        <div style="display: flex; gap: 8px; border-bottom: 2px solid var(--border-color);">
                                            <button id="tab-public-${ticketId}" onclick="switchCommentTab(${ticketId}, 'public')" style="padding: 12px 24px; background: #0284c7; color: white; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s;">
                                                ðŸ‘¤ Pubblici (${publicComments.length})
                                            </button>
                                            <button id="tab-internal-${ticketId}" onclick="switchCommentTab(${ticketId}, 'internal')" style="padding: 12px 24px; background: #cbd5e1; color: #64748b; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.3s;">
                                                ðŸ”’ Interni (${internalComments.length})
                                            </button>
                                        </div>
                                        <div id="comments-public-${ticketId}" style="max-height: 350px; overflow-y: auto; padding: 16px; background: #f0f9ff; border: 2px solid #0284c7; border-top: none; border-radius: 0 0 8px 8px; margin-bottom: 16px;">
                                            ${publicCommentsHtml}
                                        </div>
                                        <div id="comments-internal-${ticketId}" style="display: none; max-height: 350px; overflow-y: auto; padding: 16px; background: #fff7ed; border: 2px solid #ea580c; border-top: none; border-radius: 0 0 8px 8px; margin-bottom: 16px;">
                                            ${internalCommentsHtml}
                                        </div>
                                    </div>
                                    ` : `
                                    <!-- Vista clienti (solo pubblici) -->
                                    <div style="max-height: 350px; overflow-y: auto; padding: 16px; background: #f0f9ff; border: 2px solid #0284c7; border-radius: 8px; margin-bottom: 16px;">
                                        ${publicCommentsHtml}
                                    </div>
                                    `}
                                    <form id="ticket-comment-form-${ticketId}" onsubmit="addTicketComment(event, ${ticketId})">
                                        <textarea name="message" required rows="3" placeholder="Aggiungi un commento..." style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px;"></textarea>
                                        ${data.is_operatore ? `
                                        <div style="margin-bottom: 12px;">
                                            <label id="comment-label-${ticketId}" style="display: flex; align-items: center; gap: 8px; padding: 10px; background: #e0f2fe; border-radius: 6px; border: 2px solid #0284c7; cursor: pointer; transition: all 0.3s;">
                                                <input type="checkbox" name="is_internal" id="comment-internal-${ticketId}" onchange="updateCommentLabel(${ticketId})">
                                                <span id="comment-label-text-${ticketId}" style="font-size: 14px; color: #0284c7; font-weight: 600;">
                                                    ðŸ‘¤ <strong>Commento Pubblico</strong> - Visibile al cliente
                                                </span>
                                            </label>
                                        </div>
                                        ` : ''}
                                        <button type="submit" class="button">Invia Commento</button>
                                    </form>
                                </div>
                                
                                ${data.is_operatore ? `
                                <div style="border-top: 1px solid var(--border-color); padding-top: 24px; margin-top: 24px;">
                                    <h4 style="margin-bottom: 16px;">Azioni Operatore</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                        <div>
                                            <label style="display: block; margin-bottom: 6px; font-size: 12px; color: var(--text-light); font-weight: 600;">Assegna a:</label>
                                            <select id="ticket-owner-select-${ticketId}" style="width: 100%; padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px;">
                                                <option value="">Caricamento operatori...</option>
                                            </select>
                                        </div>
                                        <div style="display: flex; align-items: flex-end;">
                                            <button class="button" onclick="assignTicketOwner(${ticketId})" style="width: 100%;">Assegna Ticket</button>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                        <select id="ticket-status-select" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px;">
                                            <option value="Aperto" ${ticket.status === 'Aperto' ? 'selected' : ''}>Aperto</option>
                                            <option value="In Lavorazione" ${ticket.status === 'In Lavorazione' ? 'selected' : ''}>In Lavorazione</option>
                                            <option value="In Attesa Cliente" ${ticket.status === 'In Attesa Cliente' ? 'selected' : ''}>In Attesa Cliente</option>
                                            <option value="Chiuso" ${ticket.status === 'Chiuso' ? 'selected' : ''}>Chiuso</option>
                                        </select>
                                        <select id="ticket-priority-select" style="padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px;">
                                            <option value="Bassa" ${ticket.priority === 'Bassa' ? 'selected' : ''}>Bassa</option>
                                            <option value="Media" ${ticket.priority === 'Media' ? 'selected' : ''}>Media</option>
                                            <option value="Alta" ${ticket.priority === 'Alta' ? 'selected' : ''}>Alta</option>
                                            <option value="Urgente" ${ticket.priority === 'Urgente' ? 'selected' : ''}>Urgente</option>
                                        </select>
                                        <button class="button" onclick="updateTicketStatus(${ticketId})">Aggiorna Stato</button>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modal);
                
                // Carica operatori per il selettore
                if (data.is_operatore) {
                    loadOperatoriForTicket(ticketId);
                }
                
                // Carica allegati
                loadAttachments(ticketId);
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        async function loadAttachments(ticketId) {
            try {
                const res = await fetch(`/api/tickets/${ticketId}/attachments`);
                const data = await res.json();
                const container = document.getElementById(`attachments-list-${ticketId}`);
                
                if (!container) return;
                
                if (!data.attachments || data.attachments.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-light);">Nessun allegato</div>';
                    return;
                }
                
                container.innerHTML = data.attachments.map(att => {
                    const sizeMB = (att.file_size / (1024 * 1024)).toFixed(2);
                    const icon = att.file_type === 'image' ? 'ðŸ–¼ï¸' : att.file_type === 'video' ? 'ðŸŽ¥' : 'ðŸ“„';
                    const previewBtn = att.file_type === 'pdf' ? 
                        `<button onclick="previewPDF(${ticketId}, ${att.id})" class="button secondary" style="padding: 4px 8px; font-size: 12px;">ðŸ‘ï¸ Anteprima</button>` : '';
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 8px; transition: all 0.3s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                            <div>
                                <div style="font-weight: 500;">${icon} ${att.filename || att.original_filename || 'file'}</div>
                                <div style="font-size: 12px; color: var(--text-light);">
                                    ${sizeMB} MB ${att.is_compressed ? '(compresso)' : ''} - ${att.created_at ? new Date(att.created_at).toLocaleDateString('it-IT') : ''}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                ${previewBtn}
                                <a href="/api/tickets/${ticketId}/attachments/${att.id}/download" class="button secondary" style="padding: 4px 8px; font-size: 12px; text-decoration: none;">â¬‡ï¸ Scarica</a>
                                <button onclick="deleteAttachment(${ticketId}, ${att.id})" class="button secondary" style="padding: 4px 8px; font-size: 12px; background: var(--danger); color: white; border: none;">ðŸ—‘ï¸ Elimina</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('Errore caricamento allegati:', err);
                const container = document.getElementById(`attachments-list-${ticketId}`);
                if (container) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--danger);">Errore caricamento allegati</div>';
                }
            }
        }
        
        function previewPDF(ticketId, attachmentId) {
            const url = `/api/tickets/${ticketId}/attachments/${attachmentId}/download`;
            const modal = `
                <div id="pdf-preview-modal" class="modal" style="display: block; z-index: 10000;">
                    <div class="modal-content" style="max-width: 90vw; max-height: 90vh; padding: 0;">
                        <div class="modal-header">
                            <h3>Anteprima PDF</h3>
                            <button class="close-modal" onclick="document.getElementById('pdf-preview-modal').remove()">&times;</button>
                        </div>
                        <div style="padding: 20px; height: calc(90vh - 60px); overflow: auto;">
                            <iframe src="${url}" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
        }
        
        async function uploadAttachment(e, ticketId) {
            e.preventDefault();
            const form = e.target;
            const fileInput = document.getElementById(`file-input-${ticketId}`);
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Seleziona un file');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Caricamento...';
            
            try {
                const res = await fetch(`/api/tickets/${ticketId}/attachments`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await res.json();
                if (data.success) {
                    alert('âœ… File caricato con successo!');
                    form.reset();
                    loadAttachments(ticketId);
                } else {
                    alert('Errore: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
        
        async function deleteAttachment(ticketId, attachmentId) {
            if (!confirm('Vuoi eliminare questo file?')) return;
            
            try {
                const res = await fetch(`/api/tickets/${ticketId}/attachments`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ attachment_id: attachmentId })
                });
                
                const data = await res.json();
                if (data.success) {
                    alert('âœ… File eliminato');
                    loadAttachments(ticketId);
                } else {
                    alert('Errore: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        async function loadOperatoriForTicket(ticketId) {
            try {
                // Carica anche i dati del ticket per vedere il proprietario corrente
                const ticketRes = await fetch(`/api/tickets/${ticketId}`);
                const ticketData = await ticketRes.json();
                const currentOwnerId = ticketData.ticket?.owner_id;
                
                const res = await fetch('/api/users/operatori');
                const data = await res.json();
                const select = document.getElementById(`ticket-owner-select-${ticketId}`);
                
                if (!select) return;
                
                select.innerHTML = '<option value="">Seleziona operatore...</option>';
                data.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.name;
                    // Seleziona il proprietario corrente
                    if (currentOwnerId && user.id === currentOwnerId) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Errore caricamento operatori:', err);
            }
        }
        
        async function assignTicketOwner(ticketId) {
            const select = document.getElementById(`ticket-owner-select-${ticketId}`);
            const ownerId = select.value;
            
            if (!ownerId) {
                alert('Seleziona un operatore');
                return;
            }
            
            try {
                const res = await fetch(`/api/tickets/${ticketId}/assign-ownership`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ owner_id: parseInt(ownerId) })
                });
                
                const result = await res.json();
                if (result.success) {
                    alert('âœ… Ticket assegnato con successo!');
                    // Ricarica il ticket per vedere le modifiche
                    loadTickets();
                    loadNotifications(); // Ricarica notifiche
                    // Riapri il modal con i dati aggiornati
                    setTimeout(() => {
                        viewTicket(ticketId);
                    }, 300);
                } else {
                    alert('Errore: ' + (result.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        function closeTicketModal() {
            const modal = document.getElementById('ticket-modal');
            if (modal) modal.remove();
        }
        
        function switchCommentTab(ticketId, tab) {
            const publicTab = document.getElementById(`tab-public-${ticketId}`);
            const internalTab = document.getElementById(`tab-internal-${ticketId}`);
            const publicContent = document.getElementById(`comments-public-${ticketId}`);
            const internalContent = document.getElementById(`comments-internal-${ticketId}`);
            const checkbox = document.getElementById(`comment-internal-${ticketId}`);
            const label = document.getElementById(`comment-label-${ticketId}`);
            const labelText = document.getElementById(`comment-label-text-${ticketId}`);
            
            if (!publicTab || !internalTab || !publicContent || !internalContent) return;
            
            if (tab === 'public') {
                // Tab pubblico attivo
                publicTab.style.background = '#0284c7';
                publicTab.style.color = 'white';
                internalTab.style.background = '#cbd5e1';
                internalTab.style.color = '#64748b';
                publicContent.style.display = 'block';
                internalContent.style.display = 'none';
                
                // Checkbox deselezionato (commento pubblico)
                if (checkbox) {
                    checkbox.checked = false;
                    if (label) {
                        label.style.background = '#e0f2fe';
                        label.style.borderColor = '#0284c7';
                    }
                    if (labelText) {
                        labelText.innerHTML = 'ðŸ‘¤ <strong>Commento Pubblico</strong> - Visibile al cliente';
                        labelText.style.color = '#0284c7';
                    }
                }
            } else {
                // Tab interno attivo
                publicTab.style.background = '#cbd5e1';
                publicTab.style.color = '#64748b';
                internalTab.style.background = '#ea580c';
                internalTab.style.color = 'white';
                publicContent.style.display = 'none';
                internalContent.style.display = 'block';
                
                // Checkbox selezionato (commento interno)
                if (checkbox) {
                    checkbox.checked = true;
                    if (label) {
                        label.style.background = '#fff7ed';
                        label.style.borderColor = '#ea580c';
                    }
                    if (labelText) {
                        labelText.innerHTML = 'ðŸ”’ <strong>Commento Interno</strong> - Visibile solo agli operatori';
                        labelText.style.color = '#ea580c';
                    }
                }
            }
        }
        
        function updateCommentLabel(ticketId) {
            const checkbox = document.getElementById(`comment-internal-${ticketId}`);
            const label = document.getElementById(`comment-label-${ticketId}`);
            const labelText = document.getElementById(`comment-label-text-${ticketId}`);
            
            if (!checkbox || !label || !labelText) return;
            
            if (checkbox.checked) {
                // Commento interno
                label.style.background = '#fff7ed';
                label.style.borderColor = '#ea580c';
                labelText.innerHTML = 'ðŸ”’ <strong>Commento Interno</strong> - Visibile solo agli operatori';
                labelText.style.color = '#ea580c';
            } else {
                // Commento pubblico
                label.style.background = '#e0f2fe';
                label.style.borderColor = '#0284c7';
                labelText.innerHTML = 'ðŸ‘¤ <strong>Commento Pubblico</strong> - Visibile al cliente';
                labelText.style.color = '#0284c7';
            }
        }
        
        async function addTicketComment(e, ticketId) {
            e.preventDefault();
            const form = document.getElementById(`ticket-comment-form-${ticketId}`);
            if (!form) {
                alert('Form non trovato');
                return;
            }
            const formData = new FormData(form);
            const checkbox = document.getElementById(`comment-internal-${ticketId}`);
            const data = {
                message: formData.get('message'),
                is_internal: checkbox ? checkbox.checked : false
            };
            
            try {
                const res = await fetch(`/api/tickets/${ticketId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    closeTicketModal();
                    viewTicket(ticketId);
                    loadTickets();
                } else {
                    alert('Errore: ' + (result.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        async function updateTicketStatus(ticketId) {
            const status = document.getElementById('ticket-status-select').value;
            const priority = document.getElementById('ticket-priority-select').value;
            
            try {
                const res = await fetch(`/api/tickets/${ticketId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status, priority })
                });
                const result = await res.json();
                if (result.success) {
                    closeTicketModal();
                    viewTicket(ticketId);
                    loadTickets();
                } else {
                    alert('Errore: ' + (result.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        async function takeTicketOwnership(ticketId) {
            if (!confirm('Vuoi prendere la proprietÃ  di questo ticket?')) return;
            
            try {
                const res = await fetch(`/api/tickets/${ticketId}/take-ownership`, {
                    method: 'POST'
                });
                const data = await res.json();
                if (data.success) {
                    alert('âœ… ProprietÃ  del ticket presa con successo!');
                    loadTickets();
                } else {
                    alert('Errore: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        // Carica Campagne
        async function loadEmailCampaigns() {
            try {
                const res = await fetch('/api/email/campaigns');
                const data = await res.json();
                const tbody = document.getElementById('campaigns-table');
                
                if (!data.campaigns || data.campaigns.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">Nessuna campagna. Crea la tua prima campagna!</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.campaigns.map(c => {
                    const statusTag = c.status === 'sent' ? 'green' : c.status === 'scheduled' ? 'blue' : 'amber';
                    const sentCount = c.sends?.length || 0;
                    const recipientCount = c.list_subscriber_count || 0;
                    return `
                        <tr>
                            <td><strong>${c.name || 'Senza nome'}</strong></td>
                            <td>${c.subject || '-'}</td>
                            <td>${c.list_name || '-'}</td>
                            <td>${recipientCount}</td>
                            <td>${sentCount}</td>
                            <td><span class="tag ${statusTag}">${c.status || 'draft'}</span></td>
                            <td>${c.created_at ? new Date(c.created_at).toLocaleDateString('it-IT') : '-'}</td>
                            <td>
                                ${c.status !== 'sent' ? `<button class="button secondary" onclick="sendCampaign(${c.id})" style="padding: 4px 8px; font-size: 12px;">ðŸ“§ Invia</button>` : ''}
                                <button class="button secondary" onclick="viewCampaign(${c.id})" style="padding: 4px 8px; font-size: 12px;">ðŸ‘ï¸ Vedi</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                console.error('Errore caricamento campagne:', err);
                document.getElementById('campaigns-table').innerHTML = `<tr><td colspan="8" style="text-align: center; padding: 40px; color: red;">Errore: ${err.message}</td></tr>`;
            }
        }
        
        // Carica Liste
        async function loadEmailLists() {
            try {
                const res = await fetch('/api/email/lists');
                const data = await res.json();
                const tbody = document.getElementById('email-lists-table');
                
                if (!data.lists || data.lists.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px;">Nessuna lista. Crea la tua prima lista!</td></tr>';
                    return;
                }
                
                emailMarketingData.lists = data.lists;
                tbody.innerHTML = data.lists.map(l => `
                    <tr>
                        <td><strong>${l.name}</strong></td>
                        <td>${l.description || '-'}</td>
                        <td>${l.subscriber_count || 0}</td>
                        <td>
                            <button class="button secondary" onclick="manageListContacts(${l.id})" style="padding: 4px 8px; font-size: 12px;">ðŸ‘¥ Gestisci</button>
                            <button class="button secondary" onclick="deleteEmailList(${l.id})" style="padding: 4px 8px; font-size: 12px;">ðŸ—‘ï¸ Elimina</button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error('Errore caricamento liste:', err);
            }
        }
        
        // Carica Template
        async function loadEmailTemplates() {
            try {
                const res = await fetch('/api/email/templates');
                const data = await res.json();
                const tbody = document.getElementById('email-templates-table');
                
                if (!data.templates || data.templates.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px;">Nessun template. Crea il tuo primo template!</td></tr>';
                    return;
                }
                
                emailMarketingData.templates = data.templates;
                tbody.innerHTML = data.templates.map(t => `
                    <tr>
                        <td><strong>${t.name}</strong></td>
                        <td><span class="tag">${t.template_type || 'other'}</span></td>
                        <td>${t.subject || '-'}</td>
                        <td>
                            <button class="button secondary" onclick="editEmailTemplate(${t.id})" style="padding: 4px 8px; font-size: 12px;">âœï¸ Modifica</button>
                            <button class="button secondary" onclick="deleteEmailTemplate(${t.id})" style="padding: 4px 8px; font-size: 12px;">ðŸ—‘ï¸ Elimina</button>
                        </td>
                    </tr>
                `).join('');
                
                // Popola dropdown template nel composer
                const templateSelect = document.getElementById('compose-template-id');
                if (templateSelect) {
                    templateSelect.innerHTML = '<option value="">Nessun template</option>' + 
                        data.templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
                }
            } catch (err) {
                console.error('Errore caricamento template:', err);
            }
        }
        
        // Carica form composer
        async function loadComposeForm() {
            // Carica liste se non giÃ  caricate
            if (!emailMarketingData.lists.length) {
                await loadEmailLists();
            }
            
            // Popola checkbox liste
            const listsContainer = document.getElementById('compose-lists-container');
            if (listsContainer && emailMarketingData.lists.length > 0) {
                listsContainer.innerHTML = emailMarketingData.lists.map(l => `
                    <label style="display: flex; align-items: center; padding: 8px; margin-bottom: 4px; cursor: pointer; border-radius: 4px; transition: background 0.2s;" 
                           onmouseover="this.style.background='var(--bg-hover)'" 
                           onmouseout="this.style.background='transparent'">
                        <input type="checkbox" 
                               name="list_ids" 
                               value="${l.id}" 
                               class="compose-list-checkbox" 
                               onchange="updateRecipientCount()"
                               style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <strong>${l.name}</strong>
                            <div style="font-size: 12px; color: var(--text-light); margin-top: 2px;">
                                ${l.description || 'Nessuna descrizione'}
                            </div>
                        </div>
                        <div style="margin-left: 12px; font-weight: 600; color: var(--primary);">
                            ${l.subscriber_count || 0} contatti
                        </div>
                    </label>
                `).join('');
            } else if (listsContainer) {
                listsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-light);">Nessuna lista disponibile. Crea una lista nella sezione "Liste Contatti".</div>';
            }
            
            // Popola dropdown template se non giÃ  fatto
            if (!emailMarketingData.templates.length) {
                await loadEmailTemplates();
            }
        }
        
        // Gestione Liste
        function showNewEmailListForm() {
            document.getElementById('new-email-list-form').style.display = 'block';
        }
        
        function hideNewEmailListForm() {
            document.getElementById('new-email-list-form').style.display = 'none';
            document.getElementById('email-list-form').reset();
        }
        
        document.getElementById('email-list-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const res = await fetch('/api/email/lists', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    alert('âœ… Lista creata con successo!');
                    hideNewEmailListForm();
                    await loadEmailLists();
                    await loadComposeForm();
                } else {
                    alert('âŒ Errore: ' + (result.error || 'Unknown'));
                }
            } catch (err) {
                alert('âŒ Errore: ' + err.message);
            }
        });
        
        // Gestione Template
        function showNewEmailTemplateForm() {
            document.getElementById('new-email-template-form').style.display = 'block';
        }
        
        function hideNewEmailTemplateForm() {
            document.getElementById('new-email-template-form').style.display = 'none';
            document.getElementById('email-template-form').reset();
        }
        
        document.getElementById('email-template-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const res = await fetch('/api/email/templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    alert('âœ… Template creato con successo!');
                    hideNewEmailTemplateForm();
                    await loadEmailTemplates();
                } else {
                    alert('âŒ Errore: ' + (result.error || 'Unknown'));
                }
            } catch (err) {
                alert('âŒ Errore: ' + err.message);
            }
        });
        
        // Funzioni selezione liste
        function selectAllLists() {
            document.querySelectorAll('.compose-list-checkbox').forEach(cb => cb.checked = true);
            updateRecipientCount();
        }
        
        function deselectAllLists() {
            document.querySelectorAll('.compose-list-checkbox').forEach(cb => cb.checked = false);
            updateRecipientCount();
        }
        
        // Composer functions
        function insertVariable(variable) {
            const textarea = document.getElementById('compose-html-content');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            textarea.value = textarea.value.substring(0, start) + variable + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start + variable.length, start + variable.length);
        }
        
        async function loadTemplateIntoComposer() {
            const templateId = document.getElementById('compose-template-id').value;
            if (!templateId) return;
            
            try {
                const res = await fetch(`/api/email/templates/${templateId}`);
                const data = await res.json();
                if (data.template) {
                    document.getElementById('compose-subject').value = data.template.subject || '';
                    document.getElementById('compose-html-content').value = data.template.html_content || '';
                }
            } catch (err) {
                console.error('Errore caricamento template:', err);
            }
        }
        
        async function updateRecipientCount() {
            const checkboxes = document.querySelectorAll('.compose-list-checkbox:checked');
            const countEl = document.getElementById('recipient-count');
            
            if (checkboxes.length === 0) {
                countEl.textContent = '';
                return;
            }
            
            const selectedListIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            const selectedLists = selectedListIds.map(id => {
                const list = emailMarketingData.lists.find(l => l.id === id);
                return list ? list.name : '';
            }).filter(n => n);
            
            // Se una sola lista, usa il conteggio giÃ  disponibile
            if (selectedListIds.length === 1) {
                const list = emailMarketingData.lists.find(l => l.id === selectedListIds[0]);
                const count = list ? (list.subscriber_count || 0) : 0;
                countEl.textContent = `ðŸ“Š ${count} destinatari nella lista "${selectedLists[0]}"`;
                return;
            }
            
            // Per piÃ¹ liste, calcola destinatari unici tramite API
            try {
                const res = await fetch('/api/email/lists/unique-recipients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ list_ids: selectedListIds })
                });
                const data = await res.json();
                
                if (data.success) {
                    const uniqueCount = data.unique_count || 0;
                    const totalWithDuplicates = data.total_with_duplicates || 0;
                    const duplicates = totalWithDuplicates - uniqueCount;
                    
                    countEl.innerHTML = `ðŸ“Š <strong>${uniqueCount} destinatari unici</strong> in ${selectedListIds.length} liste selezionate`;
                    if (duplicates > 0) {
                        countEl.innerHTML += `<br><small style="font-size: 11px; color: var(--warning);">âš ï¸ ${duplicates} duplicati rimossi (${totalWithDuplicates} totali con duplicati)</small>`;
                    }
                    countEl.innerHTML += `<br><small style="font-size: 11px; color: var(--text-light);">Liste: ${selectedLists.join(', ')}</small>`;
                } else {
                    // Fallback: somma semplice (con avviso)
                    let totalCount = 0;
                    selectedListIds.forEach(id => {
                        const list = emailMarketingData.lists.find(l => l.id === id);
                        if (list) totalCount += (list.subscriber_count || 0);
                    });
                    countEl.innerHTML = `ðŸ“Š ~${totalCount} destinatari (somma, potrebbero esserci duplicati)`;
                    countEl.innerHTML += `<br><small style="font-size: 11px; color: var(--warning);">âš ï¸ Il conteggio potrebbe includere duplicati</small>`;
                }
            } catch (err) {
                // Fallback: somma semplice
                let totalCount = 0;
                selectedListIds.forEach(id => {
                    const list = emailMarketingData.lists.find(l => l.id === id);
                    if (list) totalCount += (list.subscriber_count || 0);
                });
                countEl.innerHTML = `ðŸ“Š ~${totalCount} destinatari (somma, potrebbero esserci duplicati)`;
                countEl.innerHTML += `<br><small style="font-size: 11px; color: var(--warning);">âš ï¸ Il conteggio potrebbe includere duplicati</small>`;
            }
        }
        
        // Crea campagna
        document.getElementById('compose-email-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Raccogli tutte le liste selezionate
            const selectedCheckboxes = document.querySelectorAll('.compose-list-checkbox:checked');
            const listIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.value));
            
            if (listIds.length === 0) {
                alert('âŒ Seleziona almeno una lista di destinatari!');
                return;
            }
            
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('campaign_name'),
                list_ids: listIds,  // Array di ID liste
                list_id: listIds[0],  // Mantieni per retrocompatibilitÃ 
                template_id: formData.get('template_id') ? parseInt(formData.get('template_id')) : null,
                subject: formData.get('subject'),
                html_content: formData.get('html_content')
            };
            
            try {
                const res = await fetch('/api/email/campaigns', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    alert(`âœ… Campagna creata con successo! VerrÃ  inviata a ${listIds.length} lista/e.`);
                    e.target.reset();
                    // Reset checkbox
                    document.querySelectorAll('.compose-list-checkbox').forEach(cb => cb.checked = false);
                    updateRecipientCount();
                    switchEmailTab('campaigns');
                } else {
                    alert('âŒ Errore: ' + (result.error || 'Unknown'));
                }
            } catch (err) {
                alert('âŒ Errore: ' + err.message);
            }
        });
        
        // Invia campagna
        async function sendCampaign(campaignId) {
            if (!confirm('Vuoi inviare questa campagna a tutti i destinatari della lista?')) return;
            
            try {
                const res = await fetch(`/api/email/campaigns/${campaignId}/send`, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert('âœ… Campagna inviata con successo!');
                    loadEmailCampaigns();
                } else {
                    alert('âŒ Errore: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('âŒ Errore: ' + err.message);
            }
        }
        
        // Test email
        async function sendTestEmail() {
            const email = prompt('Inserisci email di test:');
            if (!email) return;
            
            const htmlContent = document.getElementById('compose-html-content').value;
            const subject = document.getElementById('compose-subject').value;
            
            try {
                const res = await fetch('/api/email/test-send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to_email: email, subject: subject, html_body: htmlContent })
                });
                const data = await res.json();
                if (data.success) {
                    alert('âœ… Email di test inviata con successo!');
                } else {
                    alert('âŒ Errore: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('âŒ Errore: ' + err.message);
            }
        }
        
        // Preview
        function previewComposedEmail() {
            const htmlContent = document.getElementById('compose-html-content').value;
            const previewWindow = window.open('', 'preview', 'width=800,height=600');
            previewWindow.document.write(htmlContent);
        }
        
        // Salva bozza
        function saveCampaignAsDraft() {
            alert('ðŸ’¾ FunzionalitÃ  bozza in arrivo. Usa "Crea Campagna" per salvare.');
        }
        
        // Inizializza template predefiniti
        async function initEmailTemplates() {
            if (!confirm('Vuoi caricare i template email predefiniti? Questa operazione creerÃ  3 template base.')) return;
            
            try {
                const res = await fetch('/api/email/templates/init-defaults', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert('âœ… Template predefiniti caricati con successo!');
                    await loadEmailTemplates();
                } else {
                    alert('âŒ Errore: ' + (data.error || 'Unknown'));
                }
            } catch (err) {
                alert('âŒ Errore: ' + err.message);
            }
        }
        
        // Funzioni helper (placeholder)
        function manageListContacts(listId) {
            alert('ðŸ‘¥ Gestione contatti lista: FunzionalitÃ  in arrivo!');
        }
        
        async function deleteEmailList(listId) {
            if (!confirm('Vuoi eliminare questa lista?')) return;
            try {
                const res = await fetch(`/api/email/lists/${listId}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    alert('âœ… Lista eliminata!');
                    loadEmailLists();
                }
            } catch (err) {
                alert('âŒ Errore: ' + err.message);
            }
        }
        
        function editEmailTemplate(templateId) {
            alert('âœï¸ Modifica template: FunzionalitÃ  in arrivo!');
        }
        
        async function deleteEmailTemplate(templateId) {
            if (!confirm('Vuoi eliminare questo template?')) return;
            try {
                const res = await fetch(`/api/email/templates/${templateId}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    alert('âœ… Template eliminato!');
                    loadEmailTemplates();
                }
            } catch (err) {
                alert('âŒ Errore: ' + err.message);
            }
        }
        
        function viewCampaign(campaignId) {
            alert('ðŸ‘ï¸ Visualizza campagna: FunzionalitÃ  in arrivo!');
        }
        
        // ========== FINE EMAIL MARKETING FUNCTIONS ==========

        // Sistema Notifiche
        async function loadNotifications() {
            try {
                const res = await fetch('/api/notifications?unread_only=true');
                const data = await res.json();
                const badge = document.getElementById('notification-badge');
                const unreadCount = data.notifications ? data.notifications.filter(n => !n.is_read).length : 0;
                
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
                
                // Carica tutte le notifiche per il dropdown
                const allRes = await fetch('/api/notifications');
                const allData = await allRes.json();
                renderNotifications(allData.notifications || []);
            } catch (err) {
                console.error('Errore caricamento notifiche:', err);
            }
        }
        
        function renderNotifications(notifications) {
            const list = document.getElementById('notifications-list');
            if (!list) return;
            
            if (!notifications || notifications.length === 0) {
                list.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-light);">Nessuna notifica</div>';
                return;
            }
            
            list.innerHTML = notifications.map(n => {
                const timeAgo = getTimeAgo(n.created_at);
                const unreadClass = n.is_read ? '' : 'unread';
                const ticketId = n.related_ticket_id ? n.related_ticket_id : 'null';
                const notifId = n.id || 0;
                const notifTitle = (n.title || '').replace(/`/g, '\\`').replace(/\${/g, '\\${').replace(/"/g, '&quot;');
                const notifMessage = (n.message || '').replace(/`/g, '\\`').replace(/\${/g, '\\${').replace(/"/g, '&quot;');
                return `
                    <div class="notification-item ${unreadClass}" onclick="handleNotificationClick(${notifId}, ${ticketId})">
                        <div class="notification-item-title">${notifTitle}</div>
                        <div class="notification-item-message">${notifMessage}</div>
                        <div class="notification-item-time">${timeAgo}</div>
                    </div>
                `;
            }).join('');
        }
        
        function getTimeAgo(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Adesso';
            if (diffMins < 60) return `${diffMins} min fa`;
            if (diffHours < 24) return `${diffHours} ore fa`;
            if (diffDays < 7) return `${diffDays} giorni fa`;
            return date.toLocaleDateString('it-IT');
        }
        
        function toggleNotifications() {
            const dropdown = document.getElementById('notifications-dropdown');
            if (!dropdown) return;
            dropdown.classList.toggle('show');
            
            if (dropdown.classList.contains('show')) {
                loadNotifications();
            }
        }
        
        async function handleNotificationClick(notificationId, ticketId) {
            // Marca come letta
            try {
                await fetch(`/api/notifications/${notificationId}/read`, { method: 'POST' });
            } catch (err) {
                console.error('Errore marcatura notifica:', err);
            }
            
            // Se Ã¨ relativa a un ticket, apri il ticket
            if (ticketId && ticketId !== 'null') {
                closeTicketModal();
                viewTicket(ticketId);
            }
            
            loadNotifications();
        }
        
        async function markAllNotificationsRead() {
            try {
                await fetch('/api/notifications/read-all', { method: 'POST' });
                loadNotifications();
            } catch (err) {
                alert('Errore: ' + err.message);
            }
        }
        
        // Chiudi dropdown quando si clicca fuori
        document.addEventListener('click', (e) => {
            const container = document.querySelector('.notifications-container');
            if (container && !container.contains(e.target)) {
                const dropdown = document.getElementById('notifications-dropdown');
                if (dropdown) dropdown.classList.remove('show');
            }
        });
        
        function handleLogout() {
            // Cancella credenziali salvate
            localStorage.removeItem('crm_username');
            localStorage.removeItem('crm_password');
            localStorage.removeItem('crm_remember');
            // Il redirect avverrÃ  automaticamente tramite href
        }
        
        // Funzione per aprire mappa (OpenStreetMap)
        function openGoogleMaps(address) {
            if (!address || address.trim() === '') {
                alert('Nessun indirizzo disponibile');
                return;
            }
            const encodedAddress = encodeURIComponent(address);
            // Usa OpenStreetMap Nominatim per trovare le coordinate
            window.open(`https://www.openstreetmap.org/search?query=${encodedAddress}`, '_blank');
        }
        
        // Mappa con Leaflet + OpenStreetMap (Open Source - Nessuna API Key richiesta)
        let map = null;
        let markers = [];
        
        // Cache persistente per le coordinate geocodificate (salvata in localStorage)
        let geocodeCache = new Map();
        
        // Carica cache da localStorage all'avvio
        function loadGeocodeCache() {
            try {
                const cached = localStorage.getItem('geocodeCache');
                if (cached) {
                    const cacheData = JSON.parse(cached);
                    geocodeCache = new Map(cacheData);
                    console.log(`Cache caricata: ${geocodeCache.size} indirizzi in memoria`);
                }
            } catch (e) {
                console.warn('Errore caricamento cache:', e);
                geocodeCache = new Map();
            }
        }
        
        // Salva cache in localStorage
        function saveGeocodeCache() {
            try {
                const cacheArray = Array.from(geocodeCache.entries());
                localStorage.setItem('geocodeCache', JSON.stringify(cacheArray));
                console.log(`Cache salvata: ${geocodeCache.size} indirizzi`);
            } catch (e) {
                console.warn('Errore salvataggio cache:', e);
            }
        }
        
        // Carica cache all'avvio
        loadGeocodeCache();
        
        async function loadMapData() {
            try {
                // Mostra spinner di caricamento
                const loadingDiv = document.getElementById('map-loading');
                const statusDiv = document.getElementById('map-loading-status');
                if (loadingDiv) loadingDiv.style.display = 'flex';
                if (statusDiv) statusDiv.textContent = 'Caricamento dati mappa...';
                
                // Carica SOLO gli account e leads con indirizzo valido con una singola chiamata API ottimizzata
                const res = await fetch('/api/map-data');
                const data = await res.json();
                
                const allAccounts = data.accounts || [];
                const allLeads = data.leads || [];
                
                console.log(`Caricati ${allAccounts.length} account e ${allLeads.length} leads con indirizzo valido`);
                
                // Inizializza mappa se non esiste
                if (!map) {
                    if (statusDiv) statusDiv.textContent = 'Inizializzazione mappa...';
                    initMap();
                    return; // initMap chiamerÃ  loadMapData dopo l'inizializzazione
                }
                
                // Rimuovi marker esistenti
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
                
                if (statusDiv) statusDiv.textContent = 'Preparazione dati...';
                let geocodedCount = 0;
                let skippedCount = 0;
                
                // Prepara tutti gli indirizzi da geocodificare (batch processing)
                const addressesToGeocode = [];
                
                // Carica opportunitÃ  per determinare categoria account (solo quelle necessarie)
                let accountOpportunities = {};
                // Non carichiamo tutte le opportunitÃ , le determineremo solo quando necessario
                // Questo velocizza molto il caricamento iniziale
                
                // Prepara tutti gli account da processare (i dati arrivano giÃ  filtrati e con categoria)
                for (const account of allAccounts) {
                    const address = account.address || findBestAddress(account.billing_address, account.shipping_address);
                    if (address && address.trim().length > 3) {
                        addressesToGeocode.push({
                            address,
                            name: account.name,
                            type: 'account',
                            id: account.id,
                            hasTasks: account.has_pending_tasks || false,
                            tasksCount: account.pending_tasks_count || 0,
                            category: account.category || null,
                            opportunitiesCount: account.opportunities_count || 0
                        });
                    } else {
                        skippedCount++;
                    }
                }
                
                // Prepara tutti i leads da processare (i dati arrivano giÃ  filtrati e con categoria)
                for (const lead of allLeads) {
                    const address = lead.address;
                    if (address && address.trim().length > 3) {
                        addressesToGeocode.push({
                            address,
                            name: lead.name,
                            type: 'lead',
                            id: lead.id,
                            hasTasks: false,
                            tasksCount: 0,
                            category: lead.category || null,
                            opportunitiesCount: 0
                        });
                    } else {
                        skippedCount++;
                    }
                }
                
                // Processa tutti gli indirizzi in parallelo (batch di 20 alla volta per velocitÃ )
                if (statusDiv) statusDiv.textContent = `Geocodifica ${addressesToGeocode.length} indirizzi...`;
                
                // Se ci sono molti indirizzi, mostra solo quelli dalla cache prima (piÃ¹ veloce)
                const cachedAddresses = [];
                const uncachedAddresses = [];
                
                addressesToGeocode.forEach(item => {
                    let cleanAddress = item.address.trim();
                    if (!cleanAddress.toLowerCase().includes('italia') && 
                        !cleanAddress.toLowerCase().includes('italy') &&
                        !cleanAddress.toLowerCase().includes('it')) {
                        cleanAddress = cleanAddress + ', Italia';
                    }
                    const cacheKey = cleanAddress.toLowerCase();
                    if (geocodeCache.has(cacheKey)) {
                        cachedAddresses.push({...item, cacheKey});
                    } else {
                        uncachedAddresses.push({...item, cacheKey: null});
                    }
                });
                
                // Prima aggiungi tutti i marker dalla cache (istantaneo - batch)
                if (statusDiv && cachedAddresses.length > 0) {
                    statusDiv.textContent = `Caricamento ${cachedAddresses.length} marker dalla cache...`;
                }
                
                // Aggiungi tutti i marker dalla cache in batch molto grandi (velocissimo, senza delay)
                const cacheBatchSize = 100; // Processa molti marker alla volta dalla cache
                for (let i = 0; i < cachedAddresses.length; i += cacheBatchSize) {
                    const batch = cachedAddresses.slice(i, i + cacheBatchSize);
                    // Usa requestAnimationFrame per non bloccare il browser
                    await new Promise(resolve => requestAnimationFrame(resolve));
                    batch.forEach(item => {
                        const cached = geocodeCache.get(item.cacheKey);
                        if (cached) {
                            addMarkerToMap(cached.lat, cached.lon, item.name, item.type, item.id, item.hasTasks, item.tasksCount, item.category, item.opportunitiesCount, item.address);
                            geocodedCount++;
                        }
                    });
                }
                
                if (statusDiv && cachedAddresses.length > 0) {
                    statusDiv.textContent = `${cachedAddresses.length} marker caricati dalla cache, geocodifica ${uncachedAddresses.length} nuovi...`;
                }
                
                // Poi geocodifica solo quelli non in cache (sequenziale per evitare rate limiting)
                if (statusDiv && uncachedAddresses.length > 0) {
                    statusDiv.textContent = `Geocodifica ${uncachedAddresses.length} nuovi indirizzi...`;
                }
                
                for (let i = 0; i < uncachedAddresses.length; i++) {
                    const item = uncachedAddresses[i];
                    await geocodeAddress(
                        item.address,
                        item.name,
                        item.type,
                        item.id,
                        item.hasTasks,
                        item.tasksCount,
                        item.category,
                        item.opportunitiesCount
                    );
                    geocodedCount++;
                    
                    if (statusDiv) {
                        statusDiv.textContent = `Geocodifica... ${i + 1}/${uncachedAddresses.length} nuovi`;
                    }
                    
                    // Delay di 1.1 secondi tra ogni richiesta (il proxy aggiunge 1 secondo)
                    if (i < uncachedAddresses.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1100));
                    }
                }
                
                console.log(`âœ… Geocodificati: ${geocodedCount} totali (${cachedAddresses.length} da cache, ${uncachedAddresses.length} nuovi), Saltati: ${skippedCount}`);
                if (statusDiv) {
                    statusDiv.textContent = `âœ… Completato: ${geocodedCount} marker caricati (${cachedAddresses.length} da cache, ${uncachedAddresses.length} nuovi)`;
                }
                
                // Nascondi spinner
                if (loadingDiv) loadingDiv.style.display = 'none';
                
                // Mostra messaggio se ci sono molti saltati
                if (skippedCount > 0) {
                    console.warn(`${skippedCount} record saltati perchÃ© senza indirizzo valido`);
                }
                
            } catch (err) {
                console.error('Errore caricamento dati mappa:', err);
                const loadingDiv = document.getElementById('map-loading');
                const statusDiv = document.getElementById('map-loading-status');
                if (statusDiv) statusDiv.textContent = 'Errore: ' + err.message;
                if (loadingDiv) {
                    loadingDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
                            <h3 style="color: var(--text-dark); margin: 0 0 12px 0;">Errore caricamento mappa</h3>
                            <p style="color: var(--text-medium); margin: 0 0 24px 0;">${err.message}</p>
                            <button class="button" onclick="loadMapData()">ðŸ”„ Riprova</button>
                        </div>
                    `;
                }
            }
        }
        
        function findBestAddress(billing, shipping) {
            // Preferisci billing_address, poi shipping_address
            if (billing && billing.trim().length > 5) return billing.trim();
            if (shipping && shipping.trim().length > 5) return shipping.trim();
            return null;
        }
        
        function initMap() {
            const mapContainer = document.getElementById('map-container');
            if (!mapContainer) {
                console.error('map-container non trovato');
                return;
            }
            
            // Verifica che Leaflet sia caricato
            if (typeof L === 'undefined') {
                console.error('Leaflet non caricato');
                const loadingDiv = document.getElementById('map-loading');
                if (loadingDiv) {
                    loadingDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
                            <h3 style="color: var(--text-dark); margin: 0 0 12px 0;">Leaflet non caricato</h3>
                            <p style="color: var(--text-medium); margin: 0 0 24px 0;">La libreria Leaflet non Ã¨ disponibile. Ricarica la pagina.</p>
                            <button class="button" onclick="location.reload()">ðŸ”„ Ricarica Pagina</button>
                        </div>
                    `;
                }
                return;
            }
            
            // Se la mappa esiste giÃ , distruggila prima di crearne una nuova
            if (map) {
                try {
                    map.remove();
                    map = null;
                } catch (e) {
                    console.warn('Errore rimozione mappa esistente:', e);
                }
            }
            
            // Verifica se il container ha giÃ  una mappa inizializzata (controlla la classe leaflet-container)
            if (mapContainer.classList.contains('leaflet-container') || mapContainer.querySelector('.leaflet-container')) {
                // Pulisci il container
                mapContainer.innerHTML = '';
            }
            
            try {
                // Crea mappa Leaflet centrata sull'Italia
                map = L.map(mapContainer, {
                    center: [41.9028, 12.4964], // Roma, Italia
                    zoom: 6,
                    zoomControl: true,
                    attributionControl: true
                });
                
                // Aggiungi tile layer OpenStreetMap
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19
                }).addTo(map);
                
                console.log('Mappa inizializzata correttamente');
                
                // Carica i dati dopo un breve delay per assicurarsi che la mappa sia renderizzata
                setTimeout(() => {
                    loadMapData();
                }, 300);
            } catch (error) {
                console.error('Errore creazione mappa:', error);
                const loadingDiv = document.getElementById('map-loading');
                if (loadingDiv) {
                    loadingDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
                            <h3 style="color: var(--text-dark); margin: 0 0 12px 0;">Errore inizializzazione mappa</h3>
                            <p style="color: var(--text-medium); margin: 0 0 24px 0;">${error.message}</p>
                            <button class="button" onclick="initMap()">ðŸ”„ Riprova</button>
                        </div>
                    `;
                }
            }
        }
        
        function createMap() {
            // Alias per compatibilitÃ 
            initMap();
        }
        
        async function geocodeAddress(address, name, type, id, hasTasks = false, tasksCount = 0, category = null, opportunitiesCount = 0) {
            if (!map || typeof L === 'undefined') return;
            
            try {
                // Pulisci e normalizza l'indirizzo
                let cleanAddress = address.trim();
                
                // Se l'indirizzo non contiene giÃ  "Italia", aggiungilo
                if (!cleanAddress.toLowerCase().includes('italia') && 
                    !cleanAddress.toLowerCase().includes('italy') &&
                    !cleanAddress.toLowerCase().includes('it')) {
                    cleanAddress = cleanAddress + ', Italia';
                }
                
                // Controlla se abbiamo giÃ  le coordinate in cache
                const cacheKey = cleanAddress.toLowerCase();
                if (geocodeCache.has(cacheKey)) {
                    const cached = geocodeCache.get(cacheKey);
                    // Usa le coordinate dalla cache (ISTANTANEO)
                    addMarkerToMap(cached.lat, cached.lon, name, type, id, hasTasks, tasksCount, category, opportunitiesCount, address);
                    return;
                }
                
                // Accetta anche indirizzi generici (cittÃ )
                
                // Usa proxy backend per geocoding (evita CORS e gestisce meglio rate limiting)
                const encodedAddress = encodeURIComponent(cleanAddress);
                
                let data = null;
                let retries = 2;
                
                while (retries > 0) {
                    try {
                        const response = await fetch(`/api/geocode?q=${encodedAddress}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (!response.ok) {
                            if (response.status === 429 || response.status === 503) {
                                // Rate limited, aspetta di piÃ¹
                                await new Promise(resolve => setTimeout(resolve, 2000));
                                retries--;
                                continue;
                            }
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        data = await response.json();
                        break; // Successo, esci dal loop
                    } catch (error) {
                        retries--;
                        if (retries > 0) {
                            // Aspetta prima di riprovare
                            await new Promise(resolve => setTimeout(resolve, 2000));
                        } else {
                            console.warn(`Errore geocoding per ${address} dopo tentativi:`, error);
                            return; // Salta questo indirizzo
                        }
                    }
                }
                
                if (data && data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lon = parseFloat(result.lon);
                    
                    // Verifica che le coordinate siano valide (entro i confini dell'Italia approssimativamente)
                    if (lat < 35 || lat > 48 || lon < 5 || lon > 20) {
                        console.warn(`Coordinate fuori dall'Italia per ${name}: ${lat}, ${lon}`);
                        return;
                    }
                    
                    // Salva in cache e persisti in localStorage
                    geocodeCache.set(cacheKey, { lat, lon });
                    saveGeocodeCache(); // Salva immediatamente
                    
                    // Aggiungi marker alla mappa
                    addMarkerToMap(lat, lon, name, type, id, hasTasks, tasksCount, category, opportunitiesCount, address);
                } else {
                    console.warn(`Nessun risultato geocoding per: ${address}`);
                }
            } catch (error) {
                console.error(`Errore geocoding per ${address}:`, error);
            }
        }
        
        // Funzione separata per aggiungere marker alla mappa (piÃ¹ veloce)
        function addMarkerToMap(lat, lon, name, type, id, hasTasks, tasksCount, category, opportunitiesCount, address) {
            if (!map || typeof L === 'undefined') return;
            
            // Determina colore in base alla categoria
            let baseColor = '#64748b'; // Default grigio
            if (category === 'MiR') {
                baseColor = '#3b82f6'; // Blu
            } else if (category === 'UR') {
                baseColor = '#8b5cf6'; // Viola
            } else if (category === 'Unitree') {
                baseColor = '#10b981'; // Verde
            } else if (type === 'account') {
                baseColor = '#3b82f6'; // Blu per account senza categoria
            } else if (type === 'lead') {
                baseColor = '#10b981'; // Verde per lead
            }
            
            // Se ha attivitÃ , usa un colore piÃ¹ scuro e aggiungi alone pulsante
            const markerColor = hasTasks ? darkenColor(baseColor, 20) : baseColor;
            const pulseClass = hasTasks ? 'pulse-marker' : '';
            
            // Marker piÃ¹ grande e visibile - CERCHI PERFETTI (non ovali!)
            const markerSize = hasTasks ? 24 : 20;
            const borderSize = hasTasks ? 4 : 3;
            const iconSize = hasTasks ? markerSize + 8 : markerSize;
            
            // Crea marker personalizzato con CERCHI colorati perfetti
            const icon = L.divIcon({
                className: `custom-marker ${pulseClass}`,
                html: `
                    <div style="position: relative; width: ${iconSize}px; height: ${iconSize}px; display: flex; align-items: center; justify-content: center; margin: 0; padding: 0;">
                        ${hasTasks ? `<div class="pulse-ring" style="position: absolute; width: ${iconSize}px; height: ${iconSize}px; border-radius: 50%; background: ${markerColor}; opacity: 0.6; animation: pulse-ring 2s infinite; top: 0; left: 0;"></div>` : ''}
                        <div style="width: ${markerSize}px; height: ${markerSize}px; min-width: ${markerSize}px; min-height: ${markerSize}px; max-width: ${markerSize}px; max-height: ${markerSize}px; background: ${markerColor}; border: ${borderSize}px solid white; border-radius: 50%; box-shadow: 0 3px 6px rgba(0,0,0,0.4), 0 0 0 2px ${markerColor}40; position: relative; z-index: 1; flex-shrink: 0; margin: auto;"></div>
                    </div>
                `,
                iconSize: [iconSize, iconSize],
                iconAnchor: [iconSize / 2, iconSize / 2],
                popupAnchor: [0, -iconSize / 2]
            });
            
            // Popup con informazioni attivitÃ  e categoria
            const categoryInfo = category ? `<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0;"><strong>Categoria:</strong> ${category}</div>` : '';
            const oppsInfo = opportunitiesCount > 0 ? `<div style="margin-top: 4px;"><strong>OpportunitÃ :</strong> ${opportunitiesCount}</div>` : '';
            const tasksInfo = hasTasks ? `
                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0;">
                    <p style="margin: 0; font-size: 11px; color: #f59e0b; font-weight: 600;">
                        âš ï¸ ${tasksCount} attivitÃ  da fare
                    </p>
                </div>
            ` : '';
            
            // Crea il contenuto del popup usando DOM invece di HTML string per evitare problemi di escape
            const popupDiv = document.createElement('div');
            popupDiv.style.padding = '12px';
            popupDiv.style.minWidth = '250px';
            popupDiv.style.background = 'white';
            popupDiv.style.borderRadius = '8px';
            
            // Titolo
            const title = document.createElement('h4');
            title.textContent = name;
            title.style.margin = '0 0 8px 0';
            title.style.fontSize = '14px';
            title.style.fontWeight = '600';
            title.style.color = '#1e293b';
            popupDiv.appendChild(title);
            
            // Indirizzo
            const addr = document.createElement('p');
            addr.textContent = address;
            addr.style.margin = '0 0 8px 0';
            addr.style.fontSize = '12px';
            addr.style.color = '#666';
            addr.style.lineHeight = '1.4';
            popupDiv.appendChild(addr);
            
            // Tipo (Account/Lead)
            const typeP = document.createElement('p');
            typeP.style.margin = '4px 0 8px 0';
            typeP.style.fontSize = '11px';
            typeP.style.color = '#999';
            const typeSpan = document.createElement('span');
            typeSpan.style.display = 'inline-block';
            typeSpan.style.width = '12px';
            typeSpan.style.height = '12px';
            typeSpan.style.background = baseColor;
            typeSpan.style.borderRadius = '50%';
            typeSpan.style.marginRight = '4px';
            typeSpan.style.border = '2px solid white';
            typeSpan.style.boxShadow = '0 1px 3px rgba(0,0,0,0.3)';
            typeP.appendChild(typeSpan);
            typeP.appendChild(document.createTextNode(type === 'account' ? 'Account' : 'Lead'));
            popupDiv.appendChild(typeP);
            
            // Categoria, OpportunitÃ , Task (se presenti)
            if (categoryInfo) {
                const catDiv = document.createElement('div');
                catDiv.innerHTML = categoryInfo;
                popupDiv.appendChild(catDiv);
            }
            if (oppsInfo) {
                const oppsDiv = document.createElement('div');
                oppsDiv.innerHTML = oppsInfo;
                popupDiv.appendChild(oppsDiv);
            }
            if (tasksInfo) {
                const tasksDiv = document.createElement('div');
                tasksDiv.innerHTML = tasksInfo;
                popupDiv.appendChild(tasksDiv);
            }
            
            // Container bottoni
            const buttonsDiv = document.createElement('div');
            buttonsDiv.style.marginTop = '12px';
            buttonsDiv.style.display = 'flex';
            buttonsDiv.style.gap = '6px';
            buttonsDiv.style.flexWrap = 'wrap';
            
            // Bottone "Vedi Dettagli" - usa una funzione wrapper per evitare loop
            const viewDetailsBtn = document.createElement('button');
            viewDetailsBtn.textContent = 'ðŸ“‹ Vedi Dettagli';
            viewDetailsBtn.className = 'map-view-details-btn';
            viewDetailsBtn.style.padding = '6px 12px';
            viewDetailsBtn.style.background = 'var(--primary)';
            viewDetailsBtn.style.color = 'white';
            viewDetailsBtn.style.border = 'none';
            viewDetailsBtn.style.borderRadius = '4px';
            viewDetailsBtn.style.fontSize = '12px';
            viewDetailsBtn.style.cursor = 'pointer';
            viewDetailsBtn.style.fontWeight = '500';
            viewDetailsBtn.style.flex = '1';
            viewDetailsBtn.style.minWidth = '100px';
            
            // Usa una funzione wrapper con flag per evitare loop
            let isHandling = false;
            viewDetailsBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (isHandling) return; // Previeni loop
                isHandling = true;
                marker.closePopup();
                setTimeout(() => {
                    if (type === 'account') {
                        viewAccountDetails(id);
                    } else {
                        viewLeadDetails(id);
                    }
                    setTimeout(() => { isHandling = false; }, 1000);
                }, 100);
            });
            buttonsDiv.appendChild(viewDetailsBtn);
            
            // Bottone "Indicazioni"
            const directionsBtn = document.createElement('button');
            directionsBtn.textContent = 'ðŸ—ºï¸ Indicazioni';
            directionsBtn.className = 'map-directions-btn';
            directionsBtn.style.padding = '6px 12px';
            directionsBtn.style.background = '#10b981';
            directionsBtn.style.color = 'white';
            directionsBtn.style.border = 'none';
            directionsBtn.style.borderRadius = '4px';
            directionsBtn.style.fontSize = '12px';
            directionsBtn.style.cursor = 'pointer';
            directionsBtn.style.fontWeight = '500';
            directionsBtn.style.flex = '1';
            directionsBtn.style.minWidth = '100px';
            directionsBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(address)}`, '_blank');
            });
            buttonsDiv.appendChild(directionsBtn);
            
            popupDiv.appendChild(buttonsDiv);
            
            const marker = L.marker([lat, lon], { icon: icon })
                .addTo(map)
                .bindPopup(popupDiv);
            
            markers.push(marker);
        }
        
        async function cleanAccountNames() {
            if (!confirm('Vuoi pulire i nomi degli account? Questa operazione rimuoverÃ  caratteri strani come ~$.')) {
                return;
            }
            
            try {
                const res = await fetch('/api/accounts/clean-names', { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    alert(`âœ… ${data.message}`);
                    loadAccounts(currentAccountsPage);
                    if (map) loadMapData();
                } else {
                    alert('âŒ Errore: ' + (data.error || 'Operazione fallita'));
                }
            } catch (err) {
                alert('âŒ Errore: ' + err.message);
            }
        }
        
        async function associateAddresses() {
            if (!confirm('Vuoi associare indirizzi ai contatti? Questa operazione cercherÃ  indirizzi nei siti web e nelle offerte.')) {
                return;
            }
            
            try {
                const res = await fetch('/api/setup/associate-addresses', { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    alert(`âœ… ${data.message}`);
                    loadAccounts(currentAccountsPage);
                    if (map) loadMapData();
                } else {
                    alert('âŒ Errore: ' + (data.error || 'Operazione fallita'));
                }
            } catch (err) {
                alert('âŒ Errore: ' + err.message);
            }
        }
        
        // Carica mappa quando si apre la vista
        document.addEventListener('DOMContentLoaded', () => {
            // Intercetta cambio vista
            const viewButtons = document.querySelectorAll('.nav-item[data-target]');
            viewButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const target = btn.getAttribute('data-target');
                    if (target === 'map-view' && !map) {
                        setTimeout(() => initMap(), 100);
                    }
                });
            });
        });
        
        // Carica notifiche e dashboard all'avvio e ogni 30 secondi
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
        loadDashboard();
                loadNotifications();
                setInterval(loadNotifications, 30000);
            });
        } else {
            loadDashboard();
            loadNotifications();
            setInterval(loadNotifications, 30000);
        }
        
        // Riepilogo Mattutino AttivitÃ 
        async function loadMorningTaskSummary() {
            try {
                const res = await fetch('/api/tasks/morning-summary');
                
                // Verifica che la risposta sia JSON
                const contentType = res.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await res.text();
                    console.error('Errore: risposta non JSON:', text.substring(0, 200));
                    alert('Errore: il server ha restituito una risposta non valida. Controlla la console per i dettagli.');
                    return;
                }
                
                const data = await res.json();
                
                if (!data.success) {
                    alert('Errore: ' + (data.error || 'Unknown'));
                    console.error('Errore riepilogo mattutino:', data);
                    return;
                }
                
                const card = document.getElementById('morning-summary-card');
                const content = document.getElementById('morning-summary-content');
                
                if (data.total_pending === 0) {
                    content.innerHTML = `
                        <div style="padding: 24px; text-align: center; color: var(--text-medium);">
                            <div style="font-size: 48px; margin-bottom: 16px;">âœ…</div>
                            <h4 style="margin: 0 0 8px 0; color: var(--text-dark);">Nessuna attivitÃ  in scadenza!</h4>
                            <p style="margin: 0;">Tutte le attivitÃ  sono completate o non hanno scadenze imminenti.</p>
                        </div>
                    `;
                } else {
                    const tasksHtml = data.tasks.map(task => {
                        const dueDate = task.due_date ? new Date(task.due_date).toLocaleDateString('it-IT') : 'Non specificata';
                        const isOverdue = task.due_date && new Date(task.due_date) < new Date();
                        const taskTypeMap = {
                            'call': 'ðŸ“ž Chiamare',
                            'send_offer': 'ðŸ“§ Inviare Offerta',
                            'recall': 'ðŸ”„ Richiamare',
                            'meeting': 'ðŸ¤ Riunione',
                            'other': 'ðŸ“‹ Altro'
                        };
                        const taskTypeLabel = taskTypeMap[task.task_type] || task.task_type;
                        
                        return `
                            <div style="padding: 16px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 12px; background: ${isOverdue ? '#fee2e2' : '#fff'}">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div>
                                        <h4 style="margin: 0 0 4px 0; font-size: 14px; font-weight: 600;">${taskTypeLabel}</h4>
                                        <p style="margin: 0; font-size: 12px; color: var(--text-medium);">${task.description || 'Nessuna descrizione'}</p>
                                    </div>
                                    ${isOverdue ? '<span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">SCADUTA</span>' : ''}
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                                    <div>
                                        <p style="margin: 0; font-size: 11px; color: var(--text-light); text-transform: uppercase;">ðŸ’¼ OpportunitÃ </p>
                                        <p style="margin: 4px 0 0 0; font-size: 13px; font-weight: 600;">${task.opportunity_name}</p>
                                        <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--text-medium);">â‚¬${Number(task.amount || 0).toLocaleString('it-IT', {minimumFractionDigits: 2})}</p>
                                    </div>
                                    <div>
                                        <p style="margin: 0; font-size: 11px; color: var(--text-light); text-transform: uppercase;">ðŸ‘¤ Assegnata a</p>
                                        <p style="margin: 4px 0 0 0; font-size: 13px; font-weight: 600;">${task.assigned_to_name}</p>
                                        <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--text-medium);">ðŸ“… ${dueDate}</p>
                                    </div>
                                </div>
                                <div style="margin-top: 12px;">
                                    <button onclick="window.location.href='#opportunities-view'; viewOpportunityDetails(${task.opportunity_id || 0});" 
                                            style="padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                        Vedi OpportunitÃ 
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    content.innerHTML = `
                        <div style="margin-bottom: 16px;">
                            <p style="margin: 0; font-size: 14px; color: var(--text-medium);">
                                ðŸ“Š Trovate <strong style="color: var(--text-dark);">${data.total_pending}</strong> attivitÃ  da completare
                            </p>
                        </div>
                        ${tasksHtml}
                    `;
                }
                
                card.style.display = 'block';
                card.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
            } catch (err) {
                alert('Errore caricamento riepilogo: ' + err.message);
            }
        }
        
        // Funzioni Importazione CSV
        function handleLeadsFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('leads-file-name').textContent = `File selezionato: ${file.name}`;
                document.getElementById('import-leads-btn').style.display = 'inline-block';
            }
        }
        
        function handleOpportunitiesFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('opportunities-file-name').textContent = `File selezionato: ${file.name}`;
                document.getElementById('import-opportunities-btn').style.display = 'inline-block';
            }
        }
        
        async function importLeadsCSV() {
            const fileInput = document.getElementById('leads-csv-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Seleziona un file CSV');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            const resultDiv = document.getElementById('leads-import-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="padding: 12px; background: #e7f3ff; border-radius: 6px;">â³ Importazione in corso...</div>';
            
            try {
                const res = await fetch('/api/import/leads/csv', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await res.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div style="padding: 12px; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; color: #065f46;">
                            âœ… Importazione completata!<br>
                            ðŸ“¥ Importati: ${data.imported}<br>
                            ðŸ”„ Aggiornati: ${data.updated}<br>
                            âš ï¸ Saltati: ${data.skipped}
                            ${data.errors && data.errors.length > 0 ? '<br><br>âš ï¸ Errori:<br>' + data.errors.slice(0, 5).join('<br>') : ''}
                        </div>
                    `;
                    // Ricarica lista Lead
                    setTimeout(() => loadLeads(), 1000);
                } else {
                    resultDiv.innerHTML = `<div style="padding: 12px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #991b1b;">âŒ Errore: ${data.error}</div>`;
                }
            } catch (err) {
                resultDiv.innerHTML = `<div style="padding: 12px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #991b1b;">âŒ Errore: ${err.message}</div>`;
            }
        }
        
        async function importOpportunitiesCSV() {
            const fileInput = document.getElementById('opportunities-csv-file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Seleziona un file CSV');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            const resultDiv = document.getElementById('opportunities-import-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="padding: 12px; background: #e7f3ff; border-radius: 6px;">â³ Importazione in corso...</div>';
            
            try {
                const res = await fetch('/api/import/opportunities/csv', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await res.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div style="padding: 12px; background: #d1fae5; border: 1px solid #10b981; border-radius: 6px; color: #065f46;">
                            âœ… Importazione completata!<br>
                            ðŸ“¥ Importate: ${data.imported}<br>
                            âš ï¸ Saltate: ${data.skipped}
                            ${data.errors && data.errors.length > 0 ? '<br><br>âš ï¸ Errori:<br>' + data.errors.slice(0, 5).join('<br>') : ''}
                        </div>
                    `;
                    // Ricarica lista OpportunitÃ 
                    setTimeout(() => loadOpportunities(1), 1000);
                } else {
                    resultDiv.innerHTML = `<div style="padding: 12px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #991b1b;">âŒ Errore: ${data.error}</div>`;
                }
            } catch (err) {
                resultDiv.innerHTML = `<div style="padding: 12px; background: #fee2e2; border: 1px solid #ef4444; border-radius: 6px; color: #991b1b;">âŒ Errore: ${err.message}</div>`;
            }
        }
        
        // Migliora visualizzazione mappa - aggiungi cluster per molte opportunitÃ /account
        function improveMapVisualization() {
            if (!map) return;
            
            // Aggiungi controlli zoom
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);
            
            // Raggruppa marker vicini
            if (typeof L.markerClusterGroup !== 'undefined') {
                const markers = L.markerClusterGroup({
                    maxClusterRadius: 50,
                    spiderfyOnMaxZoom: true,
                    showCoverageOnHover: false,
                    zoomToBoundsOnClick: true
                });
                
                // Aggiungi tutti i marker al cluster
                map.eachLayer((layer) => {
                    if (layer instanceof L.Marker) {
                        markers.addLayer(layer);
                    }
                });
                
                map.addLayer(markers);
            }
        }
        
        // Funzioni per menu mobile
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const menuIcon = document.getElementById('menu-icon');
            
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('show');
            
            if (sidebar.classList.contains('mobile-open')) {
                menuIcon.textContent = 'âœ•';
            } else {
                menuIcon.textContent = 'â˜°';
            }
        }
        
        function closeMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const menuIcon = document.getElementById('menu-icon');
            
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('show');
            menuIcon.textContent = 'â˜°';
        }
        
        // Chiudi menu quando si clicca su un nav-item su mobile
        document.addEventListener('DOMContentLoaded', () => {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth <= 768) {
                        closeMobileMenu();
                    }
                });
            });
        });
    
        let assistantBusy = false;
        
        function appendAssistantMessage(role, text, container) {
            const targetContainer = container || document.getElementById('assistant-chat-messages') || document.getElementById('assistant-messages');
            if (!targetContainer) return;
            
            const message = document.createElement('div');
            message.className = `assistant-message ${role}`;
            message.textContent = text;
            targetContainer.appendChild(message);
            targetContainer.scrollTop = targetContainer.scrollHeight;
        }

        async function sendAssistantMessage() {
            const input = document.getElementById('assistant-chat-input') || document.getElementById('assistant-input');
            const messagesContainer = document.getElementById('assistant-chat-messages') || document.getElementById('assistant-messages');
            const actionsDiv = document.getElementById('assistant-actions');
            
            if (!input || assistantBusy) return;
            const message = input.value.trim();
            if (!message) return;
            assistantBusy = true;
            
            // Aggiungi messaggio utente
            appendAssistantMessage('user', message, messagesContainer);
            input.value = '';
            
            // Apri chat se chiusa
            if (!assistantChatOpen) {
                openAssistantChat();
            }

            try {
                const res = await fetch('/api/assistant', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}` }));
                    appendAssistantMessage('bot', 'âŒ Errore: ' + (errorData.error || 'Errore durante la richiesta.'), messagesContainer);
                    return;
                }
                
                const data = await res.json();
                const reply = data.reply || 'Operazione completata.';
                
                // Formatta reply con markdown base (bold, liste)
                const formattedReply = reply.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                appendAssistantMessage('bot', formattedReply, messagesContainer);
                
                // Se ci sono azioni che richiedono approvazione, mostra pulsanti
                if (data.requires_approval && data.pending_approvals && data.pending_approvals.length > 0) {
                    let approvalHtml = '<div style="margin-top: 12px; padding: 16px; background: #fef3c7; border-radius: 8px; border-left: 4px solid #f59e0b;"><strong style="font-size: 13px; color: #92400e;">âš ï¸ AZIONI IN ATTESA DI APPROVAZIONE:</strong><div style="margin-top: 12px; display: flex; gap: 8px;">';
                    
                    data.pending_approvals.forEach((approval, index) => {
                        approvalHtml += `<button onclick="approveAssistantAction(${data.log_id || 0}, ${index})" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px;">âœ… Approva ${index + 1}</button>`;
                    });
                    
                    approvalHtml += `<button onclick="cancelAssistantApproval()" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px;">âŒ Annulla</button>`;
                    approvalHtml += '</div></div>';
                    
                    if (actionsDiv) {
                        actionsDiv.innerHTML = approvalHtml;
                    }
                }
                
                // Mostra azioni eseguite
                if (data.actions && data.actions.length > 0 && actionsDiv && !data.requires_approval) {
                    let actionsHtml = '<div style="margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #3b82f6;"><strong style="font-size: 12px; color: #1e40af;">âœ… Azioni eseguite:</strong><ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 12px;">';
                    data.actions.forEach(action => {
                        if (action.type === 'update_opportunity_stage') {
                            actionsHtml += `<li>Stato opportunitÃ  ${action.opportunity_id} aggiornato a: ${action.stage}</li>`;
                        } else if (action.type === 'update_opportunity_category') {
                            actionsHtml += `<li>Categoria opportunitÃ  ${action.opportunity_id} aggiornata a: ${action.category}</li>`;
                        } else if (action.type === 'create_task') {
                            actionsHtml += `<li>AttivitÃ  creata (ID: ${action.task_id}, Tipo: ${action.task_type})</li>`;
                        } else if (action.type === 'update_opportunity_heat_level') {
                            actionsHtml += `<li>Calore opportunitÃ  ${action.opportunity_id} aggiornato a: ${action.heat_level}</li>`;
                        } else if (action.type === 'update_data') {
                            actionsHtml += `<li>Aggiornamento ${action.update_type}: ${action.entity_name || action.entity_id} - Campi: ${action.updated_fields?.join(', ') || 'N/A'}</li>`;
                        } else if (action.type === 'delete_data') {
                            actionsHtml += `<li>Eliminazione ${action.delete_type}: ${action.entity_name || action.entity_id}</li>`;
                        }
                    });
                    actionsHtml += '</ul></div>';
                    actionsDiv.innerHTML = (actionsDiv.innerHTML || '') + actionsHtml;
                }
                
                // Mostra errori se presenti
                if (data.errors && data.errors.length > 0 && actionsDiv) {
                    let errorsHtml = '<div style="margin-top: 8px; padding: 12px; background: #fef2f2; border-radius: 8px; border-left: 4px solid #ef4444;"><strong style="font-size: 12px; color: #991b1b;">âš ï¸ Errori:</strong><ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 12px;">';
                    data.errors.forEach(error => {
                        errorsHtml += `<li>${error.type}: ${error.error}</li>`;
                    });
                    errorsHtml += '</ul></div>';
                    actionsDiv.innerHTML = (actionsDiv.innerHTML || '') + errorsHtml;
                }
                
                // Ricarica dati se ci sono state modifiche
                if (data.actions && data.actions.length > 0 && !data.requires_approval) {
                    loadOpportunities(currentOpportunitiesPage);
                    loadLeads(currentLeadsPage);
                    loadAccounts(currentAccountsPage);
                    loadMyTasks();
                    loadDashboard();
                }
                
                // Salva log_id per approvazioni future
                if (data.log_id) {
                    window.lastAssistantLogId = data.log_id;
                }
            } catch (err) {
                console.error('Errore assistente:', err);
                appendAssistantMessage('bot', 'âŒ Errore: ' + err.message, messagesContainer);
            } finally {
                assistantBusy = false;
            }
        }
        
        // Funzione per approvare un'azione
        async function approveAssistantAction(logId, approvalIndex) {
            if (assistantBusy) return;
            assistantBusy = true;
            
            const messagesContainer = document.getElementById('assistant-chat-messages') || document.getElementById('assistant-messages');
            const actionsDiv = document.getElementById('assistant-actions');
            
            appendAssistantMessage('user', 'âœ… Approvo', messagesContainer);
            
            try {
                const res = await fetch('/api/assistant/approve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        log_id: logId,
                        approval_index: approvalIndex
                    })
                });
                
                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({ error: `HTTP ${res.status}` }));
                    appendAssistantMessage('bot', 'âŒ Errore approvazione: ' + (errorData.error || 'Errore sconosciuto'), messagesContainer);
                    return;
                }
                
                const data = await res.json();
                if (data.success) {
                    appendAssistantMessage('bot', 'âœ… Azione approvata ed eseguita con successo!', messagesContainer);
                    
                    // Mostra risultati
                    if (data.actions && data.actions.length > 0 && actionsDiv) {
                        let actionsHtml = '<div style="margin-top: 12px; padding: 12px; background: #d1fae5; border-radius: 8px; border-left: 4px solid #10b981;"><strong style="font-size: 12px; color: #065f46;">âœ… Azione eseguita:</strong><ul style="margin: 8px 0 0 0; padding-left: 20px; font-size: 12px;">';
                        data.actions.forEach(action => {
                            if (action.type === 'update_data') {
                                actionsHtml += `<li>Aggiornamento ${action.update_type}: ${action.entity_name || action.entity_id} - Campi: ${action.updated_fields?.join(', ') || 'N/A'}</li>`;
                            } else if (action.type === 'delete_data') {
                                actionsHtml += `<li>Eliminazione ${action.delete_type}: ${action.entity_name || action.entity_id}</li>`;
                            }
                        });
                        actionsHtml += '</ul></div>';
                        actionsDiv.innerHTML = actionsHtml;
                    }
                    
                    // Ricarica dati
                    loadOpportunities(currentOpportunitiesPage);
                    loadLeads(currentLeadsPage);
                    loadAccounts(currentAccountsPage);
                    loadMyTasks();
                    loadDashboard();
                } else {
                    appendAssistantMessage('bot', 'âŒ Errore durante l\'esecuzione dell\'azione', messagesContainer);
                }
            } catch (err) {
                console.error('Errore approvazione:', err);
                appendAssistantMessage('bot', 'âŒ Errore: ' + err.message, messagesContainer);
            } finally {
                assistantBusy = false;
            }
        }
        
        // Funzione per annullare approvazione
        function cancelAssistantApproval() {
            const messagesContainer = document.getElementById('assistant-chat-messages') || document.getElementById('assistant-messages');
            const actionsDiv = document.getElementById('assistant-actions');
            
            appendAssistantMessage('user', 'âŒ Annullo', messagesContainer);
            appendAssistantMessage('bot', 'âœ… Azione annullata. Nessuna modifica Ã¨ stata effettuata.', messagesContainer);
            
            if (actionsDiv) {
                actionsDiv.innerHTML = '<div style="padding: 12px; background: #fee2e2; border-radius: 8px; border-left: 4px solid #ef4444; color: #991b1b; font-size: 12px;">âŒ Azione annullata</div>';
            }
        }

        // Gestione chat fluttuante assistente
        let assistantChatOpen = false;
        
        function openAssistantChat() {
            const widget = document.getElementById('assistant-chat-widget');
            const toggle = document.getElementById('assistant-chat-toggle');
            if (widget) {
                widget.classList.add('open');
                if (toggle) toggle.classList.add('hidden');
                assistantChatOpen = true;
                // Scrolla in basso
                const messages = document.getElementById('assistant-chat-messages');
                if (messages) {
                    setTimeout(() => messages.scrollTop = messages.scrollHeight, 100);
                }
            }
        }
        
        function closeAssistantChat() {
            const widget = document.getElementById('assistant-chat-widget');
            const toggle = document.getElementById('assistant-chat-toggle');
            if (widget) {
                widget.classList.remove('open');
                if (toggle) toggle.classList.remove('hidden');
                assistantChatOpen = false;
            }
        }
        
        // Quando si clicca sulla tab Assistant, apri la chat
        document.addEventListener('DOMContentLoaded', () => {
            // Aggiungi listener per la tab Assistant
            const assistantTab = document.querySelector('[data-target="assistant-view"]');
            if (assistantTab) {
                assistantTab.addEventListener('click', () => {
                    setTimeout(() => {
                        if (document.getElementById('assistant-view').classList.contains('active')) {
                            openAssistantChat();
                        }
                    }, 100);
                });
            }
            
            // Listener per pulsante toggle chat
            const toggleBtn = document.getElementById('assistant-chat-toggle');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', openAssistantChat);
            }
            
            // Listener per pulsante chiudi chat
            const closeBtn = document.getElementById('assistant-chat-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeAssistantChat);
            }
            
            // Listener per invio messaggi nella chat fluttuante
            const sendBtn = document.getElementById('assistant-chat-send');
            const input = document.getElementById('assistant-chat-input');
            if (sendBtn) sendBtn.addEventListener('click', sendAssistantMessage);
            if (input) {
                input.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' && !event.shiftKey) {
                        event.preventDefault();
                        sendAssistantMessage();
                    }
                });
            }
            
            // Inizializza chat chiusa
            closeAssistantChat();
        });

        // Funzione ricerca nella mappa
        let mapSearchTimeout = null;
        async function searchOnMap(searchTerm) {
            if (!map || typeof L === 'undefined') {
                alert('La mappa non Ã¨ ancora caricata. Attendi il caricamento completo.');
                return;
            }
            
            clearTimeout(mapSearchTimeout);
            mapSearchTimeout = setTimeout(async () => {
                if (!searchTerm || searchTerm.trim().length < 2) {
                    return;
                }
                
                try {
                    // Cerca sia account che leads
                    const [accountsRes, leadsRes] = await Promise.all([
                        fetch(`/api/accounts/search-all?q=${encodeURIComponent(searchTerm)}&page=1&per_page=10`),
                        fetch(`/api/leads/search-all?q=${encodeURIComponent(searchTerm)}&page=1&per_page=10`)
                    ]);
                    
                    const accountsData = await accountsRes.json();
                    const leadsData = await leadsRes.json();
                    
                    const accounts = accountsData.accounts || [];
                    const leads = leadsData.leads || [];
                    
                    // Cerca marker esistenti che corrispondono
                    let foundMarker = null;
                    const allResults = [...accounts, ...leads];
                    
                    for (const result of allResults) {
                        // Cerca marker per ID
                        const marker = markers.find(m => {
                            const markerData = m.options.markerData;
                            if (!markerData) return false;
                            if (markerData.type === 'account' && markerData.id === result.id) return true;
                            if (markerData.type === 'lead' && markerData.id === result.id) return true;
                            return false;
                        });
                        
                        if (marker) {
                            foundMarker = marker;
                            break;
                        }
                    }
                    
                    if (foundMarker) {
                        // Centra mappa sul marker trovato
                        const latlng = foundMarker.getLatLng();
                        map.setView(latlng, Math.max(map.getZoom(), 13));
                        foundMarker.openPopup();
                    } else if (allResults.length > 0) {
                        // Se non trovato nei marker, prova a geocodificare l'indirizzo del primo risultato
                        const firstResult = allResults[0];
                        const address = firstResult.billing_address || firstResult.address || '';
                        if (address) {
                            await geocodeAddress(address, firstResult.name, firstResult.id ? 'account' : 'lead', firstResult.id, false, 0, null, 0);
                            // Attendi un po' e poi centra
                            setTimeout(() => {
                                const newMarker = markers[markers.length - 1];
                                if (newMarker) {
                                    const latlng = newMarker.getLatLng();
                                    map.setView(latlng, Math.max(map.getZoom(), 13));
                                    newMarker.openPopup();
                                }
                            }, 500);
                        } else {
                            alert(`Cliente "${firstResult.name}" trovato ma senza indirizzo valido per la mappa.`);
                        }
                    } else {
                        alert(`Nessun cliente trovato per "${searchTerm}"`);
                    }
                } catch (err) {
                    console.error('Errore ricerca mappa:', err);
                    alert('Errore durante la ricerca: ' + err.message);
                }
            }, 500);
        }

    </script>
    
    <!-- Chat Fluttuante Assistente -->
    <button id="assistant-chat-toggle" class="assistant-chat-toggle" title="Apri Assistente">ðŸ¤–</button>
    
    <div id="assistant-chat-widget" class="assistant-chat-widget">
        <div class="assistant-chat-header" onclick="openAssistantChat()">
            <h3>ðŸ¤– Assistente CRM</h3>
            <button id="assistant-chat-close" class="assistant-chat-close" onclick="event.stopPropagation(); closeAssistantChat();">Ã—</button>
        </div>
        <div class="assistant-chat-body">
            <div id="assistant-chat-messages" class="assistant-chat-messages">
                <div class="assistant-message bot">
                    Ciao! Sono il tuo assistente CRM. Puoi chiedermi di:
                    <ul style="margin: 8px 0; padding-left: 20px; font-size: 13px;">
                        <li>Cambiare lo stato di un'opportunitÃ </li>
                        <li>Creare attivitÃ  assegnate a qualcuno</li>
                        <li>Aggiornare categorie e calore</li>
                        <li>Modificare importi e date</li>
                    </ul>
                </div>
            </div>
            <div class="assistant-chat-input-container">
                <div class="assistant-chat-input-row">
                    <textarea id="assistant-chat-input" placeholder="Scrivi qui il tuo comando... (es: 'Metti Eurovo in Negoziazione')" rows="2"></textarea>
                    <button id="assistant-chat-send" class="button">Invia</button>
                </div>
                <div id="assistant-actions" style="margin-top: 8px; font-size: 12px;"></div>
            </div>
        </div>
    </div>
</body>
</html>







